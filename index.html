<html>
<head>
  <meta charset="UTF-8">
  <meta description="A Better Route/Trip Planner for electric cars, both in-car and at home.">
  <meta name="viewport" content="width=device-width, initial-scale=0.7, user-scalable=no">
  <meta name="description" content="A Better Routeplanner (ABRP) for planning trips and charging with a Electric Vehicle - both home and in-car." />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#ffffff"/>

  <link rel="icon" type="image/png" href="https://abetterrouteplanner.com/icon/abrp_icon.png" />
  <link rel="stylesheet" type="text/css" href="https://abetterrouteplanner.com/styles.css?v=3.6.5">
  <link rel="stylesheet" id="nomapstyles" type="text/css" href="https://abetterrouteplanner.com/nomapstyles.css?v=3.6.0" disabled=1>
  <link rel="stylesheet" id="nightstyles" type="text/css" href="https://abetterrouteplanner.com/nightstyles.css?v=3.6.0" disabled=1>
  <link rel="apple-touch-icon" href="https://abetterrouteplanner.com/icon/abrp_icon.png"/>
  <link rel="manifest" href="https://abetterrouteplanner.com/manifest.json"/>

  <title>A Better Routeplanner</title>
</head>
<script type="text/javascript" async src="https://abetterrouteplanner.com/js/chargers.js?v=3.6.8"></script>
<script type="text/javascript" async src="https://abetterrouteplanner.com/js/pageinated-div.js?v=3.6.2.3"></script>
<script type="text/javascript" defer src="https://abetterrouteplanner.com/js/location_autocomplete.js?v=3.6.0"></script>
<script type="text/javascript" async src="https://abetterrouteplanner.com/js/utilities.js?v=3.6.2"></script>  
<script type="text/javascript" defer src="https://abetterrouteplanner.com/js/waypoint-search.js?v=3.6.0"></script>
<script type="text/javascript" defer src="https://abetterrouteplanner.com/js/icon_stash.js?v=3.6.2"></script>
<script type="text/javascript" defer src="https://abetterrouteplanner.com/js/NoSleep.js"></script>
<script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<!--<script src='https://api.mapbox.com/mapbox.js/v3.1.1/mapbox.js' async></script>
<link href='https://api.mapbox.com/mapbox.js/v3.1.1/mapbox.css' rel='stylesheet' />-->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css"
   integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
   crossorigin="" async/>
<script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"
   integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg=="
   crossorigin="" async></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
</script>
<!-- Include the UI fix for touchscreens -->
<script type="text/javascript" src="https://abetterrouteplanner.com/js/jquery.ui.touch-punch.min.js?v=2"></script>
<script type="text/javascript">
  
  var staticurl = ""; // Disable server-side content caching for now "https://d25n4l2pmvdqh8.cloudfront.net/";
  var aboutversion = 22;
  var ui_version = 16; // This is the UI version which is compared to what is reported by db_data.py/get_ui_version (for forced reload)
  var initialize_done = false;
  var gdpr_cookies_ok = false;
  var eula_version_ok = 0;
  var eula_version = 1;
  var aboutopen = false;
  var browser_session_id = guid();
  var last_sign_of_life = null;
  var session_id = "";
  var debug = false;
  var show_console = false;
  var navmode = false;
  var navhidden = false;
  var centermode = false;
  var selrouteidx = -1;
  var routemarkers = [];
  var routelines = [];
  var bigmap = null;
  var placesService = null;
  var viainputs = []; // [ [nameinput 0, chargepower 1, chargetime 2, chargerid 3, chargertype 4, departtime 5, lat 6, lon 7 ] ]
  var plan = {};
  var planchanged = true;
  var next_charger_plans = null;
  var carmarker = null;
  var carlatlon = null;
  var carlatlon_time = 0;
  var carlocationinfo = null;
  var carheading = null;
  var chrg = null;
  var obd_instr = null;
  var mapmode = "map";
  //var autocomplete = null;
  var units = "metric";
  var cons_units = "energy_per_distance";
  var carimg = new Image();
  carimg.src='icon/car_icon.png';
  var car_soc_perc = null;
  var stale_car_soc_perc = null;
  var last_car_soc_perc = null;
  var car_charge_power = null;
  var car_charge_energy = null;
  var car_charge_start_time = null;
  var car_charge_profile_time = [];
  var car_charge_profile_power = [];
  var car_charge_profile_soc_perc = [];
  var car_range = null;
  var car_range_per_perc = null;
  var last_change_car_soc_perc = null;
  var last_change_car_range = null;
  var car_speed = null;
  var car_on_route = false;
  var car_on_wp = false;
  var car_leaving_wp = false;
  var car_step_idx = null;
  var car_point_idx = null;
  var car_latest_wp_idx = 0;
  var car_latest_point_idx = -1;
  var car_arrival_time_at_wp = null;
  var car_turn_idx = -1;
  var car_last_latlon = null;
  var car_last_zoom = 8;
  var drivedisplaymode = "";
  var drivedisplay_graph_data_exists = null;
  var lastupdatedrivegraphtime = null;
  var watchposid = null;
  var car_shift_state = null;
  var car_idle_count = 0;
  var browser_is_in_focus = true;
  var center_map = false;
  var last_center_map = null;
  var last_center_latlon = null;
  var telemetry_received = false;
  var OBD_active = false;
  var telemetry_recv_time = null;
  var mytesla_expired = false;
  var mytesla_down = false;
  var nightmode = false;
  var server_settings = {};
  var server_settings_ver = -1;
  var settings_applied = false;
  var about_shown = false;
  var url_settings = null;
  var loginemail = null;
  var planning_ongoing = false;
  var planning_canceled = false;
  var ajax_plan_handle = null;
  var historypopup = null;
  var history_wp_idx = null;
  var has_tlm = null;
  var myteslacmd_ongoing = false;
  var getcarposerrors = 0;
  var notifications = [];
  var pushbullet_token = null;
  var pushbullet_verified = false;
  var pushbullet_ongoing = false;
  var pushbullet_connected = false;
  var donation = false;
  var planinfowindow = null;
  var is_car_browser = false;
  var is_new_car_browser = false;
  var is_chrome_car_browser = false;
  var use_old_mapbox = true;
  var is_ios = (!!navigator.platform && /iPad|iPhone|iPod/.test(navigator.platform));
  var is_android = (navigator.userAgent.toLowerCase().indexOf("android") > -1);
  var is_car_active = false;
  var last_is_car_active = false;
  var last_is_car_active_time = null;
  var is_car_active_start_time = null;
  var is_car_active_count = 0;
  var car_start_latlon = null;
  var calibrate_rel_speed = null;
  var calibrate_consump = null;
  var last_sun_horiz_elev = null;
  var off_route_samples = 0;
  var tip_infowindow = null;
  var route_mouse_marker = null;
  var route_mouse_marker_timeout = null;
  var route_mouse_marker_dragging = false;
  var route_drag_step_idx = 0;
  var route_drag_planning_ongoing = false;
  var route_drag_lines = [];
  var route_drag_next_event = null;
  var route_drag_latest_route = null;
  var route_drag_add_waypoint = false;
  var route_drag_full_replan = false;
  var route_drag_mouse_marker = null;
  var last_zoom = -1;
  var refresh_zoomout = true;
  var latest_ga_update = null;
  var my_last_ip = null;
  var asked_for_replanning = false;
  var asked_for_current_charge = false;
  var replan_next_Time = false;
  var show_driving = true;
  var do_plan_on_position_obtained = false;
  var total_route_count = 900000;
  var draw_car_callback_handler = null;
  var popupdiv = null;
  var popupinput = null;
  var popup_selected_levels = [];
  var popuptable = null;
  var lastclicktime = null;
  var screen_buttons_callback_handler = null;
  var charge_options_wp_idx = null;
  var round_trip = false;
  var refresh_route_count_handler = null;
  var turnline = [];
  var map_style_layer = null;
  var nosleep = null;
  var keep_screen_on = false;
  var keep_screen_on_implemented = false;
  var battery_manual_offset_soc = 0;
  var battery_manual_verified = false;
  var battery_manual_last_change = null;
  var battery_manual_last_offset_soc = null;
  var battery_manual_last_step_idx = null;
  var battery_manual_last_point_idx = null;
  var battery_manual_present_offset_soc = null;
  var battery_manual_present_step_idx = null;
  var battery_manual_present_point_idx = null;
  var battery_manual_last_display_soc = 0;
  var battery_manual_display_verified = false;
  var plan_next_soc_perc = null;
  var obd_req_in_progress = false;
  var last_req_time = 0;
  var car_models = [];
  var loaded_plan_uuid = null;
  var sharing_uuid = null;

  var infowindows = [];
  
  if (session_id.length == 0) {
    session_id = getDefaultStorageValue("session_id","");
  }
  if (session_id.length == 0) {
    session_id = random_session();
  } else if (getDefaultStorageValue("gdpr_cookies_ok", false)) {
    gdpr_cookies_ok = true;
    setStorageValue("gdpr_cookies_ok", true);
  }
  if (gdpr_cookies_ok) {
    console.log("GDPR cookies are OK for session ID: " + session_id);
    document.cookie = "routeplannersessionid="+session_id;
  }
  eula_version_ok = getDefaultStorageValue("eula_version_ok", 0);
  
  function openEula() {
    var div = document.getElementById("eula-div");
    div.style.display = "";
  }
  
  function closeEula() {
    var div = document.getElementById("eula-div");
    div.style.display = "none";
  }
  
  function onEulaOK() {
    gdpr_cookies_ok = true;
    eula_version_ok = eula_version;
    setStorageValue("gdpr_cookies_ok", true);
    setStorageValue("eula_version_ok", eula_version);
    document.cookie = "routeplannersessionid="+session_id;
    closeEula();
  }
  
  function onEulaNotOK() {
    gdpr_cookies_ok = false;
    eula_version_ok = 0;
    closeEula();
  }
  
  function refreshMap() {
  }
  
  function checkWatchdog() {
    var t = new Date().getTime();
    if (is_car_browser) {
      if ((last_sign_of_life != null && t-last_sign_of_life > 60000) ) {
        loadSettings("");
        refreshMap();
      }
    }
    last_sign_of_life = t;
  }
  
  function checkConnection(conn_info) {
    if (my_last_ip != null && my_last_ip != conn_info.ip) {
      refreshMap();
    }
    my_last_ip = conn_info.ip;
  }
  
  function initialize() {
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register("serviceworker.js")
      .then(function(registration) {
        console.log('Service worker registration successful, scope is:', registration.scope);
      })
      .catch(function(error) {
        console.log('Service worker registration failed, error:', error);
      });
    }

    if (navigator.userAgent.search("QtCarBrowser") >= 0) {
      if (navigator.userAgent.search("WebKit/601") >= 0) {
        is_new_car_browser = true;
      }
      if (navigator.userAgent.search("Chromium") >= 0) {
        // Mozilla/5.0 (X11; GNU/Linux) AppleWebKit/537.36 (KHTML, like Gecko) Chromium/72.0.3626.122 Chrome/72.0.3626.122 Safari/537.36 Tesla QtCarBrowser
        is_chrome_car_browser = true;
      }
      is_car_browser = true;
      use_old_mapbox = true;
    }
    if ( window.location.href.indexOf("alpha") >= 0  && is_car_browser && !debug) {
      show_console = true;
    }
    if (show_console) {
      window.console.log = showConsole;
      window.console.error = showConsole;
      window.console.exception = showConsole;
      window.console.info = showConsole;
      window.console.warn = showConsole;
      window.onerror = showConsoleError;
    }
    
    mapmode = getDefaultStorageValue("mapmode", "map");
    setMapMode(mapmode);    
    populateDropdowns();
    loadCarModels();
    
    showRouteplanner();
    urlquery = "";
    if (window.location.hash) {
      urlquery = window.location.hash.substring(1);
    } else if (window.location.search) {
      urlquery = window.location.search.substring(1);
    }
    loadSettings(urlquery);
    center_map = true;
    if (hasMyTesla() || hasOBD()) {
      getCarPos();
    }
    
    $(window).focus(function() { browser_is_in_focus = true; browserActive(); });
    $(window).blur(function() { browser_is_in_focus = false; browserInactive(); });
    
    if (is_car_browser) {
      removeTeslaDoubleClicks();    
      resetDebounce();
      toggleScreenButtons();
    }
    
    ga('create', 'UA-89921491-2', 'auto', 'driving');
    ga('create', 'UA-89921491-1', 'auto', 'planning');
    ga('planning.send', 'pageview');
    
    chrg = new ChargerObject();
    obd_instr = new Pageinated(document.getElementById("obd-instructions-div"));
    showPlanList(false);

    if (is_new_car_browser) {
      var spacer = document.getElementById("drive-spacer");
      spacer.style.display = "block";
    }
    checkVersion();
    hasTelemetry();
  }


  function initializePostLoading() { // Initialization done after loading settings and carmodels
    if (settings_applied && car_models.length > 0 && about_shown && !initialize_done) {
      initialize_done = true;
      console.log("Initialize post loading and about.");
      if (!getDefaultStorageValue("initial_car_model_selected", false)) {
        openInitialCarSelector();
      } else {
        if (!gdpr_cookies_ok || eula_version_ok < eula_version) {
          openEula();
        }
      }
      setWatchBrowserLocation();
      updateVisit("arrive", "planning");

      if (plan && "routes" in plan && plan.routes.length > 0) {
        planchanged = false;
        showRoute(plan, 0, "all", true);
      } else {
        //showPreliminaryRoute(null);
      }
    }
  }
  
  function browserActive() {
    loadSettings(""); 
    getCarPos();
    getVersion();
  }

  var last_reload_question = null;

  function getVersion() {
    $.getJSON("https://abetterrouteplanner.com/db_data.py/get_ui_version", { format: "json"})
        .done(function (res) {
          checkVersion(res.version);
        });
  }

  function checkVersion(server_version) {
    if (server_version > ui_version) {
      var now = (new Date()).getTime();
      if (!last_reload_question || last_reload_question+3600 < now) {
        openInputDialog("New ABRP version", "There is a new version of A Better Routeplanner avaialble. Reload to install?", "message",
          function (yes) { if (yes) { saveSettings(); location.reload(true); }}, "Yes", "No", 10*1000, true); 
        last_reload_question = now;          
      }
    }
  }

  function browserInactive() {
    keepScreenOn(false);
    is_car_active_count = 0;
    if (!sharing_uuid) {
      is_car_active = false; // If car is moving when we get back, the normal detection will trigger driving mode again
    }
  }

  function onMapLoaded() {
    drawCarLocation();
    console.log("Map loaded!");
  }
  
  function createMap() {
    carlatlon = getDefaultStorageValue("carlatlon", [55, 13]);
    var mapcenter = getDefaultStorageValue("mapcenter", null);
    if (!mapcenter) {
      mapcenter = carlatlon;
    }
    
    if (use_old_mapbox) {
      var map = L.map("map-canvas", { zoomControl: false}).setView(mapcenter, getDefaultStorageValue("mapzoom", 7));
      bigmap = map;
      setNight(nightmode);
    } else {
      var map = new mapboxgl.Map({
        container: 'map-canvas', 
        id: "mainmap",
        style: 'mapbox://styles/blincoln/cjm3rsp39aiwe2rppccry5dcg',
        center: [carlatlon[1], carlatlon[0]], 
        zoom: 8,
      });
      bigmap = map;
    } 
    
    
    bigmap.on("moveend", onMapIdle);
    bigmap.on("zoomend", onMapZoom);
    bigmap.on("load", onMapLoaded);
    bigmap.on("dragend", function() { setCenter(false);});
    bigmap.on("click", onMapClick);
    bigmap.on("contextmenu",onMapRightClick);
  }

  function setMapMode(mode) {
    var mapbutton = document.getElementById("mapbutton");
    var nomapbutton = document.getElementById("mapbutton");
    if (mode == "map") {
      if (!bigmap) {
        createMap();
        setNight(nightmode);
        if (chrg) {
          chrg.refreshChargers(getFastChargerTypes(),bigmap,true);
        }
        showRoute(plan, selrouteidx, "all", true);
      }  
      if (drivedisplaymode == "both") {
        setDriveDisplay("graph");
      }
      mapbutton.dataset.active = "true";
      document.getElementById("nomapstyles").disabled = true;
      $("#plan-overlay").css("display","inline-block");
    } else {
      if (bigmap) {
        chrg.clearChargers();
        if (carmarker) {
          carmarker.remove();
          carmarker = null;
        }
        bigmap.remove();
        bigmap = null;
      }
      mapbutton.dataset.active = "false";
      document.getElementById("nomapstyles").disabled = false;
      if (is_car_active) {
        setNoMapDriveDisplay("graph");
      } else {
        setNoMapDriveDisplay("plan");
      }
    }
  }

  function toggleMap(msg) {
    if (mapmode == "map") {
      mapmode = "nomap";
      showToast("No-map mode enabled");
    } else {
      mapmode = "map";
      showToast("Map mode enabled");
    }
    setStorageValue("mapmode", mapmode);
    setMapMode(mapmode);
  }

  function showConsole(msg) {
    if (show_console) {
      var consolediv = document.getElementById("console-div");
      consolediv.style.display = "";
      var p = document.createElement("p");
      p.style.color = "white";
      var text = document.createTextNode(msg);
      p.appendChild(text);
      consolediv.appendChild(p);
    }
  }
  
  function showConsoleError(msg, url, line, col, err) {
    if (show_console) {
      var consolediv = document.getElementById("console-div");
      consolediv.style.display = "";
      var p = document.createElement("p");
      p.style.color = "red";
      var errtext = msg+" "+url+" "+line+" ";
      if (err) {
        errtext += err.fileName+" "+err.lineNumber;
      }
      var text = document.createTextNode(errtext);
      p.appendChild(text);
      consolediv.appendChild(p);
    }
  }

  function onConsoleClick() {
    var div = document.getElementById("console-div");
    
    while (div.firstChild) {
        div.removeChild(div.firstChild);
      }
  }
  
  var debug_time = 0;

  function onMapClick(event) {
    if (debug) {
      var lat;
      var lon;
      if (use_old_mapbox) {
        lat = event.latlng.lat;
        lon = event.latlng.lng;
      } else {
        lat = event.lngLat.lat;
        lon = event.lngLat.lng;
      }
      car_soc_perc += 1.0;
      debug_time += 10.0;
      car_charge_profile_power.push(98.0);
      car_charge_profile_soc_perc.push(car_soc_perc);
      car_charge_profile_time.push(debug_time);
      setCarLocation(lat, lon, null, null, null);
    }
    closeOnMapClick();
  }

  function onMapRightClick(event) {
    var lat = event.latlng.lat;
    var lon = event.latlng.lng;
    getLocationInfo(lat, lon, showLocationInfoWindow);
    closeOnMapClick();
  }

  function showLocationInfoWindow(lat, lon, location) {
    showLocationInfowindow(lat, lon, location);
  }

  function getLocationInfo(lat, lon, callback) {
    var url = "https://abetterrouteplanner.com/locationservice.py/posinfo?lat="+lat+"&lon="+lon;
    $.getJSON(url, { format: "json"})
    .done(function (res) {
      if (res.status == "ok") {
        callback(lat, lon, res);
      } else {
        callback(lat, lon, null);
      }
    })
    .fail(function() {
      console.log("Failed to get location info");
      callback(lat, lon, null);
    });
  }
  
  function closeOnMapClick(){
    closeAbout();
    for (var i=0; i < infowindows.length; i++){
      infowindows[i].close();
      delete infowindows[i];
    }
    infowindows = [];
    autocompleteClose();
  }
  
  function toggleScreenButtons() {
    var buttons = document.getElementById("screenbuttons");
    if (buttons.style.display == "block") {
      // Hide the display
      var buttons = document.getElementById("screenbuttons");
      buttons.style.display = "none";
      screen_buttons_callback_handler = null;
      document.getElementById("overlay-expand-plus").style.display = "block";
      document.getElementById("overlay-expand-x").style.display = "none";
    } else {
      // Show the map buttons
      buttons.style.display = "block";
      document.getElementById("overlay-expand-plus").style.display = "none";
      document.getElementById("overlay-expand-x").style.display = "block";
    }
    // delayHideScreenButtons();
  }
  
  function delayHideScreenButtons() {
    if (screen_buttons_callback_handler) {
      clearTimeout(screen_buttons_callback_handler);
    }
    screen_buttons_callback_handler = window.setTimeout(hideScreenButtons, 3000);
  }
  
  function hideScreenButtons() {
  }
  

  function openFullscreen() {
    var elem = document.documentElement;
    if (elem.requestFullscreen) {
      elem.requestFullscreen();
    } else if (elem.mozRequestFullScreen) { /* Firefox */
      elem.mozRequestFullScreen();
    } else if (elem.webkitRequestFullscreen) { /* Chrome, Safari and Opera */
      elem.webkitRequestFullscreen();
    } else if (elem.msRequestFullscreen) { /* IE/Edge */
      elem.msRequestFullscreen();
    }
  }

  function closeFullscreen() {
    if (document.exitFullscreen) {
      document.exitFullscreen();
    } else if (document.mozCancelFullScreen) { /* Firefox */
      document.mozCancelFullScreen();
    } else if (document.webkitExitFullscreen) { /* Chrome, Safari and Opera */
      document.webkitExitFullscreen();
    } else if (document.msExitFullscreen) { /* IE/Edge */
      document.msExitFullscreen();
    }
  }

  var is_fullscreen = false;

  function setFullScreen(on) {
    if (on && !is_fullscreen) { 
      openFullscreen();
    }
    if (!on && is_fullscreen) { 
      closeFullscreen();
    }
    is_fullscreen = on;
  }

  function keepScreenOn(on) {
    if (is_car_browser || !(is_ios || is_android)) {
      return;
    }
    if (nosleep == null) {
      nosleep = new NoSleep();
    }
    if (on) {
      if (!keep_screen_on) {
        keep_screen_on_implemented = false;
        document.addEventListener('click', function enableNoSleep() { // Must be called on user interaction to work
          document.removeEventListener('click', enableNoSleep, false);
          if (keep_screen_on) {
            nosleep.enable(); 
            keep_screen_on_implemented = true;
          } 
          hideToast();
          console.log("Keep screen on!");
        }, false);
        setTimeout(function () {
          if (!keep_screen_on_implemented && keep_screen_on) {
            showToast("Touch the screen to keep screen on");
          }
        }, 5000);
      }
    } else {
      if (keep_screen_on) {
        nosleep.disable();
      }
    }
    keep_screen_on = on;
  }
  
  function setNight(on) {
    nightmode = on;
    var nightbutton = document.getElementById('nightbutton');
    var toolbar_nightbutton = document.getElementById("toolbar-nightbutton");
    var mapcanvas = document.getElementById("map-canvas");
    var nightstyles = document.getElementById("nightstyles");
    if (!nightmode) {
      mapcanvas.style.backgroundColor = "#a0a0a0";
      if (bigmap) {
        if (use_old_mapbox) {
          if (map_style_layer) {
            map_style_layer.remove();
          }
          url = "https://api.maptiler.com/maps/48175abc-e0cd-49fa-a87d-95bc2e2b3684/256/{z}/{x}/{y}{r}.jpg?key=e0rAAW4fuJT6T8iZkjiD"
          if (!is_car_browser) {
            url = url.replace("{r}", "@2x")
          }
          map_style_layer = L.tileLayer(url, { attribution: '<a href="https://www.maptiler.com/copyright/" target="_blank">© MapTiler</a> <a href="https://www.openstreetmap.org/copyright" target="_blank">© OpenStreetMap contributors</a>'}).addTo(bigmap);
        }
      }
      nightbutton.dataset.active = "false";
      toolbar_nightbutton.dataset.active = "false";
      $("#toolbar-nightimg").attr("data-active","false");
      nightstyles.disabled = true;
    } else {
      mapcanvas.style.backgroundColor = "#000000";
      if (bigmap) {
        if (use_old_mapbox) {
          if (map_style_layer) {
            map_style_layer.remove();
          }
          url = "https://api.maptiler.com/maps/36c1467d-33da-4e64-9f2f-6c468bfbd353/256/{z}/{x}/{y}{r}.jpg?key=e0rAAW4fuJT6T8iZkjiD";
          if (!is_car_browser) {
            url = url.replace("{r}", "@2x")
          }
          map_style_layer = L.tileLayer(url, { attribution: '<a href="https://www.maptiler.com/copyright/" target="_blank">© MapTiler</a> <a href="https://www.openstreetmap.org/copyright" target="_blank">© OpenStreetMap contributors</a>'}).addTo(bigmap);
        } else {
          bigmap.setStyle("mapbox://styles/blincoln/cjlwgsbex3mh92rppflfedm5a");
        }
      } else {
        mapcanvas.style.backgroundColor = "#000000";
      }
      nightbutton.dataset.active = "true";
      toolbar_nightbutton.dataset.active = "true";
      $("#toolbar-nightimg").attr("data-active","true");
      nightstyles.disabled = false;
    }
    setStorageValue("nightmode", nightmode);
  }

  function toggleNight() {
    delayHideScreenButtons();
    if (nightmode) {
      showToast("Night mode off");
      setNight(false);
    } else {
      showToast("Night mode on");
      setNight(true);
    }
  }
  
  function autoNight() {
    if (carlatlon && !debug) {
      var carlat = carlatlon[0];
      var carlon = carlatlon[1];
      var now = new Date();
      
      var yearday = now.getMonth()*30.4+now.getDate();
      var solartime = now.getUTCHours()+now.getUTCMinutes()/60.0 + carlon/180.0*12.0;
      var sun_phi = -Math.cos((yearday+9)/365.0*2*Math.PI)*23.44/180.0*Math.PI;
      var lat_phi = carlat/180*Math.PI;
      var time_theta = (solartime-12.0)/24.0*2*Math.PI;
      
      var horiz_elev = 180.0/Math.PI*Math.asin(Math.sin(lat_phi)*Math.sin(sun_phi) + Math.cos(lat_phi)*Math.cos(sun_phi)*Math.cos(time_theta));
      if (is_car_browser) {
        var limit_deg = 0.0;
        if (horiz_elev < limit_deg && (last_sun_horiz_elev == null || last_sun_horiz_elev >= limit_deg)) {
          setNight(true);
        } else if (horiz_elev >= limit_deg && (last_sun_horiz_elev == null || last_sun_horiz_elev < limit_deg)) {
          setNight(false);
        }
      }
      last_sun_horiz_elev = horiz_elev;
    }
  }
  
  function setNav(on) {
    navmode = on;
    // var navbutton = document.getElementById('navbutton');
    // if (!navmode) {
    //   navbutton.dataset.active = "false";
    // } else {
    //   navbutton.dataset.active = "true";
    // }
    //Set directions to invisible no matter what.
    var dircenterdiv = document.getElementById("directions-center-div");
    dircenterdiv.style.display = "none";
    setStorageValue("navmode", navmode);
  }
  
  function hideNav() {
    navhidden = true;
    var dircenterdiv = document.getElementById("directions-center-div");
    dircenterdiv.style.display = "none";
  }
  
  
  function toggleNavigation() {
    delayHideScreenButtons();
    if (navmode) {
      showToast("Real-time navigation off");
      setNav(false);
    } else {
      showToast("Real-time navigation on");
      setNav(true);
    }
  }
  
  function toggleCheckBox(key) {
    var form = document.getElementById('plan-form');
    if (key == "SC" || key == "tesla_ccs"  || key == "ccs" || key == "chademo") {
      //Only check the box if the checkbox is enabled for input.  Return if disabled.
      if (form.elements[key].disabled){ return; }
      form.elements[key].checked = !form.elements[key].checked;
      onDCFCToggle(key);
    } else {
      form.elements[key].checked = !form.elements[key].checked;
    }
  }
  
  function onDCFCToggle(key){
    var form = document.getElementById('plan-form');
    if (!form.elements["SC"].checked && !form.elements["tesla_ccs"].checked && !form.elements["ccs"].checked && !form.elements["chademo"].checked) {
      //No fast chargers selected, we should select one.
      if (!form.elements["SC"].disabled && key != "SC") {
        form.elements["SC"].checked = true;
      } else if (!form.elements["ccs"].disabled && key != "ccs") {
        form.elements["ccs"].checked = true;
      } else if (!form.elements["chademo"].disabled && key != "chademo") {
        form.elements["chademo"].checked = true;
      }
    }
    chrg.refreshChargers(getFastChargerTypes(),bigmap);
  }
  
  function onPlugToggle(plug){
    chrg.dest_dict[plug] = !chrg.dest_dict[plug];
    setPlugToggles();
    setStorageValue("destplugs",chrg.dest_dict);
  }
  
  function setPlugToggles(){
    for (var plug in chrg.dest_dict) {
      if (chrg.dest_dict[plug]) {
        // Plug is enabled, set the background appropriately.
        document.getElementById(plug+"_td").style.backgroundColor = ("#558787");
        document.getElementById(plug+"_check").style.display = "";
      } else {
        // Plug is enabled, set the background appropriately.
        document.getElementById(plug+"_td").style.backgroundColor = ("rgba(255, 255, 255, 0.8)");
        document.getElementById(plug+"_check").style.display = "none";
      }
    }
    if (bigmap) {
      chrg.updateDestTypes();
    }
  }
  
  function setPlugRegion(region) {
    chrg.region = region;
    popupSetValueById("plugregion",region);
    if (region == "na") {
      // show North American plugs
      for (var i = 0; i< chrg.na_dests.length; i++) {
        document.getElementById(chrg.na_dests[i] + "_td").style.display = "";
      }
      for (var i = 0; i< chrg.eu_dests.length; i++) {
        document.getElementById(chrg.eu_dests[i] + "_td").style.display = "none";
      }
    } else if (region == "eu") {
      // show European plugs
      for (var i = 0; i< chrg.na_dests.length; i++) {
        document.getElementById(chrg.na_dests[i] + "_td").style.display = "none";
      }
      for (var i = 0; i< chrg.eu_dests.length; i++) {
        document.getElementById(chrg.eu_dests[i] + "_td").style.display = "";
      }
    }
    setStorageValue("plug_region",chrg.region);
  }
  
  function togglePlugOverlay(){
    var open = document.getElementById('plugsoverlay').style.display;
    if (open == "none") {
      document.getElementById('plugsoverlay').style.display = "";
    } else {
      document.getElementById('plugsoverlay').style.display = "none";
    }
  }
  
  function setCenter(on) {
    centermode = on;
    var centerbutton = document.getElementById('centerbutton');
    if (!centermode) {
      centerbutton.dataset.active = "false";
    } else {
      centerbutton.dataset.active = "true";
      last_center_latlon = null;
      last_center_map = null;
    }
    setStorageValue("centermode", centermode);
  }
  
  
  function toggleCenter() {
    delayHideScreenButtons();
    if (centermode) {
      showToast("Do not center on car");
      setCenter(false);
    } else {
      showToast("Center on car");
      setCenter(true);
    }
    updateMap();
  }
  
  function centerMap(lat, lon, zoom) {
    if (bigmap) {
      if (use_old_mapbox) {
        bigmap.setView(L.latLng(lat, lon), zoom);
      } else {
        bigmap.setCenter([lon, lat]);
        bigmap.setZoom(zoom);
      }
      setStorageValue("mapzoom", zoom);
    }
  }
  
  function plotcar(angle) {
    var canvas = document.getElementById("carcanvas")
    var context = canvas.getContext('2d');
    var cosa = Math.cos(angle/180.0*Math.PI);
    var sina = Math.sin(angle/180.0*Math.PI);
    context.clearRect(0,0,48,48);
    context.save();
    if (angle != null) {
      context.rotate(angle/180.0*Math.PI);
    }
    context.translate(24*sina+24*cosa,24*cosa-24*sina);
    context.drawImage(carimg,-24,-24);
    context.restore();
    return canvas;
  }
  
  function setWatchBrowserLocation() {
    if (navigator.geolocation && !debug) {
      var geo_options = {
        enableHighAccuracy: true, 
        maximumAge        : 10000, 
      };
      if (watchposid) {
        navigator.geolocation.clearWatch(watchposid);
      }
      watchposid = navigator.geolocation.watchPosition(gotBrowserLocation, gotBrowserLocationError, geo_options);
    }
  }

  function gotBrowserLocationError(e) {
    console.log("Browser location error!"+e);
  }

  var watchbrowser_timeout = null;
  var last_telemetry_revival_time = 0;

  function gotBrowserLocation(pos) {
    if (is_new_car_browser) {
      if (watchbrowser_timeout) {
        clearTimeout(watchbrowser_timeout);
      }
      watchbrowser_timeout = window.setTimeout(setWatchBrowserLocation, 5000); // In Tesla browser from 2018.50.6, the watchPosition is stopped after one position if user is too slow accepting the dialog... *Sigh*
    }
    var latlon = latLon(pos.coords.latitude, pos.coords.longitude);
    var timestamp = pos.timestamp;
    var now = (new Date()).getTime();
    if ((is_car_browser || is_car_active) && telemetry_recv_time && now - telemetry_recv_time > 30*1000 ) {
      telemetry_received = false;
      telemetry_recv_time = null;
      carlocationinfo = null;
      showMyTeslaActive(true);
      console.log("No telemetry received for 30s - reverting to browser pos.");
    }
    if (is_new_car_browser || !telemetry_received || OBD_active) {
      setCarLocation(pos.coords.latitude, pos.coords.longitude, null, null, timestamp);
    }
    if (!telemetry_received) {
      updateGADriving("browserpos");
      if (now > last_telemetry_revival_time + 30000) {
        last_telemetry_revival_time = now;
        getCarPos(); // Check if we can revive the connection
      }
    }
    if (getDefaultStorageValue("country_code_3", null) == null) {
      setCountry(latlon);
    }
  }
  
  var set_country_done = false;

  function setCountry(latlon) {
    if (set_country_done) { // Only do once
      return;
    }
    var url = "https://abetterrouteplanner.com/locationservice.py/get_location?lat="+latlon[0]+"&lon="+latlon[1];
    set_country_ongoing = true;
    $.getJSON(url, { format: "json"})
    .done(function (res) {
      if (res) {
        var loc = res.Address.Country;
        setStorageValue("country_code_3", loc);
        var na_countries = ["USA","UMI","PRI","CAN","MEX"];
        if (loc != null && na_countries.indexOf(loc) >= 0) {
          chrg.region = "na";
        } else {
          chrg.region = "eu";
        }
        if (getDefaultStorageValue("region", null) == null) {
          setStorageValue("region",chrg.region);
        }
        if (loc == "USA") {
          setUnits("imperial");
        } else {
          setUnits("metric");
        }
        console.log("Set country code to "+loc+" and region to "+chrg.region);
      }
    })    
    .fail(function() {
      console.log('Get country error.');
    });
    
  }
  
  
  function isNullOrWhitespace(text) {
    if (text == null) {
      return true;
    }
    return text.replace(/\s/gi, '').length < 1;
  }
  
  function updateGADriving(status) {
    if (is_car_browser || is_car_active) {
      var now = (new Date()).getTime();
      if (latest_ga_update == null || now - latest_ga_update > 30000) {
        if (car_on_route) {
          status += "/onroute";
        } else if (car_on_wp) {
          status += "/onwp";
        } else if (!planchanged) {
          status += "/offplan";
        } else {
          status += "/noplan";
        }
        if (is_new_car_browser) {
          status += "/tesla";
        } else if (is_ios) {
          status += "/ios";
        } else if (is_android) {
          status += "/android";
        }
        status += "/"+getDefaultStorageValue("carmodel", "3long")
        latest_ga_update = now;
        ga('driving.set', 'page', window.location.pathname.replace("index.html", "")+status);
        ga('driving.send', 'pageview');
        updateVisit("page", "driving");
      }
    }
  }
  
  function updateGAPlanning(settings) {
    
    var path = "";
    path += settings["carmodel"];
    path += "/"+settings["fast_chargers"];
    
    ga('planning.set', 'page', window.location.pathname.replace("index.html", "")+path);
    ga('planning.send', 'pageview');
    updateVisit("page", "planning");
  }
  
  function updateVisit(visittype, resource) {
    var url = "https://abetterrouteplanner.com/db_data.py/user_visit";
    var data = "session_id="+session_id+"&visittype="+encodeURIComponent(visittype)+"&resource="+encodeURIComponent(resource);
    $.post({ url: url, data: data, dataType: "json" })
    .done(function (res) {
      if ("ui_version" in res) {
        checkVersion(res.ui_version);
      }
    });
  }

  function showDriveFrame(on) {
    var div = document.getElementById("drive-frame");
    if (on) {
      div.style.borderWidth = "2px";
    } else {
      div.style.borderWidth = "0px";
    }
  }
    
  
  function calibrateAndPlan() {
    var form = document.getElementById('plan-form');
    var relspeed = Math.round(calibrate_rel_speed*100.0);
    var refcons = 0.0;
    var refconsunit = "";
    if (units == "metric") {
      if (cons_units == "energy_per_distance") {
        refcons  = Math.round(calibrate_consump);
        refconsunit = "Wh/km @ 110 km/h";
      } else {
        refcons = convertConsUnits(calibrate_consump);
        refconsunit = "km/kWh @ 110 km/h";
      }
    } else {
      if (cons_units == "energy_per_distance") {
        refcons = Math.round(calibrate_consump*1.609/0.96);
        refconsunit = "Wh/mi @ 65 mph";
      } else {
        refcons = convertConsUnits(calibrate_consump*1.609/0.96);
        refconsunit = "miles/kWh @ 65 mph";
      }
    }
    
    if (calibrate_consump > 0) {
      openInputDialog("Use estimated reference consumption: "+refcons+" "+refconsunit+"?", null, "message", 
        function (yes) { 
          if (yes) { 
            form.elements["consumption"].value = refcons;   
          }
          showRouteplanner();
          replan(); 
        }, 
        "Yes", "No", 20000, true);
    } else {
      showRouteplanner();
      replan(); 
    }
  }
  
  var drive_logging_log_interval = 10; // Log one point every 10 seconds
  var drive_logging_points = [];
  var drive_logging_last_log_time = 0;
  var drive_logging_last_latlon = null;
  var drive_logging_manual_soc = null;
  var drive_logging_step_dist = 0;
  var drive_logging_sending_in_progress = false;
  var drive_logging_sending_to_idx = 0;

  function driveLoggingUpdate() {
    if (!is_car_active) {
      return;
    }
    if (drive_logging_last_latlon) {
      drive_logging_step_dist += calcDistance(carlatlon[0], carlatlon[1], drive_logging_last_latlon[0], drive_logging_last_latlon[1]);
    }
    drive_logging_last_latlon = carlatlon;
    var now = carlatlon_time;
    if (now - drive_logging_last_log_time > drive_logging_log_interval*1000) {
      if (now - drive_logging_last_log_time < drive_logging_log_interval*1000*2) {
        var plan_settings = getPlanSettings();
        log_point = { };
        log_point.session_id = browser_session_id; // This is to identify the driving session - it is a new random number every time the page is reloaded
        log_point.lat = carlatlon[0];
        log_point.lon = carlatlon[1];
        log_point.time = parseInt(now/1000);
        log_point.duration = (now - drive_logging_last_log_time)/1000;
        log_point.distance = drive_logging_step_dist;
        log_point.avg_speed = drive_logging_step_dist/log_point.duration;
        log_point.carmodel = plan_settings["carmodel"];
        log_point.ref_cons = parseInt(plan_settings["typ_consumption"]);
        if (telemetry_received) {
          log_point.telemetry = "mytesla";
        }
        if (drive_logging_manual_soc != null) {
          log_point.soc_perc = drive_logging_manual_soc;
        }
        if (car_soc_perc != null && telemetry_received) {
          log_point.soc_perc = car_soc_perc;
        }

        if (log_point.avg_speed < 250/3.6) {
          drive_logging_points.push(log_point);
          if (drive_logging_points.length >= 6 || debug) { // Send every 1 minute (and recalibrate)
            driveLoggingSend();
          }
        }
      }
      drive_logging_last_log_time = now;
      drive_logging_step_dist = 0;
      drive_logging_manual_soc = null;
    }
  }

  function driveLoggingSetBattery(soc) {
    drive_logging_manual_soc = soc;
  }

  function driveLoggingSend() {
    if (eula_version_ok < 1 || drive_logging_points.length == 0) {
      return;
    }
    if (drive_logging_sending_in_progress) {
      return;
    }
    drive_logging_sending_to_idx = drive_logging_points.length;

    var url = "https://abetterrouteplanner.com/client_logging.py/post_log"
    var data = "data="+encodeURIComponent(JSON.stringify(drive_logging_points));
    drive_logging_sending_in_progress = true;
    $.post({ url: url, data: data, dataType: "json" })
      .done(function(res) {
        drive_logging_sending_in_progress = false;
        if (res.status == "ok") {
          drive_logging_points = drive_logging_points.slice(drive_logging_sending_to_idx);
          if ("calibration" in res && res.calibration.status == "ok") {
            calibrate_consump = res.calibration.calib_ref_cons;
          } else {
            calibrate_consump = null;
          }
        }
      })
      .fail(function() {
        console.log('Send drive log error.');
        drive_logging_sending_in_progress = false;
      });
  }

  function calcBearing(lat1, lon1, lat2, lon2) {
    x = Math.cos(lat1*Math.PI/180)*(lon2-lon1);
    y = lat2-lat1;
    return Math.atan2(x, y)/Math.PI*180;
  }
  
  function setCarLocation(lat, lon, heading, locationinfo, timestamp) {
    if (timestamp != null && carlatlon_time != null && timestamp < carlatlon_time) {
      return; // This position is older than what I have already
    }
    if (timestamp == null) {
      timestamp = (new Date()).getTime();
    }
    var latlon = latLon(lat, lon);
    var now = (new Date()).getTime();
    if (heading == null && carlatlon && calcDistance(carlatlon[0], carlatlon[1], lat, lon) > 2) {
      heading = calcBearing(carlatlon[0], carlatlon[1], lat, lon);
    }
    if (!telemetry_received) {
      if (carlatlon && calcDistance(carlatlon[0], carlatlon[1], lat, lon) > 5 && 
          (!is_car_active_start_time || (now-is_car_active_start_time) < 5*60*1000 || calcDistance(car_start_latlon[0], car_start_latlon[1], lat, lon) > 1000)) {
            // We are active if we moved 5 meters since last and we are at least 1000 meters from the starting point after five minutes of driving
        is_car_active_count += 1;
        if (is_car_active_count > 4 || debug) {
          last_is_car_active_time = now;
          is_car_active = true;
        }
      } else {
        if ((is_car_active && now - last_is_car_active_time > 60*1000)) { // One minute of stand-still before we deactivate driving mode
          is_car_active_count = 0;
          is_car_active = false;
        }
      }
    }
    if (!last_is_car_active && is_car_active) {
      is_car_active_start_time = now;
      car_start_latlon = latlon;
      console.log("Car became active!");
    }
    if (last_is_car_active && !is_car_active) {
      console.log("Car became inactive!");
    }
    last_is_car_active = is_car_active;
    keepScreenOn(is_car_active);
    if (heading != null) {
      carheading = heading;
    }
    carlatlon = latlon;
    carlatlon_time = timestamp;
    if (locationinfo) {
      carlocationinfo = locationinfo;
    }
    setStorageValue("carlatlon", carlatlon);
    setStorageValue("carheading", carheading);
    autoNight();
    updateMap();
    driveLoggingUpdate();
  }
  
  function updateMap() {
    if (draw_car_callback_handler) {
      clearTimeout(draw_car_callback_handler);
    }
    draw_car_callback_handler = window.setTimeout(drawCarLocation, 100);
  }
  
  function drawCarLocation() {
    draw_car_callback_handler = null;
    var locationinfo = carlocationinfo;
    var latlon = carlatlon;
    if ((!use_old_mapbox && !bigmap.loaded()) || !latlon) {
      return;
    }

    if (bigmap) {
      var carcanvas = plotcar(carheading);
      if (!carmarker) {
        if (use_old_mapbox) {
          var canvasurl = carcanvas.toDataURL();
          var iconopt = {iconUrl: canvasurl, iconAnchor: [24, 24]};
          var icon = L.icon(iconopt);
          carmarker = L.marker(L.latLng(latlon[0], latlon[1]), { icon: icon, zIndexOffset: 200}).addTo(bigmap);
        } else {
          carmarker = new mapboxgl.Marker(carcanvas).setLngLat([latlon[1], latlon[0]]).addTo(bigmap);
        }
      } else {
        if (use_old_mapbox) {
          var canvasurl = carcanvas.toDataURL();
          var iconopt = {iconUrl: canvasurl, iconAnchor: [24, 24]}
          var icon = L.icon(iconopt);
          carmarker.setLatLng(L.latLng(latlon[0], latlon[1]));
          carmarker.setIcon(icon);
        } else {
          carmarker.setLngLat([latlon[1], latlon[0]]);
        }
      }
      if (center_map && !debug) { // Center on car (or route) first time
        center_map = false;
        if (is_car_browser) { 
          centerMap(latlon[0], latlon[1], getDefaultStorageValue("mapzoom", 16));
        }
      }
      showDriveFrame(telemetry_received);
    }
    
    if (do_plan_on_position_obtained) {
      do_plan_on_position_obtained = false;
      onPlanButton(false);
    }
    
    car_on_route = false;
    if (plan && plan.routes && selrouteidx < plan.routes.length && !planchanged) {
      var carlat = latlon[0];
      var carlon = latlon[1];
      var min_step_idx = -1;
      var min_point_idx = -1;
      var min_dist = 10000000.0;
      var new_point_idx = false;
      for (var idx = 0; idx < plan.routes[selrouteidx].steps.length-1; idx++) {
        var step = plan.routes[selrouteidx].steps[idx];
        for (var point_idx=0; point_idx < step.route_soc.length; point_idx++) {
          dist = Math.abs(step.route_soc[point_idx][0]-carlat)+Math.abs(step.route_soc[point_idx][1]-carlon)
          if (idx != car_latest_wp_idx) {
            dist += 0.01; // If this is not the latest step index, make it less likely to be the closest
          }
          if (dist < min_dist) {
            min_point_idx = point_idx;
            min_step_idx = idx;
            min_dist = dist;
          }
        }
      }
      if (car_latest_point_idx != min_point_idx) {
        new_point_idx = true;
      }
      car_latest_point_idx = min_point_idx;
      if (min_step_idx >= 0) {
        var point_data = plan.routes[selrouteidx].steps[min_step_idx].route_soc[min_point_idx];
        min_dist = calcDistance(point_data[0], point_data[1], latlon[0], latlon[1]);
        if (min_step_idx != car_latest_wp_idx) {
          car_latest_wp_idx = min_step_idx;
          console.log('Step index updated: '+car_latest_wp_idx);
        }
      }
      var min_wp_dist = 10000000.0;
      var min_wp_idx = -1;
      for (var idx = 0; idx < plan.routes[selrouteidx].steps.length; idx++) {
        var step = plan.routes[selrouteidx].steps[idx];
        var dist = calcDistance(step.lat, step.lon, latlon[0], latlon[1]);
        if (dist < min_wp_dist) {
          min_wp_dist = dist;
          min_wp_idx = idx;
        }
      }
      if ((min_wp_dist < 100.0) || (min_wp_dist < 500.0 && telemetry_received && car_shift_state == null)) {
        var step = plan.routes[selrouteidx].steps[min_wp_idx];
        car_latest_wp_idx = min_wp_idx;
        car_on_wp = true;
        min_step_idx = min_wp_idx;
        if (car_arrival_time_at_wp == null) {
          var d = new Date();
          car_arrival_time_at_wp = (d.getUTCHours()*60+d.getUTCMinutes())*60 + step.utf_offset;
        }
        var now = (new Date()).getTime();
        if (now - is_car_active_start_time < 2*60*1000) { // If just active within 2 minutes, we are leaving the WP
          car_leaving_wp = true;
        } else {
          car_leaving_wp = false;
        }
        driveLoggingSend(); // To ensure drive logging data gets uploaded before user shuts down browser
      } else {
        car_on_wp = false;
        car_arrival_time_at_wp = null;
      }
      if (min_dist < 250.0) {
        car_on_route = true;
        if (asked_for_replanning) {
          closeInputDialog(); // If we have the Replan dialog open, but came back
        }
        asked_for_replanning = false;
        car_step_idx = min_step_idx;
        car_point_idx = min_point_idx;
      } else {
        car_on_route = false;
        car_step_idx = null;
        car_point_idx = null;
      }
      

      if (car_on_route && telemetry_received && !car_on_wp) {
        var point_data = plan.routes[selrouteidx].steps[min_step_idx].route_soc[min_point_idx];
      }
      
      var next_wp_idx = getNextVisibleWaypointIdx(min_step_idx);
      var next_idx = getNextVisibleStepIdx(min_step_idx);
      
      if (car_on_route && !car_on_wp && (is_car_browser || is_car_active)) {
        var next_wp_step = plan.routes[selrouteidx].steps[next_wp_idx];
        var next_step = plan.routes[selrouteidx].steps[next_idx];
        var this_step = plan.routes[selrouteidx].steps[next_idx-1];
        var point_data = plan.routes[selrouteidx].steps[min_step_idx].route_soc[min_point_idx];
        var last_point_data = plan.routes[selrouteidx].steps[next_idx-1].route_soc[plan.routes[selrouteidx].steps[next_idx-1].route_soc.length-1];
        var point_lat = point_data[0];
        var point_lon = point_data[1];
        var ref_soc = point_data[2];
        var cons_per_km = point_data[3];
        var speed = point_data[4];
        var remain_wp_seconds = point_data[5]-Math.round(next_wp_step.arrival_duration);
        var remain_wp_km = point_data[6]-Math.round(next_wp_step.arrival_dist/1000);
        var remain_step_seconds = point_data[5]-last_point_data[5];
        var remain_step_km = point_data[6]-Math.round(next_step.arrival_dist/1000);
        var instr = point_data[7];
        var speedlimit = point_data[8];
        var region = step.region;
        var elevation = point_data[9];
        var step_arrival_perc = next_step.arrival_perc;
        
        if (car_soc_perc != null && telemetry_received) { // Store actual value for drive graph
          showBattery(false);
          if (point_data.length <= 11) {
            point_data.push(car_soc_perc);
            if (debug) {
              car_soc_perc -= 1.0;
            }
          } else {
            point_data[11] = car_soc_perc;
          }
        } else {
          showBattery(true);
          setBattery(ref_soc+battery_manual_offset_soc, false);
        }
        
        showDriving();
        setDriveDisplayGraph(true);
        updateDriveGraph(min_step_idx, min_point_idx, next_idx, next_wp_idx, false);
        
        var avg_consump_dist = 0.0;
        var point_idx = min_point_idx;
        var step_idx = min_step_idx;
        var avg_consump_10km = 0.0;
        var ref_dist = 10000;
        if (units == "metric") {
          ref_dist = 1609*5;
        }
        while (avg_consump_dist < ref_dist && step_idx >= 0) {
          var data = plan.routes[selrouteidx].steps[step_idx].route_soc[point_idx];
          var point_cons = data[3];
          var point_dist = data[10];
          avg_consump_dist += point_dist;
          avg_consump_10km += point_dist*point_cons;
          point_idx -= 1;
          if (point_idx < 0) {
            step_idx -= 1;
            if (step_idx >= 0) {
              point_idx = plan.routes[selrouteidx].steps[step_idx].route_soc.length-1;
            }
          }
        }
        if (avg_consump_dist > 0) {
          avg_consump_10km /= avg_consump_dist;
        }
        
        var drivediv = document.getElementById("drive-div");
        while (drivediv.firstChild) {
          drivediv.removeChild(drivediv.firstChild);
        }
        
        var hasactual = (car_soc_perc != null || car_speed != null);
        
        var table = document.createElement("table");
        table.className = "drivetable";
        
        var tr = document.createElement("tr");
        var td = document.createElement("td");
        td.className = "drivelabel";
        var text = document.createTextNode("Charge");
        td.appendChild(text);
        tr.appendChild(td);
        //Planned charge telemetry field
        td = document.createElement("td");
        var div = document.createElement("div");
        var html = '<div class="driveheader">Planned</div><span class="drivetext">';
        html += Math.round(ref_soc);
        html += '</span> <span class="driveunits">%</span>';
        div.innerHTML = html;
        td.appendChild(div);
        tr.appendChild(td);
        if ((car_soc_perc != null && telemetry_received) || battery_manual_verified) {
          // If available, Actual charge telemetry field
          td = document.createElement("td");
          var div = document.createElement("div");
          var html = '<div class="driveheader">Actual</div><span class="drivetext">';
          if ((car_soc_perc != null && telemetry_received)) {
            html += Math.round(car_soc_perc);
          } else {
            html += Math.round(ref_soc+battery_manual_offset_soc);
          }
          html += '</span> <span class="driveunits">%</span>';
          div.innerHTML = html;
          td.appendChild(div);
          tr.appendChild(td);
          
          // Arrival Charge telemetry
          td = document.createElement("td");
          var div = document.createElement("div");
          var html = '<div class="driveheader">Arrival Charge</div><span class="drivetext">';
          if ((car_soc_perc != null && telemetry_received)) {
            html += Math.round(car_soc_perc-ref_soc+step_arrival_perc);
          } else {
            html += Math.round(step_arrival_perc+battery_manual_offset_soc);
          }
          html += '</span> <span class="driveunits">%</span>';
          div.innerHTML = html;
          td.appendChild(div);
          tr.appendChild(td);
        }
        table.appendChild(tr);
        if ((telemetry_received && car_soc_perc != null && ((car_soc_perc < ref_soc-2) || (car_soc_perc > ref_soc+2))) || Math.abs(battery_manual_offset_soc) > 2) {
          var div = document.getElementById("replandiv");
          replandiv.style.display = "block";
        } else {
          var div = document.getElementById("replandiv");
          replandiv.style.display = "none";
        }
        
        tr = document.createElement("tr");
        td = document.createElement("td");
        td.className = "drivelabel";
        text = document.createTextNode("Consumption");
        td.appendChild(text);
        tr.appendChild(td);
        
        // Consumption telemetry field
        td = document.createElement("td");
        var div = document.createElement("div");
        var html = '<div class="driveheader">'
        if (units == "metric") {
          html += "Planned last 10 km";
        } else {
          html += "Planned last 5 miles";
        }
        html += '</div><span class="drivetext">' + getConsHTML(avg_consump_10km);
        div.innerHTML = html;
        td.appendChild(div);
        tr.appendChild(td);
        
        if (calibrate_consump != null) {
          //Calibrated consumption field
          td = document.createElement("td");
          var div = document.createElement("div");
          var html = '<div class="drivenoteheader">'
          if (units == "metric") {
            html += "Estimated at 110 km/h";
          } else {
            html += "Estimated at 65 mph";
          }
          html += '</div><span class="drivetext">' + getConsHTML(calibrate_consump);
          div.innerHTML = html;
          td.appendChild(div);
          tr.appendChild(td);
        }
        table.appendChild(tr);
        
        tr = document.createElement("tr");
        td = document.createElement("td");
        td.className = "drivelabel";
        text = document.createTextNode("Speed ");
        td.appendChild(text);
        tr.appendChild(td);
        td = document.createElement("td");
        var div = document.createElement("div");
        var html = '<div class="driveheader">Planned</div><span class="drivetext">';
        if (units == "metric") {
          html += speed + '</span> <span class="driveunits">km/h</span>';
        } else {
          html += Math.round(speed/1.609)+ '</span> <span class="driveunits">mph</span>';
        }
        div.innerHTML = html;
        td.appendChild(div);
        tr.appendChild(td);
        
        if (calibrate_rel_speed != null) {
          td = document.createElement("td");
          var div = document.createElement("div");
          var html = '<div class="drivenoteheader">Estimated relative</div><span class="drivetext">';
          html += Math.round(calibrate_rel_speed*100.0) + '</span> <span class="driveunits">%</span>';
          div.innerHTML = html;
          td.appendChild(div);
          tr.appendChild(td);
        }
        if (this_step.is_mod_speed) {
          td = document.createElement("td");
          var div = document.createElement("div");
          var html = '<div class="drivenoteheader">Maximum</div><span class="drivetext" style="color:#ff4040">';
          if (units == "metric") {
            html += Math.round(this_step.max_speed*3.6) + '</span> <span class="driveunits style="color:#ff4040"">km/h</span>';
          } else {
            html += Math.round(this_step.max_speed*3.6/1.609) + '</span> <span class="driveunits" style="color:#ff4040">mph</span>';
          }
          div.innerHTML = html;
          td.appendChild(div);
          tr.appendChild(td);
        }
        table.appendChild(tr);
        
        tr = document.createElement("tr");
        td = document.createElement("td");
        td.className = "drivelabel";
        text = document.createTextNode("To ");
        td.appendChild(text);
        if (next_step.is_charger) {
          var img = chrg.charger_overlay_icon(next_step.charger_type, true);
          td.appendChild(img);
        }
        text = document.createTextNode(" "+next_step.name.split(",")[0]);
        td.appendChild(text);
        tr.appendChild(td);
        
        // Remaining Time to waypoint field
        td = document.createElement("td");
        var div = document.createElement("div");
        var html = '<div class="driveheader">Remaining Time</div><span class="drivetext">';
        html += secondsToTimeStr(remain_step_seconds) + '</span>';
        div.innerHTML = html;
        td.appendChild(div);
        tr.appendChild(td);
                
        // Remaining Distance to waypoint field
        td = document.createElement("td");
        var div = document.createElement("div");
        var html = '<div class="driveheader">Remaining Distance</div><span class="drivetext">';
        if (units == "metric") {
          html += Math.round(remain_step_km) + '</span> <span class="driveunits">km</span>';
        } else {
          html += Math.round(remain_step_km/1.609) + '</span> <span class="driveunits">mi</span>';
        }
        div.innerHTML = html;
        td.appendChild(div);
        tr.appendChild(td);
        
        // Arrival time at waypoint
        td = document.createElement("td");
        var div = document.createElement("div");
        var html = '<div class="driveheader">Arrive at</div><span class="drivetext">';
        var d = new Date();
        d = new Date(d.getTime() + remain_step_seconds*1000);
        html += secondsToTimeStr((d.getUTCHours()*60+d.getUTCMinutes())*60 + next_step.utc_offset) + '</span>';
        div.innerHTML = html;
        td.appendChild(div);
        tr.appendChild(td);
        table.appendChild(tr);
        
        if (next_step.id != next_wp_step.id) {
          tr = document.createElement("tr");
          td = document.createElement("td");
          td.className = "drivelabel";
          text = document.createTextNode("To ");
          td.appendChild(text);
          if (next_wp_step.is_charger) {
            var img = chrg.charger_overlay_icon(next_wp_step.charger_type, true);
            td.appendChild(img);
          }
          text = document.createTextNode(" "+next_wp_step.name.split(",")[0]);
          td.appendChild(text);
          tr.appendChild(td);
          
          // Remaining Time to dest field
          td = document.createElement("td");
          var div = document.createElement("div");
          div.innerHTML = '<span class="drivetext">' + secondsToTimeStr(remain_wp_seconds) + '</span>';
          td.appendChild(div);
          tr.appendChild(td);
          
          // Remaining Distance to dest field
          td = document.createElement("td");
          var div = document.createElement("div");
          if (units == "metric") {
            div.innerHTML = '<span class="drivetext">' + Math.round(remain_wp_km) + '</span> <span class="driveunits">km</span>';
          } else {
            div.innerHTML = '<span class="drivetext">' + Math.round(remain_wp_km/1.609) + '</span> <span class="driveunits">mi</span>';
          }
          td.appendChild(div);
          tr.appendChild(td);
          
          var d = new Date();
          d = new Date(d.getTime() + remain_wp_seconds*1000);
          var arrivestr = secondsToTimeStr((d.getUTCHours()*60+d.getUTCMinutes())*60 + next_wp_step.utc_offset);
          // Arrival time at waypoint
          td = document.createElement("td");
          var div = document.createElement("div");
          div.innerHTML = '<span class="drivetext">' + arrivestr + '</span>';
          td.appendChild(div);
          tr.appendChild(td);
        }
        table.appendChild(tr);
        
        showSpeedLimit(speedlimit, region);
        
        drivediv.appendChild(table);
        
        var point_idx = min_point_idx;
        var turn_point_idx = -1;
        var instr_idx = -1;
        var advancedist = speed/3.6*40; // Show instruction 20 seconds before turn
        for (var point_idx = min_point_idx; point_idx < plan.routes[selrouteidx].steps[min_step_idx].route_soc.length
        && calcDistance(carlatlon[0], carlatlon[1],
        plan.routes[selrouteidx].steps[min_step_idx].route_soc[point_idx][0], plan.routes[selrouteidx].steps[min_step_idx].route_soc[point_idx][1])  < advancedist;
        point_idx++) {
          point_data = plan.routes[selrouteidx].steps[min_step_idx].route_soc[point_idx];
          if (point_data[7].length > 0 && instr_idx < 0) {
            instr_idx = point_idx;
          }
        }
        if (navmode && !navhidden && instr_idx >= 0) {
          if (car_turn_idx < 0 && bigmap) {
            var tmp = bigmap.getCenter();
            map_last_latlon = latLon(tmp.lat, tmp.lng);
            map_last_zoom = bigmap.getZoom();
          }
          if  (car_turn_idx != instr_idx) {
            var turn_bounds = new mapboxgl.LngLatBounds();
            var instr_data = plan.routes[selrouteidx].steps[min_step_idx].route_soc[instr_idx];
            var instr_lat = instr_data[0];
            var instr_lon = instr_data[1];
            var instr_latlon = latLon(instr_data[0], instr_data[1]);
            var point_instr = instr_data[7];
            var dest_rel_head = 0;
            if (point_instr.indexOf("left") >= 0) {
              dest_rel_head = -60;
            }
            if (point_instr.indexOf("right") >= 0) {
              dest_rel_head = 60;
            }
            var is_dest = (plan.routes[selrouteidx].steps[min_step_idx].route_soc.length-1 <= instr_idx);
            var turndist = instr_data[4]/3.6*4; // Show view from point 4 seconds before turn
            if (turndist > 100) {
              turndist = 100.0;
            }
            if (turndist < 10) {
              turndist = 10.0;
            }
            if (is_dest) {
              turndist = 15.0;
            }
            for (var point_idx = Math.max(instr_idx-20,0); point_idx < plan.routes[selrouteidx].steps[min_step_idx].route_soc.length
            && point_idx <= instr_idx; point_idx++) {
              point_data = plan.routes[selrouteidx].steps[min_step_idx].route_soc[point_idx];
              var instr_dist = calcDistance(point_data[0], point_data[1],instr_latlon[0], instr_latlon[1]);
              if (turn_point_idx < 0 && instr_dist < turndist) {
                turn_point_idx = point_idx;
              }
            }
            if (turn_point_idx < 0) {
              turn_point_idx = instr_idx;
            }
            turn_point_idx = min_point_idx;
            var turn_point_prev_idx = turn_point_idx-1;
            if (turn_point_prev_idx < 0) {
              turn_point_prev_idx = 0;
            }
            point_data = plan.routes[selrouteidx].steps[min_step_idx].route_soc[turn_point_idx];
            prev_point_data = plan.routes[selrouteidx].steps[min_step_idx].route_soc[turn_point_prev_idx];
            var instr_dist = calcDistance(point_data[0], point_data[1],instr_latlon[0], instr_latlon[1]);
            var instr_prev_dist = calcDistance(prev_point_data[0], prev_point_data[1],instr_latlon[0], instr_latlon[1]);;
            if (instr_prev_dist-instr_dist > 0) {
              var alpha = (turndist-instr_dist)/(instr_prev_dist-instr_dist);
              turn_latlon = latLon(point_data[0]*(1.0-alpha)+prev_point_data[0]*alpha,
              point_data[1]*(1.0-alpha)+prev_point_data[1]*alpha);
            } else {
              turn_latlon = latLon(point_data[0], point_data[1]);
            }
            
            var dircenterdiv = document.getElementById("directions-center-div");
            dircenterdiv.style.display = "";
            var dirdiv = document.getElementById("directions-div");
            while (dirdiv.firstChild) {
              dirdiv.removeChild(dirdiv.firstChild);
            }
            
            turnlat = turn_latlon[0];
            turnlon = turn_latlon[1];
            turnhead = calcBearing(prev_point_data[0], prev_point_data[1], turn_latlon[0], turn_latlon[1]);
            var bgdiv = document.createElement("div");
            bgdiv.style.width = "600px";
            bgdiv.style.height = "400px";
            dirdiv.appendChild(bgdiv);
            
            var div = document.createElement("div");
            div.className = "dirtext";
            div.innerHTML = point_instr;
            dirdiv.appendChild(div);
            
            turnline = [];
            var horizdist = 600.0;
            for (var idx=turn_point_prev_idx; idx < plan.routes[selrouteidx].steps[min_step_idx].route_soc.length &&
            (idx < instr_idx || calcDistance(turn_latlon[0], turn_latlon[1], plan.routes[selrouteidx].steps[min_step_idx].route_soc[idx][0], plan.routes[selrouteidx].steps[min_step_idx].route_soc[idx][1]) < horizdist);
            idx++) {
              var latlon = plan.routes[selrouteidx].steps[min_step_idx].route_soc[idx].slice(0,2);
              point_data = plan.routes[selrouteidx].steps[min_step_idx].route_soc[idx];
              turnline.push(latlon);
              turn_bounds.extend(latlon);
            }
            
            turn_bounds.extend([carlatlon[1], carlatlon[0]]);
            
            centerMap(instr_lat, instr_lon, 16);
          }
          // Redraw turn line every time the car moves
          var turnxy = projectLatLon(carlatlon[0], carlatlon[1], turnline);
          turnxy = filterXY(turnxy);
          turnxy = rotateXY(turnxy, -carheading);
          strokexy = makeStrokePath(turnxy, 1.0);
          var canvas = document.getElementById("directions-canvas");
          clearCanvas(canvas);
          var foclen = 10;
          var scale = 1000;
          stroke_proj = project3D(canvas, strokexy, -10.0, foclen, scale);
          air_proj = project3D(canvas, strokexy, 15.0, foclen, scale);
          drawArea(canvas, stroke_proj, 'rgba(0,0,255, 1.0)');
          drawArea(canvas, air_proj, 'rgba(0,0,255, 1.0)');
          
          car_turn_idx = instr_idx;
          
          // Update turn distance text
          var turn_data = plan.routes[selrouteidx].steps[min_step_idx].route_soc[car_turn_idx];
          var instr_latlon = latLon(turn_data[0], turn_data[1]);
          var turn_dist = calcDistance(instr_latlon[0], instr_latlon[1], carlatlon[0], carlatlon[1]);
          var dirdistdiv = document.getElementById("dirdist-div");
          while (dirdistdiv.firstChild) {
            dirdistdiv.removeChild(dirdistdiv.firstChild);
          }
          if (units == "metric") {
            turn_dist = Math.round(turn_dist/10)*10.0;
            text = document.createTextNode(turn_dist+" m");
          } else {
            turn_dist = Math.round(turn_dist/0.3048/10)*10.0;
            text = document.createTextNode(turn_dist+" ft");
          }
          dirdistdiv.appendChild(text);
        } else {
          var dircenterdiv = document.getElementById("directions-center-div");
          dircenterdiv.style.display = "none";
          if (car_turn_idx >= 0) {
            centerMap(map_last_latlon[0], map_last_latlon[1], map_last_zoom);
            car_turn_idx = -1;
          }
        }
        
        
      } else {
        car_turn_idx = -1;
      }
      
      if (car_on_wp && (is_car_browser || is_car_active)) {
        var dircenterdiv = document.getElementById("directions-center-div");
        dircenterdiv.style.display = "none";
        showSpeedLimit(null, null);
        showDriving();
        setDriveDisplayGraph(true);
        if (!(car_soc_perc != null && telemetry_received)) {
          var step = plan.routes[selrouteidx].steps[car_latest_wp_idx];
          var ref_soc = step.arrival_perc;
          if (!car_leaving_wp) {
            ref_soc = step.departure_perc; // If we just started moving again, assume we just charged at the WP
          }
          showBattery(true);
          setBattery(ref_soc+battery_manual_offset_soc, false);
        } else {
          showBattery(false);
        }
        if (car_latest_wp_idx >= 0) {
          var step = plan.routes[selrouteidx].steps[car_latest_wp_idx];
          var drivediv = document.getElementById("drive-div");
          while (drivediv.firstChild) {
            drivediv.removeChild(drivediv.firstChild);
          }
          
          var min_soc_idx = null;
          if (telemetry_received && car_soc_perc != null && step.is_charger && "charge_profile" in step) {
            var min_dist = 1e10;
            for (var soc_idx=0; soc_idx < step.charge_profile.length; soc_idx++) {
              var dist = Math.abs(step.charge_profile[soc_idx][0]-car_soc_perc);
              if (dist < min_dist) {
                min_dist = dist;
                min_soc_idx = soc_idx;
              }
            }
          }
          
          updateDriveGraph(car_latest_wp_idx, 0, next_idx, next_wp_idx, true);
          
          
          var table = document.createElement("table");
          table.className = "drivetable";
          
          tr = document.createElement("tr");
          var td = document.createElement("td");
          td.className = "drivelabel";
          var text = document.createTextNode("Waypoint");
          td.appendChild(text);
          tr.appendChild(td);
          td = document.createElement("td");
          td.className = "drivetext";
          var text;
          if (step.is_charger) {
            var img = chrg.charger_overlay_icon(step.charger_type, true);
            td.appendChild(img);
            text = document.createTextNode(" "+step.name);
          } else {
            text = document.createTextNode(step.name);
          }
          td.appendChild(text);
          tr.appendChild(td);
          table.appendChild(tr);
          
          if (car_soc_perc != null && telemetry_received) {
            tr = document.createElement("tr");
            td = document.createElement("td");
            td.className = "drivelabel";
            var text = document.createTextNode("Charge");
            td.appendChild(text);
            tr.appendChild(td);
            td = document.createElement("td");
            td.className = "drivetext";
            var text = document.createTextNode(Math.round(car_soc_perc)+"%");
            td.appendChild(text);
            tr.appendChild(td);
            table.appendChild(tr);
          }
          
          if (step.is_charger) {
            tr = document.createElement("tr");
            var td = document.createElement("td");
            td.className = "drivelabel";
            var text = document.createTextNode("Charge to");
            td.appendChild(text);
            tr.appendChild(td);
            td = document.createElement("td");
            td.className = "drivetext";
            var text = document.createTextNode(step.departure_perc+"% in "+secondsToTimeStr(step.charge_duration));
            td.appendChild(text);
            tr.appendChild(td);
            table.appendChild(tr);
          }
          
          tr = document.createElement("tr");
          td = document.createElement("td");
          td.className = "drivelabel";
          text = document.createTextNode("Remaining");
          td.appendChild(text);
          tr.appendChild(td);
          td = document.createElement("td");
          td.className = "drivetext";
          var s = secondsToTimeStr(step.departure_duration);
          if (step.is_charger) {
            s += " after charging";
          }
          if (units == "metric") {
            s += ", " + Math.round(step.departure_dist/1000.0)+" km";
          } else {
            s += ", " + Math.round(step.departure_dist/1000.0/1.609)+" miles";
          }
          text = document.createTextNode(s);
          td.appendChild(text);
          tr.appendChild(td);
          table.appendChild(tr);
          
          if (step.is_charger && car_arrival_time_at_wp) {
            tr = document.createElement("tr");
            td = document.createElement("td");
            td.className = "drivelabel";
            text = document.createTextNode("Arrive at");
            td.appendChild(text);
            tr.appendChild(td);
            td = document.createElement("td");
            td.className = "drivetext";
            
            text = document.createTextNode(secondsToTimeStr(car_arrival_time_at_wp+step.departure_duration+step.charge_duration));
            td.appendChild(text);
            tr.appendChild(td);
            table.appendChild(tr);
          }
          
          drivediv.appendChild(table);
        } else {
          hideDriving();
        }
      }
      if (!car_on_route) {
        hideDriving();
        
        if ((is_car_browser || is_car_active) && !planning_ongoing && !planchanged) {
          var dest = getDestList(false);
          if (dest[0][0] == "") { 
            // Navigate from "My Position"
            if (!asked_for_replanning) {
              asked_for_replanning = true;
              openInputDialog("You have left the route - Replan?", null, "message", function (yes) { if (yes) { replan(); } }, "Yes", "No", 20000, true);
            }
          }
        }
      } else {
        off_route_samples = 0;
      }
    } else if (locationinfo != null && (is_car_browser || is_car_active)) {
      var div = document.getElementById("replandiv");
      replandiv.style.display = "none";
      if (car_charge_profile_soc_perc.length > 0) {
        showDriving();
        setDriveDisplayGraph(true);
        updateDriveGraph(null, null, null, null, false);
      } else {
        setDriveDisplayGraph(false); // No graph data available
        showDriving();
      } 
      if ("name" in locationinfo) {
        var drivediv = document.getElementById("drive-div");
        while (drivediv.firstChild) {
          drivediv.removeChild(drivediv.firstChild);
        }
        
        var table = document.createElement("table");
        table.className = "drivetable";
        
        var speedlimit = null;
        var region = null;
        if ("speedlimit" in locationinfo) {
          speedlimit = locationinfo.speedlimit;
        }
        if ("region" in locationinfo) {
          region = locationinfo.region;
        }
        var wayname = locationinfo.name;
        tr = document.createElement("tr");
        var td = document.createElement("td");
        td.className = "drivelabel";
        var text = document.createTextNode("Location");
        td.appendChild(text);
        tr.appendChild(td);
        td = document.createElement("td");
        td.className = "drivetext";
        if (wayname.length == 0) {
          wayname = "Unknown name"
        }
        var text = document.createTextNode(wayname);
        td.appendChild(text);
        tr.appendChild(td);
        table.appendChild(tr);
        
        tr = document.createElement("tr");
        var td = document.createElement("td");
        td.className = "drivelabel";
        var text = document.createTextNode("Elevation");
        td.appendChild(text);
        tr.appendChild(td);
        td = document.createElement("td");
        td.className = "drivetext";
        var text;
        elevation = locationinfo.elevation;
        if (units == "metric") {
          text = document.createTextNode(Math.round(elevation)+" m");
        } else {
          text = document.createTextNode(Math.round(elevation/0.3048)+" ft");
        }
        td.appendChild(text);
        tr.appendChild(td);
        table.appendChild(tr);

        if (calibrate_consump != null) {
          tr = document.createElement("tr");
          var td = document.createElement("td");
          td.className = "drivelabel";
          var text = document.createTextNode("Estimated Ref Consumption");
          td.appendChild(text);
          tr.appendChild(td);
          td = document.createElement("td");
          td.className = "drivetext";
          var text;
          elevation = locationinfo.elevation;
          if (units == "metric") {
            text = document.createTextNode(getConsText(calibrate_consump) + " @ 110 km/h");
          } else {
            text = document.createTextNode(getConsText(calibrate_consump) + " @ 65 mph");
          }
          td.appendChild(text);
          tr.appendChild(td);
          table.appendChild(tr);
        }


        if (car_charge_power) {
          tr = document.createElement("tr");
          var td = document.createElement("td");
          td.className = "drivelabel";
          var text = document.createTextNode("Charging power");
          td.appendChild(text);
          tr.appendChild(td);
          td = document.createElement("td");
          td.className = "drivetext";
          var text;
          text = document.createTextNode(car_charge_power+" kW");
          td.appendChild(text);
          tr.appendChild(td);
          table.appendChild(tr);
          
          tr = document.createElement("tr");
          var td = document.createElement("td");
          td.className = "drivelabel";
          var text = document.createTextNode("Charge");
          td.appendChild(text);
          tr.appendChild(td);
          td = document.createElement("td");
          td.className = "drivetext";
          var text;
          text = document.createTextNode(Math.round(car_soc_perc)+"%");
          td.appendChild(text);
          tr.appendChild(td);
          table.appendChild(tr);
        }
        
        drivediv.appendChild(table);
        
        showSpeedLimit(speedlimit, region);
      }
      else if ("carmodel" in locationinfo) {
        //This is a data packet from an OBD reader, populate with some OBD data.
        //{"utc": 1546808143.588054, "carmodel": "chevy:bolt:17:60:other", "pwr": "-0.029495", "temp": "--", "car_soc_perc": "81.56863", "lon": "-95.02276012", "is_charging": 1, "car_charger_power": "-0.029495", "car_speed": "0.0", "lat": "29.57382699", "dt": 1.1273479461669922}
        
        var drivediv = document.getElementById("drive-div");
        var data = locationinfo;
        while (drivediv.firstChild) {
          drivediv.removeChild(drivediv.firstChild);
        }
        
        var table = document.createElement("table");
        table.className = "drivetable";
        var tr = document.createElement("tr");
        if ("car_soc_perc" in data && data["car_soc_perc"] != "--") {
          var td = document.createElement("td");
          td.className = "drivetext";
          // If available, Actual charge telemetry field
          td = document.createElement("td");
          var div = document.createElement("div");
          var html = '<div class="driveheader">Charge  </div><span class="drivetext">';
          html += Math.round(car_soc_perc);
          html += '</span> <span class="driveunits">%</span>';
          div.innerHTML = html;
          td.appendChild(div);
          tr.appendChild(td);
        }
        if ("temp" in data && data["temp"] != "--") {
          tr.appendChild(td);
          td = document.createElement("td");
          td.className = "drivetext";
          // If available, Actual charge telemetry field
          td = document.createElement("td");
          var div = document.createElement("div");
          var html = '<div class="driveheader">Ext. Temp  </div><span class="drivetext">';
          if (units == "imperial") {
            html += Math.round((data["temp"])*1.8 + 32);
            html += '</span> <span class="driveunits">°F</span>';
          } else {
            html += roundToPlace(data["temp"],1);
            html += '</span> <span class="driveunits">°C</span>';
          }
          div.innerHTML = html;
          td.appendChild(div);
          tr.appendChild(td);
        }
        if ("car_speed" in data && data["car_speed"] != "--") {
          tr.appendChild(td);
          td = document.createElement("td");
          td.className = "drivetext";
          // If available, Actual charge telemetry field
          td = document.createElement("td");
          var div = document.createElement("div");
          var html = '<div class="driveheader">Speed  </div><span class="drivetext">';
          if (units == "imperial") {
            html += Math.round(data["car_speed"]/1.609);
            html += '</span> <span class="driveunits">mi/h</span>';
          } else {
            html += Math.round(data["car_speed"]);
            html += '</span> <span class="driveunits">km/h</span>';
          }
          div.innerHTML = html;
          td.appendChild(div);
          tr.appendChild(td);
        }
        if ("pwr" in data && data["pwr"] != "--") {
          tr.appendChild(td);
          td = document.createElement("td");
          td.className = "drivetext";
          // If available, Actual charge telemetry field
          td = document.createElement("td");
          var div = document.createElement("div");
          var html = '<div class="driveheader">Power  </div><span class="drivetext">';
          html += Math.round(data["pwr"]/1.609);
          html += '</span> <span class="driveunits">kW</span>';
          div.innerHTML = html;
          td.appendChild(div);
          tr.appendChild(td);
        }
        table.appendChild(tr);

        if (calibrate_consump != null) {
          tr = document.createElement("tr");
          var td = document.createElement("td");
          td.className = "drivelabel";
          var text = document.createTextNode("Estimated Ref Consumption");
          td.appendChild(text);
          tr.appendChild(td);
          td = document.createElement("td");
          td.className = "drivetext";
          var text;
          elevation = locationinfo.elevation;
          if (units == "metric") {
            text = document.createTextNode(getConsText(calibrate_consump) + " @ 110 km/h");
          } else {
            text = document.createTextNode(getConsText(calibrate_consump) + " @ 65 mph");
          }
          td.appendChild(text);
          tr.appendChild(td);
          table.appendChild(tr);
        }
        drivediv.appendChild(table);
      }
    } else {
      hideDriving();
    }
    if (car_turn_idx < 0 && centermode && (!last_center_map || !is_car_browser || (new Date()).getTime() > last_center_map+10000)) {
      if (!last_center_latlon || calcDistance(carlatlon[0], carlatlon[1], last_center_latlon[0], last_center_latlon[1]) > 10) {
        // Only recenter if we have actually moved significantly
        if (bigmap) {
          if (use_old_mapbox) {
            bigmap.panTo(L.latLng(carlatlon[0], carlatlon[1]));
          } else {
            bigmap.setCenter([carlatlon[1], carlatlon[0]]);
          }
          last_center_map = (new Date().getTime());
          last_center_latlon = carlatlon;
        }
      }
    }
  }
  
  function replan() {
    asked_for_replanning = false;
    var wp_idx = getDestIdxFromStep(car_latest_wp_idx);
    if (wp_idx > 0) {
      var dest = getDestList(false);
      dest.splice(0, wp_idx, []);
      setVias(dest);
    }
    if (battery_manual_verified) {
      plan_next_soc_perc = battery_manual_last_display_soc;
    } else {
      plan_next_soc_perc = car_soc_perc;
    }
    onPlanButton(false);
  }
  
  function placeText(canvas, ctx, text, x, y, justify, drawedge) {
    var margin = 5;
    var tw = ctx.measureText(text).width;
    var cw = canvas.width;
    if (justify == "left") {
      // Do nothing
    } else if (justify == "right") {
      x = x-tw;
    } else {
      // Center
      x = x-tw*0.5;
    }
    if (x+tw+margin >= cw) {
      x = cw-tw-margin;
    }
    if (x <= margin) {
      x = margin;
    }
    ctx.textAlign = "start";
    ctx.fillText(text,x,y);
    if (drawedge) {
      ctx.strokeText(text,x,y);
    }
    return x;
  }
  
  function updateDriveGraph(step_idx, point_idx, next_idx, next_wp_idx, on_wp) {
    if ((is_car_browser || is_car_active) && drivedisplaymode != "graph" && drivedisplaymode.indexOf("both") < 0) {
      return;
    }
    var t = (new Date()).getTime();
    if ((is_car_browser) && !debug && lastupdatedrivegraphtime != null && (t-lastupdatedrivegraphtime < 10000)) {
      return;
    }
    lastupdatedrivegraphtime = t;
    
    var last_step = null;
    var next_wp_step = null;
    var next_step = null;
    var charge_seconds = 0;
    var remaining_charge_seconds = 0;
    var next_charge_seconds = 0;
    var step_seconds = 0;
    var route_soc = [];
    
    if (step_idx != null) {
      if (on_wp && step_idx >= plan.routes[selrouteidx].steps.length-1) {
        // We are on the last WP, move back one step to keep the graph intact
        next_wp_idx = step_idx;
        next_idx = next_wp_idx;
        step_idx -= 1;
        point_idx = plan.routes[selrouteidx].steps[step_idx].route_soc.length-1;
      }
      last_step = plan.routes[selrouteidx].steps[step_idx];
      next_wp_step = plan.routes[selrouteidx].steps[next_wp_idx];
      next_step = plan.routes[selrouteidx].steps[next_idx];
      if (point_idx == null) {
        point_idx = 0;
      }
      if (last_step.is_charger && on_wp) {
        charge_seconds = last_step.charge_duration;
        if (car_charge_profile_time.length > 0) {
          var max_car_charge_profile = Math.max.apply(null, car_charge_profile_time);
          if (charge_seconds < max_car_charge_profile) {
            charge_seconds = max_car_charge_profile;
          }
        }
        remaining_charge_seconds = charge_seconds;
        for (var idx in last_step.charge_profile) {
          if (car_soc_perc < last_step.charge_profile[idx][0]) {
            break;
          }
          remaining_charge_seconds = charge_seconds-last_step.charge_profile[idx][1];
        }
      } else {
        if (next_step.is_charger && "charge_duration" in next_step && "charge_profile" in next_step) {
          next_charge_seconds = next_step.charge_duration;
        }
      }
      for (var idx=step_idx; idx < next_idx; idx++) {
        route_soc = route_soc.concat(plan.routes[selrouteidx].steps[idx].route_soc);
      }
      var point_data = point_data = route_soc[point_idx];
      var remain_wp_seconds = point_data[5]-Math.round(next_wp_step.arrival_duration)+charge_seconds;
      var remain_wp_km = point_data[6]-Math.round(next_wp_step.arrival_dist/1000);
      var remain_step_seconds = point_data[5]-route_soc[route_soc.length-1][5]+charge_seconds;
      var remain_step_km = point_data[6]-Math.round(next_step.arrival_dist/1000);
      step_seconds = last_step.departure_duration-route_soc[route_soc.length-1][5];
      var next_step_seconds = step_seconds;
    } else {
      if (car_charge_profile_time.length > 0) {
        var max_car_charge_profile = Math.max.apply(null, car_charge_profile_time);
        if (charge_seconds < max_car_charge_profile) {
          charge_seconds = max_car_charge_profile;
        }
      }
    }
    if (step_seconds + charge_seconds <= 0) {
      step_seconds = 1;
    }

    var canvas = document.getElementById("drive-canvas");
    // Set canvas height to whole window, check if width or height have changed.  Only update if changed.
    var width = 0;
    var height = 0;
    width = Math.round(screen.width - 40);
    if (mapmode == "map" && width > 790) {
      width = 790;
    }
    if (width < 500) {
      width = 500;
    }
    height = Math.round(width*290/790);
    if (canvas.width != width || canvas.height != height) {
      canvas.width = width;
      canvas.height = height;
    }
    var ctx = canvas.getContext("2d");
    clearCanvas(canvas);

    var graphleft = 20;
    var graphright = canvas.width - 20;
    var graphtop = 10+16;
    var graphbottom = canvas.height-(20+5);
    
    var px_per_second = (graphright-graphleft)/(step_seconds+charge_seconds+next_charge_seconds);
    var px_per_soc_perc = (graphbottom-graphtop)/100.0;
    var px_per_kw = (graphbottom-graphtop)/120.0;
    
    ctx.font = "24px sans-serif";
    
    // Graph frame
    ctx.globalAlpha = 1.0;
    ctx.lineWidth = 1;
    ctx.strokeStyle = "#ffffff";
    ctx.beginPath();
    ctx.moveTo(graphleft, graphbottom);
    ctx.lineTo(graphright, graphbottom);
    ctx.moveTo(graphleft, graphbottom);
    ctx.lineTo(graphleft, graphtop);
    ctx.stroke();
    
    // Elevation
    ctx.beginPath();
    ctx.fillStyle = "#a0a0a0";
    ctx.strokeStyle = "#a0a0a0";
    ctx.globalAlpha = 0.4;
    max_elev = -10000;
    min_elev = 10000;
    max_elev_seconds = 0;
    min_elev_seconds = 0;
    for (var idx=0; idx < route_soc.length; idx++) {
      var idx_point_data = route_soc[idx];
      var elev = idx_point_data[9];
      var remain_seconds = idx_point_data[5];
      var seconds = last_step.departure_duration - remain_seconds;
      if (elev > max_elev) {
        max_elev = elev;
        max_elev_seconds = seconds;
      }
      if (elev < min_elev) {
        min_elev = elev;
        min_elev_seconds = seconds;
      }
    }
    if (route_soc.length > 0) {
      if (max_elev == min_elev) {
        max_elev = min_elev+1;
      }
      ctx.moveTo(graphleft+charge_seconds*px_per_second, graphbottom);
      var elev = 0;
      var last_px = 0;
      for (var idx=0; idx < route_soc.length; idx++) {
        var idx_point_data = route_soc[idx];
        elev = idx_point_data[9];
        var remain_seconds = idx_point_data[5];
        var seconds = last_step.departure_duration - remain_seconds + charge_seconds;
        var px = seconds*px_per_second;
        if (px > last_px + 3) {
          ctx.lineTo(graphleft+px, graphbottom-(elev-min_elev)/(max_elev-min_elev)*(graphbottom-graphtop));
          last_px = px;
        }
      }
      ctx.lineTo(graphright-next_charge_seconds*px_per_second, graphbottom);
      ctx.closePath();
      ctx.fill();
      if (units == "metric") {
        placeText(canvas, ctx, Math.round(max_elev)+" m",graphleft+(max_elev_seconds+charge_seconds)*px_per_second,graphtop+20, "center", false);
        placeText(canvas, ctx, Math.round(min_elev)+" m",graphleft+(min_elev_seconds+charge_seconds)*px_per_second,graphbottom-3, "center", false);
      } else {
        placeText(canvas, ctx, Math.round(max_elev/0.3048)+" ft",graphleft+(max_elev_seconds+charge_seconds)*px_per_second,graphtop+20, "center", false);
        placeText(canvas, ctx, Math.round(min_elev/0.3048)+" ft",graphleft+(min_elev_seconds+charge_seconds)*px_per_second,graphbottom-3, "center", false);
      }
    }
    
    // Planned SoC
    ctx.globalAlpha = 1.0;
    ctx.lineWidth = 2;
    ctx.strokeStyle = "#a0a0a0";
    ctx.fillStyle = "#a0a0a0";
    
    if (last_step == null || (last_step.is_charger && on_wp)) {
      // Current charging
      if (last_step != null) {
        ctx.beginPath();
        ctx.moveTo(graphleft, graphbottom-px_per_soc_perc*last_step.charge_profile[0][0]);
        for (var idx=0; idx < last_step.charge_profile.length; idx++) {
          var ref_soc = last_step.charge_profile[idx][0];
          var seconds = last_step.charge_profile[idx][1];
          ctx.lineTo(graphleft+seconds*px_per_second, graphbottom-px_per_soc_perc*ref_soc);
        }
        ctx.lineTo(graphleft+charge_seconds*px_per_second, graphbottom-px_per_soc_perc*last_step.charge_profile[last_step.charge_profile.length-1][0]);
        ctx.stroke();
      }
      
      if (car_charge_profile_time.length > 0) {
        // Actual power profile
        ctx.beginPath();
        ctx.fillStyle = "#40ff40";
        ctx.strokeStyle = "#40ff40";
        ctx.globalAlpha = 0.4;
        ctx.moveTo(graphleft, graphbottom);
        var last_px = 0;
        var last_seconds = 0;
        var last_power = 0;
        for (var idx=0; idx < car_charge_profile_power.length; idx++) {
          var act_power = car_charge_profile_power[idx];
          var seconds = car_charge_profile_time[idx];
          last_seconds = seconds;
          last_power = act_power;
          ctx.lineTo(graphleft+seconds*px_per_second, graphbottom-px_per_kw*act_power);
          
        }
        ctx.lineTo(graphleft+last_seconds*px_per_second, graphbottom);
        ctx.closePath();
        ctx.fill();
        placeText(canvas, ctx, last_power+" kW", graphleft+(last_seconds)*px_per_second, graphbottom-px_per_kw*act_power, "left", false);
        
        // Actual SoC profile
        ctx.globalAlpha = 1.0;
        ctx.strokeStyle = "#28ff28";
        ctx.fillStyle = "#28ff28";
        ctx.shadowBlur=0;
        ctx.shadowColor="#ffffff";
        ctx.lineWidth = 2;
        ctx.beginPath();
        var last_soc_perc = 0;
        ctx.moveTo(graphleft, graphbottom-px_per_soc_perc*car_charge_profile_soc_perc[0]);
        for (var idx=0; idx < car_charge_profile_soc_perc.length; idx++) {
          var act_soc = car_charge_profile_soc_perc[idx];
          last_soc_perc = act_soc;
          var seconds = car_charge_profile_time[idx];
          ctx.lineTo(graphleft+seconds*px_per_second, graphbottom-px_per_soc_perc*act_soc);
        }
        ctx.stroke();
      }
      
      if (last_step != null) {
        // Line at end of charging
        ctx.beginPath();
        ctx.lineWidth = 1;
        ctx.shadowBlur=0;
        ctx.strokeStyle = "#ffffff";
        ctx.fillStyle = "#ffffff";
        ctx.moveTo(graphleft+(charge_seconds)*px_per_second, graphtop);
        ctx.lineTo(graphleft+(charge_seconds)*px_per_second, graphbottom+4);
        ctx.stroke();
        
        var textx = placeText(canvas, ctx, last_step.name.split(",")[0], graphleft+charge_seconds*0.5*px_per_second, graphbottom+5+16, "center", false);
        var chargerimg = chrg.charger_overlay_icon(last_step.charger_type, false);
        ctx.drawImage(chargerimg, textx-20,  graphbottom+5, chrg.olw, chrg.olh);
        var seconds_left = remaining_charge_seconds;
        if (seconds_left > 30) {
          placeText(canvas, ctx, secondsToTimeStr(seconds_left), graphleft+(charge_seconds-seconds_left*0.5)*px_per_second, graphbottom-5, "center", false);
        }
        
        // Clock for end of current charging
        var d = new Date((new Date).getTime() + seconds_left*1000);
        var atstr = secondsToTimeStr((d.getUTCHours()*60+d.getUTCMinutes())*60 + last_step.utc_offset);
        placeText(canvas, ctx, atstr, graphleft+charge_seconds*px_per_second, graphtop-5, "center", false);
      }
    }
    
    if (route_soc.length > 0) {
      ctx.strokeStyle = "#a0a0a0";
      ctx.fillStyle = "#a0a0a0";
      ctx.beginPath();
      ctx.moveTo(graphleft+charge_seconds*px_per_second, graphbottom-px_per_soc_perc*route_soc[0][2]);
      var last_px = 0;
      for (var idx=0; idx < route_soc.length; idx++) {
        var idx_point_data = route_soc[idx];
        var ref_soc = idx_point_data[2];
        var remain_seconds = idx_point_data[5];
        var seconds = last_step.departure_duration - remain_seconds;
        var px = (seconds+charge_seconds)*px_per_second;
        if (px > last_px + 1) {
          ctx.lineTo(graphleft+px, graphbottom-px_per_soc_perc*ref_soc);
          last_px = px;
        }
      }
      ctx.stroke();
      var seconds = last_step.departure_duration - point_data[5];
      var ref_soc = point_data[2];
      placeText(canvas, ctx, Math.round(ref_soc)+"%",graphleft+(seconds+charge_seconds)*px_per_second+5,graphbottom-px_per_soc_perc*ref_soc-3, "left", false);
    }
    
    if (next_step != null && next_step.is_charger && next_charge_seconds > 0 && next_step.charge_profile) {
      // Planned charging
      ctx.moveTo(graphleft+(next_step_seconds+charge_seconds)*px_per_second, graphbottom-px_per_soc_perc*next_step.charge_profile[0][0]);
      for (var idx=0; idx < next_step.charge_profile.length; idx++) {
        var ref_soc = next_step.charge_profile[idx][0];
        var seconds = next_step.charge_profile[idx][1];
        ctx.lineTo(graphleft+(next_step_seconds+seconds+charge_seconds)*px_per_second, graphbottom-px_per_soc_perc*ref_soc);
      }
      ctx.stroke();
    }
    
    // Actual SoC
    if ((car_soc_perc || battery_manual_verified) && last_step != null && (is_car_browser || is_car_active)) {
      ctx.beginPath();
      ctx.strokeStyle = "#28ff28";
      ctx.shadowBlur=0;
      ctx.shadowColor="#ffffff";
      ctx.lineWidth = 2;
      var firstpoint = true;
      var last_px = 0;
      for (var idx=0; idx < route_soc.length; idx++) {
        var idx_point_data = route_soc[idx];
        if (idx_point_data.length > 11) {
          var actual_soc = idx_point_data[11];
          var remain_seconds = idx_point_data[5];
          var seconds = last_step.departure_duration - remain_seconds;
          var px = (seconds+charge_seconds)*px_per_second;
          if (px > last_px + 1) {
            ctx.lineTo(graphleft+px, graphbottom-px_per_soc_perc*actual_soc);
            last_px = px;
          }
        }
      }
      ctx.stroke();
      
      
      var seconds = last_step.departure_duration - point_data[5];
      ctx.strokeStyle = "#ffffff";
      ctx.fillStyle = "#28ff28";
      ctx.lineWidth = 1;
      ctx.shadowBlur = 0;
      
      var soc_perc = null;
      if (car_soc_perc) {
        soc_perc = car_soc_perc;
      } else if (battery_manual_verified) {
        soc_perc = battery_manual_last_display_soc;
      }
      if (soc_perc != null) {
        placeText(canvas, ctx, Math.round(soc_perc)+"%",graphleft+(seconds+charge_seconds-remaining_charge_seconds)*px_per_second-5,graphbottom-px_per_soc_perc*soc_perc+3+20, "right", false);
      }
    }
    
    if (last_step == null) {
      return;
    }
    
    // Current position
    ctx.beginPath();
    var seconds = 0;
    if (on_wp && last_step.is_charger) {
      seconds = last_step.charge_profile[point_idx][1];
      if (car_charge_profile_time.length > 0 && car_charge_profile_time[car_charge_profile_time.length-1] > seconds) {
        seconds = car_charge_profile_time[car_charge_profile_time.length-1];
      }
    } else {
      seconds = last_step.departure_duration - point_data[5] + charge_seconds;
    }
    ctx.beginPath();
    ctx.lineWidth = 2;
    // ctx.shadowBlur=5;
    // ctx.shadowColor="#ffffff";
    // ctx.strokeStyle = "#0000ff";
    ctx.strokeStyle = "#28ff28"
    ctx.moveTo(graphleft+seconds*px_per_second, graphtop);
    ctx.lineTo(graphleft+seconds*px_per_second, graphbottom+4);
    ctx.stroke();
    
    // Clock for next step
    ctx.shadowBlur=0;
    ctx.fillStyle = "#ffffff";
    var d = new Date((new Date).getTime() + (next_step_seconds+charge_seconds-seconds)*1000);
    var atstr = secondsToTimeStr((d.getUTCHours()*60+d.getUTCMinutes())*60 + next_step.utc_offset);
    placeText(canvas, ctx, atstr, graphleft+(next_step_seconds+charge_seconds)*px_per_second, graphtop-5, "center", false);
    
    var secondsleft = point_data[5]-route_soc[route_soc.length-1][5];
    var kmleft = point_data[6]-route_soc[route_soc.length-1][6];
    var text = "";
    if (units == "metric") {
      text = secondsToTimeStr(secondsleft)+", "+kmleft+" km";;
    } else {
      text = secondsToTimeStr(secondsleft)+", "+Math.round(kmleft/1.609)+" miles";
      
    }
    placeText(canvas, ctx, text, (graphleft+(next_step_seconds-secondsleft*0.5+charge_seconds)*px_per_second), graphbottom-5, "center", false);
    
    // Next step position
    ctx.beginPath();
    ctx.lineWidth = 1;
    ctx.strokeStyle = "#ffffff";
    ctx.fillStyle = "#ffffff";
    ctx.moveTo(graphleft+(next_step_seconds+charge_seconds)*px_per_second, graphtop);
    ctx.lineTo(graphleft+(next_step_seconds+charge_seconds)*px_per_second, graphbottom+4);
    ctx.stroke();
    if (next_step.is_charger && next_charge_seconds > 0) {
      ctx.beginPath();
      ctx.moveTo(graphleft+(next_step_seconds+next_step.charge_duration+charge_seconds)*px_per_second, graphtop);
      ctx.lineTo(graphleft+(next_step_seconds+next_step.charge_duration+charge_seconds)*px_per_second, graphbottom+2);
      ctx.stroke();
      var textx = placeText(canvas, ctx, next_step.name.split(",")[0], graphleft+(next_step_seconds+next_step.charge_duration*0.5+charge_seconds)*px_per_second, graphbottom+5+16, "center", false);
      placeText(canvas, ctx, secondsToTimeStr(next_step.charge_duration), graphleft+(next_step_seconds+next_step.charge_duration*0.5+charge_seconds)*px_per_second, graphbottom-5, "center", false);
    } else {
      var textx = placeText(canvas, ctx, next_step.name.split(",")[0], graphleft+(next_step_seconds+charge_seconds)*px_per_second, graphbottom+5+16, "center");
    }
    if (next_step.is_charger) {
      var chargerimg = chrg.charger_overlay_icon(next_step.charger_type, false);
      ctx.drawImage(chargerimg, textx-20,  graphbottom+5, chrg.olw, chrg.olh);
    }
  }
  
  
  function showSpeedLimit(speedlimit, region) {
    var div = document.getElementById("speedlimitoverlay");
    if (speedlimit == null) {
      div.style.display = "none";
    } else {
      div.style.display = "";
      div = document.getElementById("speedlimitdiv");
      while (div.firstChild) {
        div.removeChild(div.firstChild);
      }
      var img_eu = document.getElementById("speedlimitsign_eu");
      var img_us = document.getElementById("speedlimitsign_us");
      if (region == "northamerica") {
        img_eu.style.display = "none";
        img_us.style.display = "inline-block";
        div.className = "speedlimittext-us";
      } else {
        img_eu.style.display = "inline-block";
        img_us.style.display = "none";
        div.className = "speedlimittext";
      }

      if ((typeof speedlimit) == "string") {
        text = document.createTextNode(speedlimit);
      } else {
        if (units == "metric") {
          text = document.createTextNode(Math.round(speedlimit));
        } else {
          text = document.createTextNode(Math.round(speedlimit/1.609));
        }
      }
      div.appendChild(text);
    }
  }
  
  function setShowDriving(show, effect_immediately) {
    show_driving = show;
    var graphbuttondiv = document.getElementById("graphbutton");
    if (show_driving) {
      if (effect_immediately) {
        graphbuttondiv.style.display = "none";
        showDriving();
      }
    } else {
      if (effect_immediately) {
        graphbuttondiv.style.display = "";
        hideDriving();
      }
    }
  }
  
  function showDriving() {
    if (show_driving && mapmode != "nomap") {
      var drivecenterdiv = document.getElementById("drive-center-div");
      drivecenterdiv.style.display = "block";
    }
  }
  
  function hideDriving() {
    if (mapmode != "nomap") {
      var drivecenterdiv = document.getElementById("drive-center-div");
      drivecenterdiv.style.display = "none";
      var dircenterdiv = document.getElementById("directions-center-div");
      dircenterdiv.style.display = "none";
      var div = document.getElementById("speedlimitoverlay");
      div.style.display = "none";
      showBattery(false);
    }
  }
  
  function showBattery(show) {
    var div = document.getElementById("batterydisplayoverlay");
    if (show) {
      div.style.display = "block";
    } else {
      div.style.display = "none";          
    }
  }
  
  function setBattery(soc, verified) {
    if (soc != battery_manual_last_display_soc) {
      battery_manual_display_verified = false;  
    }
    if (verified) {
      battery_manual_display_verified = true;
    }
    var div = document.getElementById("batterytext");
    while (div.firstChild) {
      div.removeChild(div.firstChild);
    }
    var text = document.createTextNode(Math.round(soc)+"%");
    div.appendChild(text);
    
    div = document.getElementById("batterylabel");
    while (div.firstChild) {
      div.removeChild(div.firstChild);
    }
    if (battery_manual_display_verified) {
      text = document.createTextNode("Actual SoC");
    } else {
      text = document.createTextNode("Estimated SoC");      
    }
    div.appendChild(text);

    var bar = document.getElementById("batteryfill");
    bar.style.width = Math.round(soc)+"%";
    battery_manual_last_display_soc = soc;
  }
  
  function onBatteryManualChange(change) {
    var now = (new Date()).getTime();
    var div = document.getElementById("batterydisplayoverlay");
    var bar = document.getElementById("batteryfill");
    battery_manual_offset_soc += change;
    setBattery(battery_manual_last_display_soc + change, true);
    battery_manual_verified = true;
    if (battery_manual_last_change == null || now-battery_manual_last_change > 5000) {
      battery_manual_last_offset_soc = battery_manual_present_offset_soc;
      battery_manual_last_step_idx = battery_manual_present_step_idx;
      battery_manual_last_point_idx = battery_manual_present_point_idx;
    } 
    battery_manual_present_offset_soc = battery_manual_offset_soc;
    battery_manual_present_step_idx = car_step_idx;
    battery_manual_present_point_idx = car_point_idx;
    interpolateBatteryRoute(battery_manual_last_step_idx, battery_manual_last_point_idx, battery_manual_last_offset_soc, 
                            car_step_idx, car_point_idx, battery_manual_offset_soc);
    battery_manual_last_change = now;
    driveLoggingSetBattery(battery_manual_last_display_soc);
  }

  function interpolateBatteryRoute(from_step_idx, from_point_idx, from_offset, to_step_idx, to_point_idx, to_offset) {
    if (plan == null || selrouteidx < 0 || from_step_idx == null || from_point_idx == null || to_step_idx == null || to_point_idx == null) {
      return;
    }
    if (!("route_soc" in plan.routes[selrouteidx].steps[to_step_idx]) || to_point_idx >= plan.routes[selrouteidx].steps[to_step_idx].route_soc.length) {
      to_step_idx = plan.routes[selrouteidx].steps.length-2;
      to_point_idx = plan.routes[selrouteidx].steps[to_step_idx].route_soc.length-1;
    }
    var from_point_data = plan.routes[selrouteidx].steps[from_step_idx].route_soc[from_point_idx];
    var to_point_data = plan.routes[selrouteidx].steps[to_step_idx].route_soc[to_point_idx];
    var from_to_dur = from_point_data[5] - to_point_data[5];

    var step_idx = from_step_idx;
    var point_idx = from_point_idx;
    while ((step_idx < to_step_idx) || (step_idx == to_step_idx && point_idx < to_point_idx)) {
      var point_data = plan.routes[selrouteidx].steps[step_idx].route_soc[point_idx];
      var ref_soc = point_data[2];
      var from_time = from_point_data[5] - point_data[5];
      var interp_soc_perc = ref_soc + from_offset + from_time/from_to_dur*(to_offset-from_offset);  // Linearly interpolate offset over time
      if (point_data.length > 11) {
        point_data[11] = interp_soc_perc;
      } else {
        point_data.push(interp_soc_perc);
      }

      point_idx += 1;
      if (point_idx >= plan.routes[selrouteidx].steps[step_idx].route_soc.length) {
        point_idx = 0;
        step_idx += 1;
      }
    }
    updateMap();
  }
  
  function projectLatLon(reflat, reflon, coordlist) {
    var xy = [];
    for (var idx=0; idx < coordlist.length; idx++) {
      var x = ((coordlist[idx][1]-reflon)/360.0)*Math.cos(reflat/180.0*Math.PI)*40000.0e3;
      var y = ((coordlist[idx][0]-reflat)/360.0)*40000.0e3;
      xy.push([x,y]);
    }
    return xy;
  }
  
  function rotateXY(xy, angle) {
    var xyrot = [];
    for (var idx=0; idx < xy.length; idx++) {
      var x = Math.cos(angle/180.0*Math.PI)*xy[idx][0] + Math.sin(angle/180.0*Math.PI)*xy[idx][1];
      var y = -Math.sin(angle/180.0*Math.PI)*xy[idx][0] + Math.cos(angle/180.0*Math.PI)*xy[idx][1];
      xyrot.push([x,y]);
    }
    return xyrot;
  }
  
  function fir(xy, idx, filt) {
    var x = 0.0;
    var y = 0.0;
    var w = 0.0;
    for (var fidx=0; fidx < filt.length; fidx++) {
      var n = Math.floor(idx+fidx-(filt.length-1)/2);
      if (n >= 0 && n < xy.length) {
        x += xy[n][0]*filt[fidx];
        y += xy[n][1]*filt[fidx];
        w += filt[fidx];
      }
    }
    if (w > 0.0) {
      x /= w;
      y /= w;
    }
    return [x,y];
  }
  
  function filterXY(xy) {
    var xyfilt = [];
    var filt1 = [ 0.5, 1.0, 0.5, 0.0];
    var filt2 = [ 0.2, 0.8, 0.8, 0.2 ];
    for (var idx=0; idx < xy.length; idx++) {
      xyfilt.push(fir(xy, idx, filt1));
      xyfilt.push(fir(xy, idx, filt2));
    }
    return xyfilt;
  }
  
  function drawArrow(xy, xyidx, instridx, size) {
    var dx = xy[xy.length-1][0]-xy[instridx][0];
    var dy = xy[xy.length-1][1]-xy[instridx][1];
    var len = Math.sqrt(dx*dx+dy*dy);
    dx = dx/len*size;
    dy = dy/len*size;
    var tx = dy;
    var ty = -dx;
    var x = xy[xyidx][0];
    var y = xy[xyidx][1];
    var arrow = [ [x,y], [x-dx+tx,y-dy+ty], [x-dx+0.5*tx,y-dy+0.5*ty], [x-3*dx+0.5*tx,y-3*dy+0.5*ty],
    [x-3*dx-0.5*tx,y-3*dy-0.5*ty], [x-dx-0.5*tx,y-dy-0.5*ty], [x-dx-tx,y-dy-ty] ];
    return arrow;
  }
  
  function makeStrokePath(xy, width) {
    var tang = [1.0, 0.0];
    var points = [];
    for (var idx=0; idx < xy.length; idx++) {
      x = xy[idx][0]+tang[0]*width;
      y = xy[idx][1]+tang[1]*width;
      points.push([x,y]);
      x = xy[idx][0]-tang[0]*width;
      y = xy[idx][1]-tang[1]*width;
      points.splice(0, 0, [x,y]);
      
      if (idx < xy.length-1) {
        var dx = xy[idx+1][0]-xy[idx][0];
        var dy = xy[idx+1][1]-xy[idx][1];
        var len = Math.sqrt(dx*dx+dy*dy);
        var newtang = [dy/len, -dx/len];
        if (-tang[1]*newtang[0]+tang[0]*newtang[1] < 0) { // Bend right
          x = xy[idx][0]-newtang[0]*width;
          y = xy[idx][1]-newtang[1]*width;
          points.splice(0, 0, [x,y]);
        } else {
          x = xy[idx][0]+newtang[0]*width;
          y = xy[idx][1]+newtang[1]*width;
          points.push([x,y]);
        }
        tang = newtang;
      }
    }
    return points;
  }
  
  function clearCanvas(canvas) {
    var ctx =  canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }
  
  function project3D(canvas, xy, z, foclen, scale) {
    var proj = [];
    for (var idx=0; idx < xy.length; idx++) {
      if (xy[idx][1]+foclen > 0.1) {
        var x = xy[idx][0]/(xy[idx][1]+foclen)*scale + canvas.width/2;
        var y = -z/(xy[idx][1]+foclen)*scale + canvas.height/2;
        proj.push([x,y]);
      }
    }
    return proj;
  }
  
  function drawArea(canvas, proj, color) {
    var ctx =  canvas.getContext('2d');
    ctx.fillStyle = color;
    ctx.beginPath();
    var first = true;
    for (var idx=0; idx < proj.length; idx++) {
      if (first) {
        ctx.moveTo(proj[idx][0],proj[idx][1]);
        first = false;
      } else {
        ctx.lineTo(proj[idx][0],proj[idx][1]);
      }
    }
    ctx.closePath();
    ctx.fill();
  }
  
  function calcDistance(lat1, lon1, lat2, lon2) {
    var k = Math.PI/180.0;
    return 6371000.0*2.0*Math.asin(Math.sqrt(Math.pow(Math.sin((lat1-lat2)*k/2.0),2.0) + Math.cos(lat1*k)*Math.cos(lat2*k)*Math.pow(Math.sin((lon2-lon1)*k/2.0),2.0)))
  }
  
  function latLon(lat, lon) {
    return [lat, lon];
  }
  
  function onMapIdle() {
    var latlng = bigmap.getCenter();
    setStorageValue("mapcenter", [latlng.lat, latlng.lng]);

    setTimeout(chrg.refreshChargers(getFastChargerTypes(),bigmap),100);
  }

  function onMapZoom() {
    setStorageValue("mapzoom", bigmap.getZoom());
    onMapIdle();
  }
  
  function getFastChargerTypes() {
    var types = [];
    var form = document.getElementById('plan-form');
    if (form.elements["SC"].checked)        { types.push("SC"); }
    if (form.elements["tesla_ccs"].checked)       { types.push("tesla_ccs"); }
    if (form.elements["ccs"].checked)       { types.push("ccs"); }
    if (form.elements["chademo"].checked)   { types.push("chademo"); }
    if (types.length == 0) {
      var car_model = findCarModel(getCarModel());
      if (car_model) {
        types = car_model.rec_fast_chargers.split(",")
      }
    }
    return types.join(",");
  }
  
  function isServerSetting(key) {
    return (key != "mytesla_token" && key != "mytesla_refresh_token" && key != "mytesla_vid" && key != "mytesla_next_refresh" &&
    key != "session_id" && key != "login" && key != "destplugs" &&
    key != "pushbullet_token" && key != "pushbullet_verified" && key != "nightmode" &&
    key != "navmode" && key != "centermode" && key != "drivedisplaymode" && key != "show_driving" && key != "OBD_user" && key != "mapmode");
  }
  
  function getDefaultStorageValue(key, def) {
    var res = null;
    if (typeof(Storage) !== "undefined") {
      if (localStorage.getItem(key) != null) {
        try {
          res = JSON.parse(localStorage.getItem(key));
        }
        catch (err) {
        }
      }
    }
    if (isServerSetting(key) && server_settings && key in server_settings) {
      res = server_settings[key];
    }
    
    if (url_settings != null && key in url_settings) {
      res = url_settings[key];
      delete url_settings[key];
      setStorageValue(key, res); // Make sure to override server settings
    }
    if (res == null || typeof(res) === "undefined") {
      res = def;
    }
    return res;
  }
  
  function setStorageValue(key, value) {
    if (typeof(Storage) !== "undefined") {
      localStorage.setItem(key, JSON.stringify(value));
    }
    if (isServerSetting(key) && gdpr_cookies_ok) {
      if (server_settings == null) {
        server_settings = {};
      }
      server_settings[key] = value;
    } else {
      if (key in server_settings) {
        delete server_settings[key];
      }
    }
  }

  function setStorageValueLocal(key, value) {
    if (typeof(Storage) !== "undefined") {
      try {
        localStorage.setItem(key, JSON.stringify(value));
      } 
      catch (err)  {
        // Probably too large to store, ignore
      }
    }
  }
  

  function convertURLSettingToServer(key, val) {
    var settingskey = key;
    params = {};
    if (key == "initial_soc") {
      settingskey = "initialcharge";
    } else if (key == "arrival_soc") {
      settingskey = "arrivalcharge";
    } else if (key == "charger_soc") {
      settingskey = "chargercharge";
    } else if (key == "speed_factor") {
      settingskey = "speedoverlimit";
    } else if (key == "round_trip") {
      settingskey = "round_trip"
    } else if (key == "charge_overhead") {
      settingskey = "chargeoverhead"
    }else if (key == "typ_consumption") {
      settingskey = "consumption";
      if (units == "imperial") {
        val = Math.round(val*1.609*0.96);
      } else {
        val = Math.round(val);
      }
      if (cons_units == "distance_per_energy") {
        val = convertConsUnits(val);
      }
    } else if (key == "max_speed") {
      if (units == "metric") {
        val = Math.round(val*3.6);
      } else {
        val = Math.round(val*3.6/1.609);
      }
    } else if (key == "outside_temp") {
      if (units == "imperial") {
        val = Math.round(val*1.8+32);
      }
    } else if (key == "wind_speed") {
      if (units == "imperial") {
        val = Math.round(val*3.6/1.609);
      }
    } else if (key == "extra_weight") {
      if (units == "imperial") {
        val = Math.round(val/0.45);
      }
    } else if (key == "allow_ferry") {
      settingskey = "avoid_ferries";
      val = !val;
    } else if (key == "allow_toll") {
      settingskey = "avoid_tolls";
      val = !val;
    } else if (key == "allow_motorway") {
      settingskey = "avoid_motorways";
      val = !val;
    } else if (key == "destinations") {
      deststrs = val.split("|");
      val = [];
      for (var destidx in deststrs) {
        var destparts = deststrs[destidx].split(";");
        if (destparts.length >= 2 && destparts[1] == "") {
          destparts[1] = null;
        }
        if (destparts.length >= 3 && destparts[2] == "") {
          destparts[2] = null;
        }
        val.push(destparts);
      }
    } else if (key == "exclude_wps" || key == "longbreak_wps") {
      idstrs = val.split("|");
      val = [];
      for (var ididx in idstrs) {
        var parts = idstrs[ididx].split(":");
        if (parts.length > 1) {
          val.push(Number(parts[1]));
        }
      }
    } else if (key == "preferred_network_ids") {
      idstrs = val.split("|");
      val = [];
      for (var ididx in idstrs) {
          val.push(parseInt(idstrs[ididx]));
      }
    } else if (key == "fast_chargers") {
      fast_chargers = val.split("|");
      params["SC"] = (fast_chargers.indexOf("SC") >= 0);
      params["tesla_ccs"] = (fast_chargers.indexOf("tesla_ccs") >= 0);
      params["ccs"] = (fast_chargers.indexOf("ccs") >= 0);
      params["chademo"] = (fast_chargers.indexOf("chademo") >= 0);
    }
    if (settingskey) {
      params[settingskey] = val;
    }
    return params;
  }
  
  
  function loadSettings(urlquery) {
    setUnits(getDefaultStorageValue("units", "metric"));
    setConsUnits(getDefaultStorageValue("cons_units", "energy_per_distance"));
    
    url_settings = {};
    var load_mypos = false;
    var plan_uuid = null;
    if (urlquery.length > 0) {
      var keyvals = urlquery.split("&");
      for (var idx=0; idx < keyvals.length; idx++) {
        var keyval = keyvals[idx].split("=");
        if (keyval.length >= 2) {
          key = keyval[0];
          val = decodeURIComponent(keyval[1]);
          if (key == "access_token") {
            // This is a Pushbullet OAuth token
            url_settings["pushbullet_token"] = val;
            pushbullet_verified = false;
          } else if (key == "donation") {
            if (val == "yes") {
              donation = true;
            }
          } else if (key == "plan_uuid") {
            plan_uuid = val;
          } else if (key == "sharing_uuid") {
            sharing_uuid = val;
          } else if (key == "mypos") {
            load_mypos = true;
          }
        }
      }
    }

    var settingsurl = 'https://abetterrouteplanner.com/db_data.py/get_settings?session_id='+session_id;
    
    if (plan_uuid) {
      settingsurl = 'https://abetterrouteplanner.com/db_data.py/plan?plan_uuid='+plan_uuid;
      server_settings_ver = -1;
      setStorageValue("initial_car_model_selected", true); // When loading a plan, skip asking for the first car model
    }
    $.get({ url: settingsurl, dataType: "json" })
    .done(function(data) {
      if (plan_uuid) {
        console.log("Loading settings from plan: "+plan_uuid);
        for (var key in data) {
          var val = data[key];
          var res = convertURLSettingToServer(key, val);
          for (var settingskey in res) {
            val = res[settingskey];
            if (settingskey == "destinations" && load_mypos) {
              for (var idx in val) {
                if (val[idx][0] == null || val[idx][0].length == 0) {
                  var orig_dists = data.orig_destinations.split("|");
                  var parts = orig_dists[idx].split(",");
                  if (parts.length >= 2) {
                    val[idx][0] = "User position";
                    val[idx][6] = parts[0];
                    val[idx][7] = parts[1];
                  }
                }
              }
            }
            url_settings[settingskey] = val;
          }
        }
        loaded_plan_uuid = plan_uuid;
      } else if (data.status == "ok") {
        server_settings = data;
        loginemail = server_settings["login"];
        showABRPAccountActive(true);
      }
      setStorageValue("session_id", session_id);
      applySettings(plan_uuid);
    })
    .fail(function() {
      console.log('Get settings error.');
      server_settings = {};
      loginemail = null;
      applySettings(plan_uuid);
    });
  }

  function setBrowserURL(plan_uuid) {
    if (plan_uuid) {
      window.history.pushState("", "", "https://"+window.location.hostname+window.location.pathname+"?plan_uuid="+plan_uuid);
    } else {
      window.history.pushState("", "", "https://"+window.location.hostname+window.location.pathname);
    }
  }
  
  function applySettings(plan_uuid) {
    settings_applied = true;
    if (getDefaultStorageValue("settings_ver", 0) > server_settings_ver) {
      server_settings_ver = getDefaultStorageValue("settings_ver", 0);
      console.log("New settings found, applying.");
      var form = document.getElementById('plan-form');
      setUnits(getDefaultStorageValue("units", "metric"));
      setCarModel(getDefaultStorageValue("carmodel", "3long"));
      setCarModelFastChargerTypes(false);
      setConsUnits(getDefaultStorageValue("cons_units","energy_per_distance"));
      
      form.elements["initialcharge"].value = getDefaultStorageValue("initialcharge", 90);
      form.elements["arrivalcharge"].value = getDefaultStorageValue("arrivalcharge", 10);
      form.elements["chargercharge"].value = getDefaultStorageValue("chargercharge", 10);
      form.elements["maxcharge"].value = getDefaultStorageValue("maxcharge", 100);
      form.elements["chargeoverhead"].value = getDefaultStorageValue("chargeoverhead", 5);
      form.elements["speedoverlimit"].value = getDefaultStorageValue("speedoverlimit", 100);
      form.elements["max_speed"].value = getDefaultStorageValue("max_speed", 150);
      form.elements["consumption"].value = getDefaultStorageValue("consumption", 210);
      if (!form.elements["SC"].disabled) {
        form.elements["SC"].checked = getDefaultStorageValue("SC", true);
      }
      if (!form.elements["tesla_ccs"].disabled) {
        form.elements["tesla_ccs"].checked = getDefaultStorageValue("tesla_ccs", false);
      }
      if (!form.elements["ccs"].disabled) {
        form.elements["ccs"].checked = getDefaultStorageValue("ccs", false);
      }
      if (!form.elements["chademo"].disabled) {
        form.elements["chademo"].checked = getDefaultStorageValue("chademo", false);
      }
      form.elements["find_alts"].checked = getDefaultStorageValue("find_alts", false);
      setAvoidClasses(getDefaultStorageValue("avoid_ferries", false), getDefaultStorageValue("avoid_tolls", false), getDefaultStorageValue("avoid_motorways", false));
      form.elements["adjust_speed"].checked = getDefaultStorageValue("adjust_speed", true);
      form.elements["outsidetemp"].value = Math.round(getDefaultStorageValue("outside_temp", 20));
      form.elements["initbatterytemp"].value = getDefaultStorageValue("battery_temp", "");
      form.elements["windspeed"].value = getDefaultStorageValue("wind_speed", "0");
      console.log(getDefaultStorageValue("wind_dir", "head"));
      popupSetValueById("winddir", getDefaultStorageValue("wind_dir", "head"));
      popupSetValueById("roadcondition", getDefaultStorageValue("road_condition", "normal"));
      form.elements["extra_weight"].value = getDefaultStorageValue("extra_weight", 0);
      form.elements["battery_degradation"].value = getDefaultStorageValue("battery_degradation", 5);
      
      chrg.region = getDefaultStorageValue("plug_region","eu");
      setPlugRegion(chrg.region);
      var dest_dict = getDefaultStorageValue("destplugs", null);
      if (dest_dict != null) {
        chrg.dest_dict = dest_dict;
        setPlugToggles();
      }
      
      // if (units == "metric") {
      //   document.getElementById("metricradio").checked = true;
      //   setUnits("metric");
      // } else {
      //   document.getElementById("imperialradio").checked = true;
      //   setUnits("imperial");
      // }
      // setConsUnits(cons_units);

      //Clear out the route before we modify it.  
      startCleanPlan();
      var dest = getDefaultStorageValue("destinations", []);
      if (typeof(dest) == "string") {
        var d = dest.split("|");
        dest = [];
        for (var idx=0; idx < d.length; idx++) {
          dest.push([d[idx]]);
        }
      }
      while (dest.length < 2) {
        dest.push([""]);
      }
      for (var destidx=0; destidx < dest.length; destidx++) {
        if (dest[destidx].length >= 2 && dest[destidx][1] == "") {
          dest[destidx][1] = null;
        }
        if (dest[destidx].length >= 3 && dest[destidx][2] == "") {
          dest[destidx][2] = null;
        }
        if (dest[destidx].length > 3 && (dest[destidx][3] == "")) {
          dest[destidx][3] = null;
        }
        if (dest[destidx].length > 4 && (dest[destidx][4] == "")) {
          dest[destidx][4] = null;
        }
        if (dest[destidx].length > 5 && (dest[destidx][5] == "")) {
          dest[destidx][5] = null;
        }
        if (dest[destidx].length > 6 && (dest[destidx][6] == "")) {
          dest[destidx][6] = null;
        }
        if (dest[destidx].length > 7 && (dest[destidx][7] == "")) {
          dest[destidx][7] = null;
        }
        if (dest[destidx].length > 8 && (dest[destidx][8] == "")) {
          dest[destidx][8] = null;
        }
        if (dest[destidx].length > 9 && (dest[destidx][9] == "")) {
          dest[destidx][9] = false;
        }
        if (dest[destidx].length > 10 && (dest[destidx][10] == "")) {
          dest[destidx][10] = null;
        }
      }
      
      car_range_per_perc = getDefaultStorageValue("car_range_per_perc", null);
      
      var history = getDefaultStorageValue("searchhistory", []);
      for (var idx=0; idx < history.length; idx++) {
        if ((typeof history[idx]) == "string") {
          history[idx] = {"title": history[idx]};
        }
        if (!("pinned" in history[idx])) {
          history[idx].pinned = false;
        }
        if (!("time" in history[idx])) {
          history[idx].time = 100-idx;
        }
      }
      setStorageValue("searchhistory", history);

      // Set round trip before destinations are loaded.
      round_trip = getDefaultStorageValue("round_trip",false);
      if (plan_uuid) {
        //If loading a saved plan, round trip isn't a plan setting.
        round_trip = false;
      }
      setDestList(dest);
      chrg.getExcludesAndBreaks();

      
      setNight(getDefaultStorageValue("nightmode", false));
      setNav(getDefaultStorageValue("navmode", false));
      setCenter(getDefaultStorageValue("centermode", false));
      setDriveDisplay(getDefaultStorageValue("drivedisplaymode", "graph"));
      setShowDriving(getDefaultStorageValue("show_driving", true), false);

      if (!plan_uuid) {
        plan = processPlan(getDefaultStorageValue("plan", null), getDestList(false));
      }

      var last_aboutver = getDefaultStorageValue("aboutversion", 0);
      console.log("About ver "+last_aboutver);
      if (last_aboutver < aboutversion) {
        openAbout();
      } else {
        about_shown = true;
      }
      if (donation) {
        openDonate();
      }
      setStorageValue("aboutversion", aboutversion);
      
      if (loaded_plan_uuid) { // Check that car models have been loaded too
        onPlanButton(false);
        loaded_plan_uuid = null;
      }
      chrg.refreshChargers(getFastChargerTypes(),bigmap);
      initializePostLoading();
    }
  }
  
  function saveSettings(server_save) {
    var form = document.getElementById('plan-form');
    setStorageValue("initialcharge", form.elements["initialcharge"].value);
    setStorageValue("arrivalcharge", form.elements["arrivalcharge"].value);
    setStorageValue("chargercharge", form.elements["chargercharge"].value);
    setStorageValue("maxcharge", form.elements["maxcharge"].value);
    setStorageValue("chargeoverhead", form.elements["chargeoverhead"].value);
    setStorageValue("speedoverlimit", form.elements["speedoverlimit"].value);
    setStorageValue("max_speed", form.elements["max_speed"].value);
    setStorageValue("consumption", form.elements["consumption"].value);
    setStorageValue("SC", form.elements["SC"].checked);
    setStorageValue("tesla_ccs", form.elements["tesla_ccs"].checked);
    setStorageValue("ccs", form.elements["ccs"].checked);
    setStorageValue("chademo", form.elements["chademo"].checked);
    setStorageValue("find_alts", form.elements["find_alts"].checked);
    avoidclasses = getAvoidClasses();
    setStorageValue("avoid_ferries", avoidclasses[0]);
    setStorageValue("avoid_tolls", avoidclasses[1]);
    setStorageValue("avoid_motorways", avoidclasses[2]);
    setStorageValue("adjust_speed", form.elements["adjust_speed"].checked);
    setStorageValue("carmodel", getCarModel());
    setStorageValue("outside_temp", form.elements["outsidetemp"].value);
    setStorageValue("battery_temp", form.elements["initbatterytemp"].value);
    setStorageValue("wind_speed", form.elements["windspeed"].value);
    setStorageValue("wind_dir", popupGetValueById("winddir"));
    setStorageValue("road_condition", popupGetValueById("roadcondition"));
    setStorageValue("extra_weight", form.elements["extra_weight"].value);
    setStorageValue("battery_degradation", form.elements["battery_degradation"].value);
    setStorageValue("units", units);
    setStorageValue("cons_units", cons_units);
    var dest = getDestList(false);
    setStorageValue("destinations", dest);
    setStorageValue("destplugs",chrg.dest_dict);
    setStorageValue("plug_region",chrg.region);
    setStorageValue("round_trip",round_trip);
    server_settings_ver += 1;
    setStorageValue("settings_ver", server_settings_ver);
    
    var destnopos = getDestList(false);
    var history = getDefaultStorageValue("searchhistory", []);
    for (var destidx=0; destidx < destnopos.length; destidx++) {
      var destname = destnopos[destidx][0];
      var destlat = destnopos[destidx][6];
      var destlon = destnopos[destidx][7];
      if (destname != null && destname.length > 0 && (destnopos[destidx].length < 3 || destnopos[destidx][3] == null)) {
        var found = false;
        for (var histidx=0; !found && histidx < history.length; histidx++) {
          if (history[histidx].title == destname) {
            history[histidx].time = (new Date()).getTime();
            if (destlat != null && destlon != null) {
              history[histidx].lat = destlat;
              history[histidx].lon = destlon;
            }
            found = true;
          }
        }
        if (!found) {
          var newentry = {"title": destname, "pinned": false, "time": (new Date()).getTime()};
          if (destlat != null && destlon != null) {
            newentry.lat = destlat;
            newentry.lon = destlon;
          }
          history.splice(0,0,newentry);
        }
      }
    }
    history.sort(function (a,b) {
      if (a.pinned) {
        if (!b.pinned) {
          return -1;
        }
      } else {
        if (b.pinned) {
          return 1;
        }
      }
      if (a.time > b.time) {
        return -1;
      }
      return 1;
    });
    if (history.length > 15) {
      history = history.slice(0,14);
    }
    setStorageValue("searchhistory", history);
    updateHistory();
    
    setStorageValue("longbreak_wps", chrg.longbreak_ids);
    setStorageValue("exclude_wps", chrg.exclude_ids);
    setStorageValue("preferred_network_ids", chrg.preferred_network_ids);
    if (loginemail && server_save) {
      var settingsurl = 'https://abetterrouteplanner.com/db_data.py/set_settings';
      var data = "session_id="+encodeURIComponent(session_id)+
      "&settings="+encodeURIComponent(JSON.stringify(server_settings));
      $.post({ url: settingsurl, data: data, dataType: "json" })
      .done(function(data) {
      })
      .fail(function() {
        console.log('Set settings error.');
      });
    }
  }
  
  function loadScript() {
    //initialize();
  }
  
  function loadCarModels() {
    var url = 'https://abetterrouteplanner.com/car_model.py/get_carmodels';
    $.get({ url: url, dataType: "json" })
    .done(function(data) {
      if (data.status == "ok") {
        car_models = data.car_models;

        var models = [];
        for (var idx=0; idx < car_models.length; idx++) {
          models.push({"title":car_models[idx].name.split(";"), "value":car_models[idx].typecode});
        }    
        popupPopulateById("carmodelpopup", models);
        initializePostLoading();
        popupSetValueById("carmodelpopup", getCarModel());
        setCarModelFastChargerTypes(false);
        console.log("Car models loaded.");
      }
    })
    .fail(function() {
      console.log('Get car models error.');
      setTimeout(loadCarModels, 5000);
    });
  }
  
  function capitalize(s) {
    var words = s.trim().split(" ");
    for (idx=0; idx < words.length; idx++) {
      words[idx] = words[idx].charAt(0).toUpperCase() + words[idx].slice(1);
    }
    return words.join(" ");
  }
  
  function formatAddress(input, fillinblanks) {
    if (input.value == null && input.innerText && input.innerText == "Waypoint on map") {
      return null;
    }
    var str = capitalize(input.value);
    if (str.length > 0) {
      input.value = str;
    } else {
      if (fillinblanks && carlatlon) {
        str = (carlatlon[0]+","+carlatlon[1]);
        if (carheading != null) {
          str += ","+Math.round(carheading);
        }
      }
    }
    return str;
  }
  
  function getDestList(fillinblanks) {
    var form = document.getElementById('plan-form');
    var dest = [];
    for (var idx=0; idx < viainputs.length; idx++) {
      d = ["", null, null, null, null, null, null, null, null, false, null]; // name 0, chargepower 1, chargetime 2, charger id 3, charger_type 4, departtime 5, lat 6, lon 7, chargeperc 8, is_my_pos 9, arriveperc 10
      if (viainputs[idx].length > 3 && viainputs[idx][3] != null) {
        // Has charger id or lat lon
        var id = viainputs[idx][3];
        var charger_name = "";
        var charger_type = "";
        if (id in chrg.chargers) {
          var charger = chrg.chargers[id];
          charger_name = charger.name;
          charger_type = chrg.getChargerType(id);
        } else {
          charger_name = viainputs[idx][0].value;
          charger_type = viainputs[idx][4];
        }
        d[0] = charger_name;
        d[3] = id;
        d[4] = charger_type;
      } if (viainputs[idx].length > 7 && viainputs[idx][6] != null) {
        d[0] = formatAddress(viainputs[idx][0], false); // Do not fill in own position if lat and lon exists
      } else {
        d[0] = formatAddress(viainputs[idx][0], fillinblanks);
        if (!viainputs[idx][0] || viainputs[idx][0].value.length == 0) {
          d[9] = true;
        }
      }
      if (viainputs[idx].length > 7 && viainputs[idx][6] != null) {
        d[6] = viainputs[idx][6];
        d[7] = viainputs[idx][7];
      }
      var chargepower = null;
      if (viainputs[idx][1] != null) {
        chargepower = viainputs[idx][1];
      }
      var chargetime = null;
      if (viainputs[idx][2] != null) {
        chargetime = viainputs[idx][2];
      }
      var chargeperc = null;
      if (viainputs[idx][8] != null) {
        chargeperc = viainputs[idx][8];
      }
      var arriveperc = null;
      if (viainputs[idx][10] != null) {
        arriveperc = viainputs[idx][10];
      }
      d[1] = chargepower;
      d[2] = chargetime;
      d[8] = chargeperc;
      d[10] = arriveperc;
      if (viainputs[idx].length > 5 && viainputs[idx][5] != null) {
        d[5] = viainputs[idx][5];
      }
      dest.push(d);
    }
    
    return dest;
  }
  
  function setDestList(dest) {
    if (dest[0].length > 0 && dest[0][0] && dest[0][0].length > 0 && dest[0][0] == dest[dest.length-1][0] && dest[0][6] == dest[dest.length-1][6] && dest[0][7] == dest[dest.length-1][7]) {
      round_trip = true;
    } else {
      round_trip = false;
    }
    setVias(dest);
  }
  
  function closeGetLinks() {
    var div = document.getElementById("linksoverlay");
    div.style.display = "none";
  }
  
  function openGetLinks() {
    var div = document.getElementById("linksoverlay");
    div.style.display = "";
    var link = document.getElementById("plan-link");
    if (plan && "plan_uuid" in plan) {
      var url = "plan_uuid="+plan["plan_uuid"]
      url = "https://"+window.location.hostname+window.location.pathname+"?"+url;
      link.value=url;
      
    } else {
      link.value="None";
    }
    //Get the google link
    var link = document.getElementById("google-link");
    var dests = getDestList(true);
    if (dests && selrouteidx >= 0) {
      url = "https://www.google.com/maps/dir/?api=1";
      for (i=0;i<(plan.routes[selrouteidx].steps.length);i++) {
        var step = plan.routes[selrouteidx].steps[i];
        if (i == 0){
          url+="&origin=";
        } else if (i == (plan.routes[selrouteidx].steps.length - 1)) {
          url+="&destination=";
        } else if (url.indexOf("&waypoints=") < 0) {
          url+="&waypoints=";
        }else {
          url+=encodeURIComponent("|");
        }
        //url+= encodeURIComponent(step.name+",");
        url+= encodeURIComponent(step.lat+",");
        url+= encodeURIComponent(step.lon);
      }
      url+="&dir_action=navigate&travelmode=driving";
      link.value=url;
    } else {
      link.value="None";
    }

    var tesla_btn = document.getElementById("tesla-nav-btn");
    if (hasMyTesla()) {
      tesla_btn.style.display = "";
    } else {
      tesla_btn.style.display = "none";
    }
    
    //Get the waze and share link, can only send next destination.
    var sharelink = document.getElementById("geo-share-btn");
    var wazelink = document.getElementById("waze-link");
    var applelink = document.getElementById("apple-link");
    if (dests && selrouteidx >= 0 && car_latest_wp_idx >= 0 && car_latest_wp_idx < plan.routes[selrouteidx].steps.length-1) {
      var step_idx = getNextVisibleStepIdx(car_latest_wp_idx);
      var step = plan.routes[selrouteidx].steps[step_idx]; //Get the next step.
      url = "https://waze.com/ul?ll=";
      url+= encodeURIComponent(step.lat+",");
      url+= encodeURIComponent(step.lon);
      url+="&navigate=yes";
      wazelink.value=url;
      
      url = "geo:"+step.lat+","+step.lon+"?q="+step.lat+","+step.lon+"(";
      // if (step.is_charger && chrg.chargers[step.id].network_name) {
      //   url +=chrg.chargers[step.id].network_name+")";
      // }
      // else
      if ("name" in step) {
        url += encodeURIComponent(step.name)+")";
      } else {
        url += "ABRP Waypoint)";
      }
      console.log(url);
      sharelink.href=url;
      
      url = "http://maps.apple.com/?daddr=";
      url+= encodeURIComponent(step.lat+",");
      url+= encodeURIComponent(step.lon);
      url+="&dirflg=d";
      if ("name" in step) {
        url += "&address="+encodeURIComponent(step.name);
      }
      applelink.value=url;
    } else {
      wazelink.value="None";
      sharelink.value="None";
      applelink.value="None";
    }
  }
  
  function copyToClipboard(el) {
    if (is_ios) {
      var oldContentEditable = el.contentEditable,
      oldReadOnly = el.readOnly,
      range = document.createRange();
      
      el.contenteditable = true;
      el.readonly = false;
      range.selectNodeContents(el);
      
      var s = window.getSelection();
      s.removeAllRanges();
      s.addRange(range);
      
      el.setSelectionRange(0, 999999);
      
      el.contentEditable = oldContentEditable;
      el.readOnly = oldReadOnly;
    } else {
      el.select();
    }
    document.execCommand('copy');
  }

  function sendTeslaNavigation() {
    var step_idx = getNextVisibleStepIdx(car_latest_wp_idx);
    var step = plan.routes[selrouteidx].steps[step_idx];
    var token = getDefaultStorageValue("mytesla_token", null);
    var vid = getDefaultStorageValue("mytesla_vid", null);
    if (token == null) {
      return;
    }

    url = "https://abetterrouteplanner.com/teslacmd.py/push_navigation";
    data = "lat="+step.lat+"&lon="+step.lon+"&address="+encodeURIComponent(step.name)+"&vehicle_id="+encodeURIComponent(vid)+"&token="+encodeURIComponent(token);
    $.post({ url: url, data: data, dataType: "json" })
        .done(function (result) {
          if (result.response.result) {
            showToast("Sent to Tesla Navigation");
          } else {
            showToast("Failed to send to Tesla Navigation");
          }
        })
        .fail(function () {
          showToast("Failed to send to Tesla Navigation");
        });
  }

  function onCopyPlanLinkButton(action) {
    var link = "";
    if (action.indexOf("plan") >=0) {
      link = document.getElementById("plan-link");
    } else if ( action.indexOf("google") ==0) {
      link = document.getElementById("google-link");
    } else if ( action.indexOf("waze") ==0) {
      link = document.getElementById("waze-link");
    } else if ( action.indexOf("apple") ==0) {
      link = document.getElementById("apple-link");
    }
    if (action.indexOf("copy") >=0 ) {
      copyToClipboard(link);
    } else if (action.indexOf("open") >= 0) {
      window.open(link.value);
    }
  }
  
  function arrayToUrl(data) {
    var parts = [];
    for (key in data) {
      parts.push(key + '=' + encodeURIComponent(data[key]));
    }
    return parts.join("&");
  }
  
  function getPlanSettings() {
    var settings = {}
    var destinations = getDestList(false);
    var form = document.getElementById('plan-form');
    var car = getCarModel();
    var car_model = findCarModel(car);
    
    dest = [];
    for (var idx=0; idx < destinations.length; idx++) {
      var text = destinations[idx].join(";");
      dest.push(text);
    }
    if (!form.elements["initialcharge"].checkValidity() || !form.elements["arrivalcharge"].checkValidity() ||
    !form.elements["chargercharge"].checkValidity() ||
    !form.elements["chargeoverhead"].checkValidity() || !form.elements["speedoverlimit"].checkValidity() ||
    !form.elements["max_speed"].checkValidity() || !form.elements["consumption"].checkValidity()) {
      showSettings(true);
      return null;
    }
    
    settings["destinations"] = dest.join("|");
    settings["initial_soc"] = parseInt(form.elements["initialcharge"].value);
    settings["arrival_soc"] = form.elements["arrivalcharge"].value;
    settings["charger_soc"] = form.elements["chargercharge"].value;
    settings["charge_overhead"] = form.elements["chargeoverhead"].value;
    settings["speed_factor"] = form.elements["speedoverlimit"].value;
    var max_speed = form.elements["max_speed"].value/3.6;
    if (units == "imperial") {
      max_speed *= 1.609;
    }
    settings["max_speed"] = max_speed;
    cons = form.elements["consumption"].value;
    if (cons_units == "distance_per_energy") {
      //Flip the units over if in distance_per_energy.  Need units in Wh/km for planning.
      cons = convertConsUnits(cons);
    }
    if (units == "imperial") {
      cons = cons/1.609/0.96;
    }
    settings["typ_consumption"] = cons;
    //settings["find_alts"] = form.elements["find_alts"].checked;
    settings["find_alts"] = "true"
    settings["find_next_charger_alts"] = "false"
    var avoidclasses = getAvoidClasses();
    settings["allow_ferry"] = !avoidclasses[0];
    settings["allow_toll"] = !avoidclasses[1];
    settings["allow_motorway"] = !avoidclasses[2];
    settings["adjust_speed"] = form.elements["adjust_speed"].checked;
    var outside_temp = form.elements["outsidetemp"].value;
    var battery_temp = form.elements["initbatterytemp"].value;
    var wind_speed = form.elements["windspeed"].value;
    var wind_dir = popupGetValueById("winddir");
    var extra_weight = form.elements["extra_weight"].value;
    if (units == "imperial") {
      outside_temp = (outside_temp-32)/1.8;
      battery_temp = (battery_temp-32)/1.8;
      wind_speed = wind_speed*1.609/3.6;
      extra_weight = 0.45*extra_weight;
    }
    settings["battery_degradation"] = form.elements["battery_degradation"].value;
    settings["outside_temp"] = outside_temp;
    //settings["battery_temp"] = battery_temp;
    settings["wind_speed"] = wind_speed;
    settings["wind_dir"] = wind_dir;
    settings["road_condition"] = popupGetValueById("roadcondition");
    settings["extra_weight"] = extra_weight;
    var fast_chargers = [];
    if (form.elements["SC"].checked) {
      fast_chargers.push("SC");
    }
    if (form.elements["tesla_ccs"].checked) {
      fast_chargers.push("tesla_ccs");
    }
    if (form.elements["ccs"].checked) {
      fast_chargers.push("ccs");
    }
    if (form.elements["chademo"].checked) {
      fast_chargers.push("chademo");
    }
    if (fast_chargers.length == 0) {
      if (car_model) { // If no fast chargers selected, use recommended for car model (including those which do not support SC/ccs/chademo at all)
        fast_chargers = car_model.rec_fast_chargers.split(",");
      }
    }
    settings["longbreak_ids"] = chrg.longbreak_ids.join("|");
    settings["exclude_ids"] = chrg.exclude_ids.join("|");
    settings["preferred_network_ids"] = chrg.preferred_network_ids.join("|");
    settings["fast_chargers"] = fast_chargers.join("|");
    
    settings["carmodel"] = car;
    
    return settings;
  }
    
  function setPlanButton(planning) {
    var button = document.getElementById("plan-button");
    if (planning) {
      button.value = "Cancel Planning";
    } else {
      button.value = "Plan Route";
    }
  }
  
  function onPlanButton(find_next_charger_alts) {
    if (getAutocompleteOpen()) { return; }
    if (planning_ongoing || do_plan_on_position_obtained) {
      cancelPlan();
      return;
    }
    var form = document.getElementById('plan-form');
    var settings = getPlanSettings();
    if (settings == null) {
      return;
    }
    saveSettings(true);
    var dest = getDestList(false);
    if (dest[0][0] == "" && car_soc_perc != null && form.elements["initialcharge"].value.length > 0) {
      if (!asked_for_current_charge && confirm("Use current car charge % and time for planning?")) {
        form.elements["initialcharge"].value = "";
        settings["initial_soc"] = "";
        if (viainputs[0].length >= 5 && viainputs[0][5]) {
          viainputs[0][5] = "";
        }
      }
      asked_for_current_charge = true;
    }
    if (carlatlon == null) {
      for (var idx=0; idx < dest.length; idx++) {
        if (dest[idx][0].length == 0) {
          // We have no position and the user is askint to plan to/from our position - wait until we have pos
          do_plan_on_position_obtained = true;
          // Fake that planning is ongoing...
          var spinnerdiv = document.getElementById("spinner-div");
          spinnerdiv.style.display = "";
          if (mapmode == "nomap") {
            spinnerdiv = document.getElementById("spinner-div-nomap");
            spinnerdiv.style.display = "";
          }
          setPlanButton(true);
          return;
        }
      }
    }
    
    var dest = getDestList(true);
    delete settings["destinations"]; // This is replaced below
    if (plan_next_soc_perc != null) {
      settings["initial_soc"] = plan_next_soc_perc;
    }
    if (isNaN(settings["initial_soc"]) || settings["initial_soc"] == 0) {
      if (car_soc_perc != null) {
        settings["initial_soc"] = car_soc_perc;
      } else if (stale_car_soc_perc != null) {
        settings["initial_soc"] = stale_car_soc_perc;
      } else {
        settings["initial_soc"] = 90;
      }
    }
    
    cons = form.elements["consumption"].value;
    if (cons_units == "distance_per_energy") {
      //Flip the units over if in distance_per_energy.  Need units in Wh/km for planning.
      cons = convertConsUnits(cons);
    }
    if (units == "imperial") {
      cons = cons/1.609/0.96;
    }
    
    var car = settings["carmodel"];
    if (!car) {
      openInitialCarSelector();
      return;
    }
    
    if (find_next_charger_alts) {
      settings["find_alts"] = "false"
      settings["find_next_charger_alts"] = "true"
    }

    setPlanButton(true);
    settings["user_settings"] = JSON.stringify(getPlanSettings());
    
    planRoute(dest, settings, find_next_charger_alts);
  }
  
  function findCarModel(typecode) {
    for (idx in car_models) {
      if (car_models[idx].typecode == typecode) {
        return car_models[idx];
      }
    }
    return null;
  }

  function onModelChange(idx, entries) {
    var form = document.getElementById('plan-form');
    var car = getCarModel();
    if (car == null || car_models.length == 0) {
      return;
    }
    var car_model = findCarModel(car);
    if (!car_model) {
      car = "3long";
      car_model = findCarModel(car);
      window.alert("Selected car model not found - re-set to "+car_model.name.split(";").join(" ")+".");
    }
    setCarModel(car);
    console.log("Car selected: " + car);
    var consump = 210;
    var max_speed = 150;
    if (car_model.ref_cons != null) {
      consump = car_model.ref_cons;
    }
    if (car_model.rec_max_speed != null) {
      max_speed = car_model.rec_max_speed;
    }
    
    setConsUnits("energy_per_distance");
    if (units == "imperial") {
      form.elements["consumption"].value = Math.round(consump*1.609*0.96);
      form.elements["max_speed"].value = Math.round(max_speed/1.609);
    } else {
      form.elements["consumption"].value = consump;
      form.elements["max_speed"].value = max_speed;
    }
    
    var country_code = getDefaultStorageValue("country_code_3", null);
    var is_tesla = (car_model.name.indexOf("Tesla") == 0);
    if (!is_tesla && (country_code == null || country_code == "USA" || country_code == "CAN" || country_code == "MEX")) {
      setConsUnits("distance_per_energy");
    } else {
      setConsUnits("energy_per_distance");
    }

    // Define chargers appropriately:
    var tesla_evse_default_off = ["nema520","nemaTT30","cee_blue"];
    var basic_evse_default_off = ["tesla","type2tesla","nema1450","nemaTT30","nema520","cee_red","cee_blue"];
    
    if (!is_tesla) {
      for (var plug in chrg.dest_dict) {
        if (basic_evse_default_off.indexOf(plug) >= 0) {
          chrg.dest_dict[plug] = false;
        } else {
          chrg.dest_dict[plug] = true;
        }
      }
    } else {
      for (var plug in chrg.dest_dict) {
        if (tesla_evse_default_off.indexOf(plug) >= 0) {
          chrg.dest_dict[plug] = false;
        } else {
          chrg.dest_dict[plug] = true;
        }
      }
    }
    setPlugToggles();

    setCarModelFastChargerTypes(true);
  }

  function setCarModelFastChargerTypes(set_recommended) {
    var form = document.getElementById('plan-form');
    var car = getCarModel();
    if (car == null || car_models.length == 0) {
      return;
    }
    var car_model = findCarModel(car);
    if (!car_model) {
      car = "3long";
      car_model = findCarModel(car);
      setCarModel(car);
      window.alert("Selected car model not found - re-set to "+car_model.name.split(";").join(" ")+".");
    }
    var fast_chargers = ["SC","tesla_ccs","ccs","chademo"];
    var all_off = true;
    for (idx in fast_chargers) {
      var e = fast_chargers[idx];
      if (car_model.fast_chargers.indexOf(e) >= 0) {
        form.elements[e].disabled  = false;
      } else {
        form.elements[e].disabled  = true;
        form.elements[e].checked  = false;
      }
      all_off = (all_off && !form.elements[e].checked);
    }
    if (all_off || set_recommended) { // Set default if all allowed are off
      for (idx in fast_chargers) {
        var e = fast_chargers[idx];
        if (car_model.rec_fast_chargers.indexOf(e) >= 0) {
          form.elements[e].checked  = true;
        } else if (set_recommended) {
          form.elements[e].checked  = false;
        }
      }
    }

    if (bigmap) {
      chrg.refreshChargers(getFastChargerTypes(),bigmap);
    }
  }
  
  
  function secondsToTimeStr(sec_num) {
    if (sec_num < 0) {
      sec_num = 0;
    }
    var hours   = Math.floor(sec_num / 3600);
    var minutes = Math.floor((sec_num - (hours * 3600)) / 60);
    
    if (hours   < 10) {hours   = "0"+hours;}
    if (minutes < 10) {minutes = "0"+minutes;}
    return hours+':'+minutes;
  }
  
  function showSettings(show) {
    var settings = document.getElementById("settings");
    var settingsbutton = document.getElementById("settings-button");
    if (show) {
      settings.style.display = "";
      settingsbutton.removeChild(settingsbutton.firstChild);
      var text = document.createTextNode("Hide Settings")
      settingsbutton.appendChild(text)
    } else {
      settings.style.display = "none";
      settingsbutton.removeChild(settingsbutton.firstChild);
      var text = document.createTextNode("Show Settings")
      settingsbutton.appendChild(text)
    }
  }
  
  function resetDebounce() {
    lastclicktime = null;
  }
  
  function debounce() {
    if (!is_new_car_browser) {
      return false;
    }
    var t = (new Date()).getTime();
    var bounce = false;
    if (lastclicktime && t-lastclicktime < 1200) {
      bounce = true;
    }
    lastclicktime = t;
    return (bounce);
  }
  
  function removeTeslaDoubleClicks() {
    if (!is_car_browser || is_chrome_car_browser) {
      return;
    }
    var elements = document.querySelectorAll('.prevent-double-click');
    elements.forEach(function(elem) {
      removeTeslaDoubleClick(elem);
     });
  }

  function removeTeslaDoubleClick(elem) {
    if (!is_car_browser || is_chrome_car_browser) {
      return;
    }
    elem.addEventListener('touchstart', function(event) {
      console.log("Touch start");
      event.preventDefault();
    }, false);
    elem.addEventListener('touchend', function(event) {
      console.log("Touch end");
      event.preventDefault();
    }, false);
  }

  function toggleSettings() {
    var settings = document.getElementById("settings");
    showSettings(settings.style.display=="none");
  }
  
  function toggleMoreSettings() {
    var settings = document.getElementById("moresettings");
    var settingsbutton = document.getElementById("moresettings-button");
    if (settings.style.display=="none") {
      settings.style.display = "";
      settingsbutton.removeChild(settingsbutton.firstChild);
      var text = document.createTextNode("Hide More Settings")
      settingsbutton.appendChild(text)
    } else {
      settings.style.display = "none";
      settingsbutton.removeChild(settingsbutton.firstChild);
      var text = document.createTextNode("Show More Settings")
      settingsbutton.appendChild(text)
    }
  }
  
  function closeWaypointOptions() {
    var optionswin = document.getElementById("waypointoptions-div");
    optionswin.style.display = "none";
    
    var dest = getDestList(false);
    var form = document.getElementById("waypointoptions-form");
    if (form.elements["chargepower"].value) {
      dest[charge_options_wp_idx][1] = Number(form.elements["chargepower"].value);
    } else {
      dest[charge_options_wp_idx][1] = null;
    }
    if (form.elements["chargetime"].value) {
      dest[charge_options_wp_idx][2] = form.elements["chargetime"].value;
    } else {
      dest[charge_options_wp_idx][2] = null;
    }
    if (form.elements["chargeto"].value) {
      dest[charge_options_wp_idx][8] = form.elements["chargeto"].value;
    } else {
      dest[charge_options_wp_idx][8] = null;
    }
    if (form.elements["arrivesoc"].value) {
      if (document.getElementById("departtime_row").style.display == "none") {
        // This is the final destination.  Set the "goal arrive charge to this value"
        var planform = document.getElementById("plan-form");
        planform.elements["arrivalcharge"].value = form.elements["arrivesoc"].value;
      } else {
        dest[charge_options_wp_idx][10] = form.elements["arrivesoc"].value;
      }
    } else {
      dest[charge_options_wp_idx][10] = null;
    }
    if (form.elements["departtime"].value) {
      dest[charge_options_wp_idx][5] = form.elements["departtime"].value;
    } else {
      dest[charge_options_wp_idx][5] = null;
    }

    setDestList(dest);
  }
  
  function showWaypointOptions(idx) {
    var optionswin = document.getElementById("waypointoptions-div");
    optionswin.style.display = "block";
    
    if (idx < viainputs.length) {
      charge_options_wp_idx = idx;
      
      var form = document.getElementById("waypointoptions-form");
      var dest = getDestList(false);
      var chargepower = dest[idx][1];
      var chargetime =  dest[idx][2];
      var chargerid = dest[idx][3];
      var chargeperc = dest[idx][8];
      var arriveperc = dest[idx][10];
      var departtime = dest[idx][5];
      if (chargepower == null && chargerid in chrg.chargers && chrg.chargers[chargerid]) {
        chargepower = chrg.getChargerPower(chargerid);
      }
      if (chargetime == null && plan && "routes" in plan && selrouteidx < plan.routes.length) {
        for (var stepidx = 0; stepidx < plan.routes[selrouteidx].steps.length; stepidx++) {
          var step = plan.routes[selrouteidx].steps[stepidx];
          if (step.id == chargerid && "charge_duration" in step && step.charge_duration > 0) {
            chargetime = secondsToTimeStr(step.charge_duration+59); // Round up
          }
        }
      }
      if (idx == 0) {
        // Only show departtime
        document.getElementById("departtime_row").style.display = "";
        document.getElementById("arrivesoc_row").style.display = "none";
        document.getElementById("chargepower_row").style.display = "none";
        document.getElementById("chargetime_row").style.display = "none";
        document.getElementById("chargeto_row").style.display = "none";
        document.getElementById("chargeoptions_row").style.display = "none";
      } else if (idx == viainputs.length - 1) {
        // Only show arrivesoc
        document.getElementById("departtime_row").style.display = "none";
        document.getElementById("arrivesoc_row").style.display = "";
        document.getElementById("chargepower_row").style.display = "none";
        document.getElementById("chargetime_row").style.display = "none";
        document.getElementById("chargeto_row").style.display = "none";
        document.getElementById("chargeoptions_row").style.display = "none";
      } else {
        // Show all
        document.getElementById("departtime_row").style.display = "";
        document.getElementById("arrivesoc_row").style.display = "";
        document.getElementById("chargepower_row").style.display = "";
        document.getElementById("chargetime_row").style.display = "";
        document.getElementById("chargeto_row").style.display = "";
        document.getElementById("chargeoptions_row").style.display = "";
      }
      form.elements["chargetime"].value  = chargetime;
      form.elements["chargepower"].value = chargepower;
      form.elements["chargeto"].value  = chargeperc;
      if (idx == viainputs.length - 1) {
        // This is the final destination.  Set the "goal arrive charge to this value"
        var planform = document.getElementById("plan-form");
        form.elements["arrivesoc"].value = planform.elements["arrivalcharge"].value;
      } else {
        form.elements["arrivesoc"].value = arriveperc;
      }
      form.elements["departtime"].value = departtime;
    }
  }
  
  // function toggleDepartTime(idx) {
  //   if (debounce()) { return; }
  //   if (idx < viainputs.length) {
  //     if (viainputs[idx][5] != null) {
  //       // Depart time input is shown, hide it
  //       viainputs[idx][5] = null;
  //     } else {
  //       viainputs[idx][5] = document.createElement("input");
  //     }
  //   }
  //   setVias(getDestList(false));
  // }
  
  function onAddWaypoint() {
    addVia([]);
  }
  
  function addVia(dest) {
    dests = getDestList();
    dests.splice(dests.length-1,0,dest);
    setDestList(dests);
    showPlanList(false);
    showPreliminaryRoute(null);
  }
  
  function resetVia(idx){
    // Function called while user is typing in the field.  Need to get rid of previous lat/long:
    for (var i = 1; i < viainputs[idx].length; i++) {
      // [ [nameinput 0, chargepower 1, chargetime 2, chargerid 3, chargertype 4, departtime 5, lat 6, lon 7 ] ]
      // null out everything that isn't the name input.
      viainputs[idx][i] = null;
    }
  }
  
  //Function that enables the drag and drop sorting of the waypoints.
  $( function() {
    $( "#plan-table" ).sortable({
      delay: 150,
      axis: "y",
      revert: 150,
      stop: function( event, ui ) {
        var dests = getDestList(false);
        var new_idx = $("#plan-table").sortable( "toArray" );
        last = new_idx.length - 1;
        if (new_idx[last] != last) {
          // The last element in the array is part of this swap.  Unset round trip mode.
          round_trip = false;
        }
        var temp = [];
        for (idx=0; idx < dests.length; idx++) {
          // moveIdx(dests,idx,new_idx[idx]);
          temp [idx] = dests[new_idx[idx]];
        }
        dests = temp;
        setVias(dests);
        showPreliminaryRoute(null);
      }
    });
  } );
  
  function setVias(dests) {
    var table = document.getElementById("plan-table");
    while (table.firstChild) {
      table.removeChild(table.firstChild);
    }
    viainputs = [];
    if (round_trip) {
      dests[dests.length - 1] = dests[0];
    }
    var hist_entries = getDefaultStorageValue("searchhistory", []);
    for (idx=0; idx < dests.length; idx++) {
      var dest = dests[idx];
      var vianame = "";
      if   (dest.length > 0) {
        vianame = dest[0];
      }
      var chargepower = null;
      if (dest.length > 1) {
        chargepower = dest[1];
      }
      var chargetime = null;
      if (dest.length > 2) {
        chargetime = dest[2];
      }
      var chargerid = null;
      if (dest.length > 3) {
        chargerid = dest[3];
      }
      var chargertype = null;
      if (dest.length > 4) {
        chargertype = dest[4];
      }
      var departtime = null;
      if (dest.length > 5) {
        departtime = dest[5];
      }
      var lat = null;
      var lon = null;
      if (dest.length > 7) {
        lat = dest[6];
        lon = dest[7];
      }
      var chargeperc = null;
      if (dest.length > 8) {
        chargeperc = dest[8];
      }
      var arriveperc = null;
      if (dest.length > 10) {
        arriveperc = dest[10];
      }
      if (chargerid && chargerid in chrg.chargers && chrg.getChargerType(chargerid)) {
        chargertype = chrg.getChargerType(chargerid);
      }
      
      var tr = document.createElement("tr");
      tr.id = idx
      var td = document.createElement("td");
      td.className = "rowlabel";
      var image = null;
      if (idx == 0) {
        image = getNonChargerOverlayImage("start");
      } else if (idx == dests.length-1) {
        image = getNonChargerOverlayImage("finish");
      } else if (chargerid || chargepower > 0) {
        image = getNonChargerOverlayImage("charger");
      } else {
        image = getNonChargerOverlayImage("waypoint");
      }
      td.appendChild(image);
      tr.appendChild(td);
      
      if (!is_car_browser) {
        td = document.createElement("td");
        td.className = "rowlabel";
        image = document.createElement("img");
        image.src = "icon/double_ellipsis.png";
        td.appendChild(image);
        tr.appendChild(td);
      } else {
        // Disable sortable in the car browser for now.
        $( "#plan-table" ).sortable( "disable" );
      }
      var input = null;
      var inputbackground = null;
      var input_kW = null;
      var input_time = null;
      var input_perc = null;
      var input_arrive = null;
      td = document.createElement("td");
      td.className = "viacontainer";
      
      if (chargerid == null && (lat == null || (vianame && vianame.indexOf("{Google POI}") < 0))) {
        var cont = document.createElement("div");
        cont.className = "wpinputcontainer";
        cont.value = vianame;
        cont.style.display = "inline-block";
        cont.style.whiteSpace = "nowrap";
        cont.style.width = "100%";
        inputbackground = cont;
        input = document.createElement("input");
        input.type = "text";
        input.className = "wpinput";
        input.type="text";
        input.placeholder = "My Position";
        input.value = vianame;
        input.autocapitalize="word";
        input.addEventListener("keyup", function(e) {
          var event = window.event ? window.event : e;
          // 40 = down, 38 = up
          if      (event.keyCode == 40) {scrollAutocompleteEntries("down")}
          else if (event.keyCode == 38) {scrollAutocompleteEntries("up")}
          else if (event.keyCode == 13 && getAutocompleteOpen()) {
            autocompleteEnterKey();
          }
          if ([40,38,13].indexOf(event.keyCode) >= 0) {
            // Intercept this event to prevent other events from taking action:
            event.stopImmediatePropagation();
          }
        });
        input.addEventListener("keyup", bind(onWaypointNameChanged, idx));
        input.addEventListener("keyup", bind(resetVia, idx));
        if (round_trip && idx == dests.length-1){
          // This is the last index, and we're round-tripping, disable editing.
          input.disabled = true;
        } else {
          input.disabled = false;
        }
        //input.addEventListener("change", bind(onWaypointNameDone, idx)); // Removed this as it looks up lat/lon for every key typed which interferes with autocomplete
        cont.appendChild(input);
        popupPopulate(input, hist_entries);
        var img = document.createElement("img");
        img.src = staticurl+"icon/popup_icon.png";
        img.className = "wpdropbutton";
        img.addEventListener('click', getHistoryClicked(input, idx));
        removeTeslaDoubleClick(img);
        cont.appendChild(img);
        td.appendChild(cont);
      } else {
        var cont = document.createElement("div");
        cont.className = "viachargerlabel";
        inputbackground = cont;
        cont.value = vianame;
        var text = null;
        if (chargerid) {
          var image = chrg.charger_overlay_icon(chargertype, true);
          cont.appendChild(image);
          text = document.createTextNode(" "+vianame);
        } else {
          text = document.createTextNode("Waypoint on map");
        }
        cont.appendChild(text);
        td.appendChild(cont);
      }
      tr.appendChild(td);
      
      td = document.createElement("td");
      var img = document.createElement("img");
      img.src = staticurl+"icon/remove_icon.png";
      img.className = "wpbutton";
      img.title = "Clear or remove this waypoint";
      img.height = 20;
      img.width = 20;
      img.margin = 2;
      img.addEventListener('click', bind(removeVia, idx));
      removeTeslaDoubleClick(img);
      td.appendChild(img);
      
      if (is_car_browser) {
        img = document.createElement("img");
        img.src = staticurl+"icon/down_icon.png";
        img.className = "wpbutton";
        img.title = "Move this waypoint down";
        img.addEventListener('click', bind(moveDown, idx));
        removeTeslaDoubleClick(img);
        td.appendChild(img);
        var img = document.createElement("img");
        img.src = staticurl+"icon/up_icon.png";
        img.className = "wpbutton";
        img.title = "Move this waypoint up";
        img.addEventListener('click', bind(moveUp, idx));
        removeTeslaDoubleClick(img);
        td.appendChild(img);
      }
      var has_chargeoptions = ((chargepower != null || chargetime != null || chargeperc != null || arriveperc != null || departtime != null) && idx < dests.length-1);
      img = document.createElement("img");
      img.id = "wp_settings_active";
      img.src = "icon/settings_active.png"; //staticurl+"icon/chargeplug_active_icon.png";
      img.title = "Edit arrival, departure, and charging settings for this waypoint";
      img.className = "wpbutton";
      img.addEventListener('click', bind(showWaypointOptions, idx));
      removeTeslaDoubleClick(img);
      td.appendChild(img);
      if (has_chargeoptions)  {img.style.display = "";}
      else                    {img.style.display = "none";}
      img = document.createElement("img");
      img.id = "wp_settings";
      img.src = "icon/settings.png"; //staticurl+"icon/chargeplug_active_icon.png";
      img.title = "Edit arrival, departure, and charging settings for this waypoint";
      img.className = "wpbutton";
      img.addEventListener('click', bind(showWaypointOptions, idx));
      removeTeslaDoubleClick(img);
      td.appendChild(img);
      if (has_chargeoptions)  {img.style.display = "none";}
      else                    {img.style.display = "";}


      if (idx == dests.length-1) {
        img = document.createElement("img");
        // img.src = staticurl+"uturn_icon_grey.png";
        img.src = "icon/uturn_icon_grey.png";
        img.className = "wpbutton";
        img.title = "Enable round trip mode";
        img.id = "uturn_grey";
        if (round_trip) {
          img.style.display = "none";
        } else {
          img.style.display = "inline";
        }
        img.addEventListener('click', bind(toggleRoundTrip, "enable"));
        removeTeslaDoubleClick(img);
        td.appendChild(img);
        
        // Hide the "active" round trip mode icon:
        img = document.createElement("img");
        // img.src = staticurl+"uturn_icon_red.png";
        img.src = "icon/uturn_icon_red.png";
        img.className = "wpbutton";
        img.id = "uturn_red";
        img.title = "Disable round trip mode";
        img.addEventListener('click', bind(toggleRoundTrip, "disable"));
        removeTeslaDoubleClick(img);
        if (round_trip) {
          img.style.display = "inline";
        } else {
          img.style.display = "none"
        }
        td.appendChild(img);
      }

      tr.appendChild(td);
      
      table.appendChild(tr);
      var elem = input;
      if (elem == null) {
        elem = inputbackground;
      }
      
      viainputs.push([elem, chargepower, chargetime, chargerid,chargertype, departtime, lat, lon, chargeperc, null, arriveperc]);
    }
  }
  
  function toggleRoundTrip(act) {
    dests = getDestList(false);
    if (act == "enable" && dests[dests.length-1][0] != "" && dests[dests.length-1][0] != dests[0][0]) {
      // This Line has stuff in it, don't replace it.
      dests.push(dests[0])
    } else if (act == "disable" && dests.length > 2){
      dests.pop()
    }
    if (act == "enable"){
      round_trip = true;
    } else { 
      round_trip = false;
    }
    setVias(dests);
    showPreliminaryRoute(null);
  }
  
  function onHistoryClicked(input, wp_idx) {
    history_wp_idx = wp_idx;
    popupOpen(input, onHistorySelected, onHistoryPinned);
  }
  
  // Function to bind variable values in loop
  function getHistoryClicked(input, wp_idx) {
    return function() {
      return onHistoryClicked(input, wp_idx);
    }
  }
  
  function showPreliminaryRoute(status) {
    plan = {"routes": []}
    if (status) {
      plan.status = status;
    }
    planchanged = true;
    setCopyPlanButton(!planchanged);
    showPlanList(!planchanged);
    steps = [];
    var showing_prel_route = true;
    for (idx in viainputs) {
      var step = {};
      step.is_charger = false;
      if (viainputs[idx][3] != null) {
        step.is_charger = true;
        step.id = viainputs[idx][3];
      }
      step.charger_type = null;
      if (viainputs[idx][4] != null) {
        step.charger_type = viainputs[idx][4];
      }
      if (viainputs[idx][6] != null) {
        step.lat = viainputs[idx][6];
        step.lon = viainputs[idx][7];
      } else {
        if (viainputs[idx][0].value.length == 0 && carlatlon) {
          step.lat = carlatlon[0];
          step.lon = carlatlon[1];
        } else {
          showing_prel_route = false;
        }
      }
      step.name = viainputs[idx][0].value;
      step.is_waypoint = true;
      step.route_soc = [];
      steps.push(step);
    }
    if (showing_prel_route) {
      plan.routes.push({"steps":steps});
      showRoute(plan, 0, "all", true);
    }
    return showing_prel_route;
  }
  
  function bind(func, fixThis) {
    return function() {
      return func(fixThis);
    }
  }
  
  function bind2(func, fixThis, fixThis2) {
    return function() {
      return func(fixThis, fixThis2);
    }
  }
  
  
  function bindEvent(func, fixThis) {
    return function(e) {
      return func(e, fixThis);
    }
  }
  
  function bindEvent2(func, fixThis, fixThis2) {
    return function(e) {
      return func(e, fixThis, fixThis2);
    }
  }
  
  function bindEvent3(func, fixThis, fixThis2, fixThis3) {
    return function(e) {
      return func(e, fixThis, fixThis2, fixThis3);
    }
  }
  
  function removeVia(index) {
    dest = getDestList(false);
    if (dest[index][3]) {
      //Has a chargerid, need to deactivate "in_use"
      var id = dest[index][3];
      delete chrg.routechargers[id];
      chrg.setInUse(chrg.chargers[id],false);
    }
    if (index == (dest.length - 1) || (dest.length == 3)) {
      toggleRoundTrip("disable");
    }
    if (dest.length >= 3) {
      dest.splice(index, 1);
    } else {
      dest[index] = [];
    }
    setDestList(dest);
    showPreliminaryRoute(null);
  }
  
  function getWPInput(index) {
    var input = null;
    input = viainputs[index][0];
    return input;
  }
  
  function moveDown(index) {
    var dest = getDestList(false);
    if (index < viainputs.length-1) {
      var tmp = dest[index+1];
      dest[index+1] = dest[index];
      dest[index] = tmp;
      setDestList(dest);
    }
    showPreliminaryRoute(null);
  }
  
  function moveUp(index) {
    var dest = getDestList(false);
    if (index >= 1) {
      var tmp = dest[index-1];
      dest[index-1] = dest[index];
      dest[index] = tmp;
      setDestList(dest);
    }
    showPreliminaryRoute(null);
  }
  
  function clearInput(index) {
    var input = getWPInput(index);
    input.value = "";
    showPreliminaryRoute(null);
  }
  
  
  function zoomOut() {
    delayHideScreenButtons();
    var zoom = bigmap.getZoom();
    if (zoom > 1) {
      bigmap.setZoom(zoom-1);
    }
    setStorageValue("mapzoom", bigmap.getZoom());
  }
  
  function zoomIn() {
    delayHideScreenButtons();
    var zoom = bigmap.getZoom();
    if (zoom < 18) {
      bigmap.setZoom(zoom+1);
    }
    setStorageValue("mapzoom", bigmap.getZoom());
  }
  
  function distStr(dist) {
    res = ""
    if (units == "metric") {
      res = Math.round(dist)+"\xa0km";
    }
    if (units == "imperial") {
      res = Math.round(dist/1.609)+"\xa0miles";
    }
    return res;
  }
  
  
  
  function setCopyPlanButton(on) {
    var copybutton = document.getElementById("copyplan-button");
    var savebutton = document.getElementById("saveplan-button");
    var routeselect = document.getElementById("route-select");
    var showplan = document.getElementById("show-planlist-input");
    if (on) {
      copybutton.style.display="";
      savebutton.style.display="";
      //routeselect.style.display="";
      showplan.style.display="";
    } else {
      copybutton.style.display="none";
      savebutton.style.display="none";
      //routeselect.style.display="none";
      showplan.style.display="none";
    }
  }
  
  
  function onRouteSelected(routeidx, entries) {
    showRoute(plan, routeidx, false, true);
  }
  
  function showPlanList(on) {
    var paramsdiv = document.getElementById("plan-params-div");
    var listdiv = document.getElementById("route-list-div");
    
    if (on) {
      paramsdiv.style.display = "none";
      listdiv.style.display = "";
    } else {
      paramsdiv.style.display = "";
      listdiv.style.display = "none";
    }
  }
  
  function showRoute(data, routeidx, recenter, show_alts) {
    if (routeidx < 0 || plan == null) {
      return;
    }
    hideDriving();
    
    var next_charge_perc = null;

    var nrof_footnotes = 0;
    var suboptimal_footnote = "";
    
    car_latest_wp_idx = 0;
    car_turn_idx = -1;
    
    selrouteidx = routeidx;
    var waypts = [];
    clearRoute();
    
    showPlanList(!planchanged);
    setCopyPlanButton(!planchanged);
    var stepdiv = document.getElementById("route-div");
    
    var show_times = false;
    var show_charging_costs = false;
    if ("routes" in data && selrouteidx < data.routes.length &&  "steps" in data.routes[selrouteidx]) {
      if (data.routes[selrouteidx].steps.length > 0 && data.routes[selrouteidx].steps[0].departure_time) {
        show_times = true;
      }
      for (idx = 0; idx < data.routes[selrouteidx].steps.length; idx++) {
        var step = data.routes[selrouteidx].steps[idx];
        if (step.is_charger && step.charge_cost > 0) {
          show_charging_costs = true;
        }
      }
    }

    var table = document.createElement("table");
    table.className = 'routesteps';
    var col = document.createElement("col");
    col.className = 'route_col_0';
    table.appendChild(col);
    col = document.createElement("col");
    col.className = 'route_col_1';
    table.appendChild(col);
    col = document.createElement("col");
    col.className = 'route_col_2';
    table.appendChild(col);
    col = document.createElement("col");
    col.className = 'route_col_1';
    table.appendChild(col);
    col = document.createElement("col");
    col.className = 'route_col_2';
    table.appendChild(col);
    col = document.createElement("col");
    col.className = 'route_col_1';
    table.appendChild(col);
    col = document.createElement("col");
    col.className = 'route_col_2';
    table.appendChild(col);
    if (show_times) {
      col = document.createElement("col");
      col.className = 'route_col_1';
      table.appendChild(col);
      col = document.createElement("col");
      col.className = 'route_col_2';
      table.appendChild(col);
    }
    if (show_charging_costs) {
      col = document.createElement("col");
      col.className = 'route_col_1';
      table.appendChild(col);
    }
    
    if (!("routes" in data)) {
      data.routes = [];
    }
    if (selrouteidx < data.routes.length && !planchanged) {
      var tr = document.createElement("tr");
      tr.className = 'route_header';
      if (show_charging_costs) {
        labels = ["Arrival Charge", "Depart Charge", "Charge Duration", "Charge Cost", "Duration", "Distance"];
      } else {
        labels = [ "Arrival Charge", "Depart Charge", "Charge Duration", "Duration", "Distance"];
      }
      if (show_times) {
        labels.push("Arrival Time");
        labels.push("Depart Time");
      }
      labels.push("Total Duration");
      var th = document.createElement("th");
      var select = document.createElement("input");
      select.className="routedropdown";
      select.id = "route-select";
      var route_entries = [];
      for (var idx=0; idx < data.routes.length; idx += 1) {
        var option = document.createElement("option");
        var text;
        if (idx == 0) {
          text = "Best route, "+secondsToTimeStr(data.routes[idx].steps[0]["departure_duration"]);
        } else {
          text = "Alt route "+idx+", "+secondsToTimeStr(data.routes[idx].steps[0]["departure_duration"]);
        }
        route_entries.push({"title": text, "value": idx})
      }
      popupPopulate(select, route_entries);
      select.addEventListener("click", function() { popupOpen(select, onRouteSelected)});
      removeTeslaDoubleClick(select);
      popupSetValue(select, routeidx);
      th.appendChild(select);
      tr.appendChild(th);
      
      for (idx=0; idx < labels.length; idx++) {
        var th = document.createElement("th");
        words = labels[idx].split(" ");
        for (wi=0; wi < words.length; wi++) {
          var text = document.createTextNode(words[wi])
          th.appendChild(text)
          if (wi < words.length-1) {
            var br = document.createElement("br");
            th.appendChild(br);
          }
        }
        tr.appendChild(th);
      }
      table.appendChild(tr);
      
      var leg_dur = 0;
      var nrof_waypoints = 0;
      var total_cost = 0;
      var total_currency = null;
      
      
      for (idx = 0; idx < data.routes[routeidx].steps.length; idx++) {
        var step = data.routes[routeidx].steps[idx];
        if (step.wp_type != 1 || idx >= data.routes[routeidx].steps.length-1 || idx == 0) { // No map waypoints
          var tr = document.createElement("tr");
          var td = document.createElement("td");
          var islaststep = (idx >= data.routes[routeidx].steps.length-1);
          if (step.is_charger || step.is_station) {
            var span = document.createElement("span");
            span.className = "routewptext";
            var img = "none";
            if (chrg.chargers && chrg.longbreak_ids.indexOf(step.id) > -1) {
              img = chrg.longbreak_overlay_icon();
            } else if (chrg.chargers && chrg.exclude_ids.indexOf(step.id) > -1) {
              img = chrg.exclude_overlay_icon();
            } else if (chrg.chargers && chrg.chargers[step.id]) {
              img = chrg.charger_overlay_icon(chrg.chargers[step.id].type, true);
            } else if (step.is_station) {
              img = getNonChargerOverlayImage("ferry");
            } else {
              img = chrg.charger_overlay_icon(step.charger_type, true);
            }
            img.className = "routewptext";
            span.appendChild(img);
            if (!step.is_charger) {
              var text = document.createTextNode(" "+step.name.split(",")[0]);
            } else {
              var text = document.createTextNode(" "+step.name);
            }
            span.appendChild(text);
            span.addEventListener('click', bind(chrg.openChargerInfoWindow, step.id));
            removeTeslaDoubleClick(span);
            td.appendChild(span);
          } else {
            //This is a step the user added, make sure the name is right.
            var parts = step.name.split(",");
            var text = "";
            if (parts.length < 2 || isNaN((parts[0])) || isNaN((parts[1]))) {
              // This name is not a lan/lon-pair, so take only first part
              text = parts[0].replace("{Google POI}","");
            } else {
              text = "Point on map"
            }
            dests = getDestList(true);
            text = document.createTextNode(text);
            td.appendChild(text);
          }
          tr.appendChild(td);
          td = document.createElement("td");
          td.className = "routenumber";
          if (idx > 0 || step.is_charger) {
            text = document.createTextNode(step.arrival_perc+"%");
            td.appendChild(text);
          }
          tr.appendChild(td);
          td = document.createElement("td");
          td.className = "routenumber";
          if ((step.is_charger || idx == 0 || step.is_destcharger) && !islaststep) {
            if ((step.is_charger || step.is_destcharger) && next_charge_perc === null) {
              next_charge_perc = step.departure_perc;
              setNextChargeTo(next_charge_perc);
            }
            text = document.createTextNode(step.departure_perc+"%");
            td.appendChild(text);
          }
          tr.appendChild(td);
          td = document.createElement("td");
          td.className = "routenumber";
          if ((step.is_charger || step.is_destcharger) && !islaststep) {
            var t = secondsToTimeStr(step.charge_duration);
            if (step.is_destcharger) {
              td.className = "routeinfonumber";
            }
            text = document.createTextNode(t);
            td.appendChild(text);
          }
          tr.appendChild(td);
          if (show_charging_costs) {
            td = document.createElement("td");
            td.className = "routenumber";
            if (step.is_charger && step.charge_cost > 0) {
              coststr = step.charge_cost_currency;
              if (total_currency == null) {
                total_currency = step.charge_cost_currency;
              } else if (total_currency != step.charge_cost_currency) {
                total_currency = "VAR";
              }
              if (coststr.length > 1) {
                coststr += " "
              }
              if (step.charge_cost > 20) {
                coststr += step.charge_cost.toFixed(0);
              } else {
                coststr += step.charge_cost.toFixed(2);
              }
              total_cost += step.charge_cost
              text = document.createTextNode(coststr);
              td.appendChild(text);
            }
            tr.appendChild(td);
          }
          td = document.createElement("td");
          td.className = "routenumber";
          if (step.wait_duration > 0) {
            td.className = "routeinfonumber";
            var t = secondsToTimeStr(step.wait_duration);
            text = document.createTextNode(t);
            td.appendChild(text);
          }
          tr.appendChild(td);
          td = document.createElement("td");
          td.className = "routenumber";
          tr.appendChild(td);
          
          if (show_times) {
            td = document.createElement("td");
            td.className = "routenumber";
            if (idx > 0) {
              var text = document.createTextNode(formatTime(step.arrival_time, step.utc_offset));
              td.appendChild(text);
            }
          }
          tr.appendChild(td);
          if (show_times) {
            td = document.createElement("td");
            td.className = "routenumber";
            if (idx < data.routes[routeidx].steps.length-1) {
              var text = document.createTextNode(formatTime(step.departure_time, step.utc_offset));
              td.appendChild(text);
            }
            tr.appendChild(td);
          }
          
          td = document.createElement("td");
          td.className = "routenumber";
          if (step.is_waypoint && !step.is_charger && (idx != 0 && (nrof_waypoints > 0 || idx < data.routes[routeidx].steps.length-1))) {
            var text = document.createTextNode(secondsToTimeStr(leg_dur));
            td.appendChild(text);
            td.className = "routetotal";
            nrof_waypoints += 1;
            leg_dur = 0;
          }
          tr.appendChild(td);
          table.appendChild(tr);
          
          if (idx < data.routes[routeidx].steps.length-1) {
            var tr = document.createElement("tr");
            var emptycols = 5;
            if (show_charging_costs) {
              emptycols += 1;
            }
            for (rep=0; rep < emptycols; rep++) {
              var td = document.createElement("td");
              td.className = "routenumber";
              tr.appendChild(td);
            }
            var drive_dur = step.drive_duration;
            var drive_dist = step.drive_dist/1000;
            for (var nextidx=idx+1; nextidx < data.routes[routeidx].steps.length-1 && data.routes[routeidx].steps[nextidx].wp_type == 1; nextidx++) {
              drive_dur += data.routes[routeidx].steps[nextidx].drive_duration;
              drive_dist += data.routes[routeidx].steps[nextidx].drive_dist/1000;
            }
            var text = document.createTextNode(secondsToTimeStr(drive_dur));
            td.appendChild(text);
            if (step.is_mod_speed) {
              var br = document.createElement("br");
              td.appendChild(br);
              var span = document.createElement("span");
              span.style.fontSize = "75%";
              span.style.color = "#ff4040";
              var text;
              if (units == "metric") {
                text = document.createTextNode("Max "+Math.round(step.max_speed*3.6)+" km/h");
              } else {
                text = document.createTextNode("Max "+Math.round(step.max_speed*3.6/1.609)+" mph");
              }
              span.appendChild(text);
              td.appendChild(span);
            }
            tr.appendChild(td);
            
            td = document.createElement("td");
            td.className = "routenumber";
            s = distStr(drive_dist);
            text = document.createTextNode(s);
            td.appendChild(text);
            tr.appendChild(td);
            
            td = document.createElement("td");
            td.className = "routenumber";
            tr.appendChild(td);
            if (show_times) {
              td = document.createElement("td");
              td.className = "routenumber";
              tr.appendChild(td);
              td = document.createElement("td");
              td.className = "routenumber";
              tr.appendChild(td);
            }
            table.appendChild(tr);
          }
        }
        if ("drive_duration" in step) {
          leg_dur += step.drive_duration + step.wait_duration;
        }
        if ("charge_duration" in step && !step.is_destcharger) {
          leg_dur += step.charge_duration;
        }
        
      }
      var tr = document.createElement("tr");
      tr.className = "routetotal";
      for (rep=0; rep < 1; rep++) {
        var td = document.createElement("td");
        tr.appendChild(td);
      }
      var td = document.createElement("td");
      td.colSpan = 2;
      text = "";
      if (units == "metric") {
        if (cons_units == "energy_per_distance") {
          text = Math.round(data.routes[routeidx].average_consumption)+" Wh/km";
        } else {
          text = convertConsUnits(data.routes[routeidx].average_consumption)+" km/kWh";
        }
        
      } else {
        if (cons_units == "energy_per_distance") {
          text = Math.round(data.routes[routeidx].average_consumption*1.609)+" Wh/mi";
        } else {
          text = convertConsUnits(data.routes[routeidx].average_consumption*1.609)+" mi/kWh";
        }
        
      }
      text = document.createTextNode(text)
      td.appendChild(text);
      tr.appendChild(td);
      
      var note = "";
      if (data.status == "SUBOPTIMAL") {
        nrof_footnotes += 1;
        for (var fn_idx=0; fn_idx < nrof_footnotes; fn_idx++) {
          note += "*";
        }
        suboptimal_footnote = note;
      }
      var car_model = findCarModel(data.carmodel);
      if (car_model.forum_url) {
        nrof_footnotes += 1;
      }

      var td = document.createElement("td");
      var text = document.createTextNode(secondsToTimeStr(data.routes[routeidx].total_charge_duration)+note);
      td.appendChild(text);
      tr.appendChild(td);
      if (show_charging_costs) {
        td = document.createElement("td");
        if (total_currency && total_currency != "VAR") {
          coststr = total_currency;
          if (coststr.length > 1) {
            coststr += " "
          }
          if (total_cost > 20) {
            coststr += total_cost.toFixed(0);
          } else {
            coststr += total_cost.toFixed(2);
          }
          text = document.createTextNode(coststr);
          td.appendChild(text);
        }
        tr.appendChild(td);
      }
      td = document.createElement("td");
      text = document.createTextNode(secondsToTimeStr(data.routes[routeidx].total_drive_duration)+note);
      td.appendChild(text);
      tr.appendChild(td);
      td = document.createElement("td");
      text = document.createTextNode(distStr(data.routes[routeidx].total_dist/1000)+note);
      td.appendChild(text);
      tr.appendChild(td);
      if (show_times) {
        td = document.createElement("td");
        tr.appendChild(td);
        td = document.createElement("td");
        tr.appendChild(td);
      }
      td = document.createElement("td");
      text = document.createTextNode(secondsToTimeStr(data.routes[routeidx].total_charge_duration+data.routes[routeidx].total_drive_duration)+note);
      td.appendChild(text);
      tr.appendChild(td);
      table.appendChild(tr);
      
      if (nrof_footnotes > 0) {
        var tr = document.createElement("tr");
        tr.className = "routetotal";
        td = document.createElement("td");
        
        if (data.status == "SUBOPTIMAL") {
          if (show_charging_costs) {
            var br = document.createElement("br");
            td.appendChild(br);
          }
          text = document.createTextNode(suboptimal_footnote+"This long route may not be optimal.");
          td.className = "routefootnote";
          td.appendChild(text);
        } 
        
        tr.appendChild(td);
        var car_model = findCarModel(data.carmodel);
        if (car_model && car_model.forum_url) {
          var td = document.createElement("td");
          td.colSpan = 30;
          text = document.createTextNode("Alpha car model,");
          td.append(text);
          var a = document.createElement("a");
          text = document.createTextNode("please submit feedback.");
          a.appendChild(text);
          a.title = "Alpha model feedback thread";
          a.href = car_model.forum_url;
          a.target = "_blank";
          td.className = "routefootnote";
          a.className = "routefootnote";
          td.appendChild(a);
          tr.appendChild(td);
        }
        table.appendChild(tr);
      }
      
      
      stepdiv.appendChild(table);
    } 
    if (plan.status == "NOT FOUND") {
      var stepdiv = document.getElementById("route-message-div");
      stepdiv.innerHTML = "";
      var div = document.createElement("div");
      var text;
      text = document.createTextNode("No plan found.  ");
      div.appendChild(text);

      var reportlink = document.createElement("a");
      reportlink.className = "labellink";
      text = document.createTextNode("(Report error)");
      reportlink.appendChild(text);
      var url = "plan_uuid="+plan["plan_uuid"]
      url = "https://"+window.location.hostname+window.location.pathname+"?"+url;
      reportlink.href = "mailto:bugs@abetterrouteplanner.com?subject=No route found&body="+encodeURIComponent("Hello ABRP,\n\nThe plan "+url+" gives no route found. That seems wrong because ...");
      div.appendChild(reportlink);
      div.className = 'routetext';
      stepdiv.appendChild(div);
      showPlanList(false);
      setCopyPlanButton(false);
    }
    if (!bigmap) {
      return;
    }

    if (use_old_mapbox) {
      bounds = L.latLngBounds();
    } else {
      bounds = new mapboxgl.LngLatBounds();
    }
    var routeidxvec = [];
    for (var route_idx=0; route_idx < data.routes.length; route_idx++) {
      if (route_idx != routeidx) {
        routeidxvec.push(route_idx);
      }
    }
    if (routeidx < data.routes.length) {
      if (show_alts) {
        routeidxvec.push(routeidx);
      } else {
        routeidxvec = [routeidx];
      }
    }
    var setbounds = false;
    for (var route_idx_idx in routeidxvec) {
      var route_idx = routeidxvec[route_idx_idx];
      var routelayer = {
        "id": "route"+route_idx,
        "type": "line",
        "source": {
          "type": "geojson",
          "data": {
            "type": "FeatureCollection",
            "features": [
            ]
          }
        },
        "layout": {
          "line-join": "round",
          "line-cap": "round"
        },
        "paint": {
          "line-color": ["get", "color"],
          "line-opacity": 0.5,
          "line-width": 8.0
        }
      };
      for (var idx = 0; idx < data.routes[route_idx].steps.length-1; idx++) {
        var step = data.routes[route_idx].steps[idx];
        var next_step = data.routes[route_idx].steps[idx+1];
        
        var first_lat = null;
        var first_lon = null;
        if ("route_soc" in step) {
          var is_prel_path = (step.route_soc.length == 0);
          var decodedpath = [];
          for (lineidx=0; lineidx < step.route_soc.length; lineidx++) {
            var lnglat = [step.route_soc[lineidx][1], step.route_soc[lineidx][0]];
            setbounds = true;
            var latlon = L.latLng(lnglat[1], lnglat[0]);
            if (use_old_mapbox) {
              decodedpath.push(latlon);
              if (recenter == "all" || (recenter == "firststep" && idx == 0)) {
                bounds.extend(latlon);
              }
            } else {
              decodedpath.push(lnglat);
              if (recenter == "all" || (recenter == "firststep" && idx == 0)) {
                bounds.extend(lnglat);
              }
            }
          }
          if (is_prel_path && "lat" in step && "lon" in step) {
            if (!first_lat) {
              first_lat = step.lat;  
              first_lon = step.lon;  
            }
            if (step.lat != first_lat || step.lon != first_lon) {
              setbounds = true;
            }
            if (use_old_mapbox) {
              decodedpath.push(L.latLng(step.lat, step.lon));
              bounds.extend(L.latLng(step.lat, step.lon));
            } else {
              bounds.extend([step.lon, step.lat]);
              decodedpath.push([step.lon, step.lat]);
            }
            if (next_step.lat != first_lat || next_step.lon != first_lon) {
              setbounds = true;
            }
            if (use_old_mapbox) {
              decodedpath.push(L.latLng(next_step.lat, next_step.lon));
              bounds.extend(L.latLng(next_step.lat, next_step.lon));
            } else {
              decodedpath.push([next_step.lon, next_step.lat]);
              bounds.extend([next_step.lon, next_step.lat]);
            }
          }
          var mapline = { 
            "type": "Feature",
            "properties": { },
            "geometry": {
              "type": "LineString",
              "coordinates": decodedpath
            }
          };
          
          mapline.properties.color = '#4080ff';
          if (route_idx != routeidx) {
            mapline.properties.color = '#808080';
          } else {
            if (step.is_mod_speed) {
              mapline.properties.color = '#ff4040';
            }
          }
          if (step.is_quickplan || is_prel_path) {
            mapline.properties.color = '#808080';
          }
          if (!(step.is_quickplan || is_prel_path)) {
            //addRouteClick(mapline, route_idx);
          }
          if (use_old_mapbox) {
            polyopts = { color: mapline.properties.color, opacity: 0.8, weight: 7.0};
            var polyline = L.polyline(decodedpath, polyopts).addTo(bigmap);
            routelines.push(polyline);
            polyline.on("click", bindEvent(onRouteClick, route_idx));
          } else {
            routelayer.source.data.features.push(mapline);
          }
        }
      }
      if (routeidx == route_idx) {
        for (var idx = 0; idx < data.routes[route_idx].steps.length; idx++) {
          step = data.routes[route_idx].steps[idx]
          var image = null;
          if (step.is_charger) {
            // Handle charger step via other means.  No action needed here.
            chrg.markRouteCharger(latLon(step.lat, step.lon), step.id, true, step.charger_type);
          } else  {
            var image = null;
            if (idx+1 == data.routes[route_idx].steps.length) {
              image = getNonChargerMapMarker("finish");
            } else if (idx == 0) {
              image = getNonChargerMapMarker("start");
            } else if (step.is_station) {
              image = getNonChargerMapMarker("ferry");
            } else {
              image = getNonChargerMapMarker("waypoint");
            }
          }
          if (image) {
            var marker = null;
            if (use_old_mapbox) {
              var iconopt = {iconUrl: image.element.src, iconSize: [image.element.width, image.element.height], iconAnchor: [10, 30]}
              var icon = L.icon(iconopt);
              marker = L.marker(L.latLng(step.lat, step.lon), {
                icon: icon,
                zIndexOffset: 12000
              }).addTo(bigmap);
              if (step.is_waypoint) {
                // Handle waypoint options like dragging.
              }
            } else {
              marker = new mapboxgl.Marker(image)
              .setLngLat([step.lon, step.lat])
              .addTo(bigmap);
            }
            if (marker != null) {
              routemarkers.push(marker);
            }
          }
        }
      }
      if (!use_old_mapbox) {
        bigmap.addLayer(routelayer);
        bigmap.on("click", "route"+route_idx, bindEvent(onRouteClick, route_idx) );
      }
    }
    if (recenter && setbounds) {
      bigmap.fitBounds(bounds);
    }
    
    if (selrouteidx < data.routes.length) {
      if (!planchanged && !(is_car_browser || is_car_active) && !isTipOpen() && !getDefaultStorageValue("tip_click_route", false)) {
        var stepidx = Math.floor((data.routes[routeidx].steps.length-1)/2);
        var step = data.routes[routeidx].steps[stepidx];
        if ("route_soc" in step) {
          var lineidx = Math.floor(step.route_soc.length/2);
          var latlon = latLon(step.route_soc[lineidx][0], step.route_soc[lineidx][1]);
          openTip("Click anywhere along a planned route to get information on speed, elevation and other assumptions.", latlon);
        }
      }
      
      if (!planchanged && !(is_car_browser || is_car_active) && !isTipOpen() && !getDefaultStorageValue("tip_click_charger", false)) {
        var stepidx = 0;
        while (!data.routes[routeidx].steps[stepidx].is_charger && stepidx < data.routes[routeidx].steps.length-1) {
          stepidx += 1;
        }
        var step = data.routes[routeidx].steps[stepidx];
        if (step.is_charger) {
          var latlon = latLon(step.lat, step.lon);
          openTip("Click on a charger icon to see information, exclude or include this charger and more.", latlon);
        }
      }
    }
  }
  
  function onWaypointMarkerClick(e, args) {
    var step_idx = args[0];
    highlightWaypoint(getDestIdxFromStep(step_idx));
  }
  
  function highlightWaypoint(waypoint_idx) {
    getWPInput(waypoint_idx).style.backgroundColor = "#60ff60";
    getWPInput(waypoint_idx).style.transition = "background-color 0.3s ease";
    setTimeout(function () { getWPInput(waypoint_idx).style.backgroundColor = null; }, 1000);
  }
  
  function isTipOpen() {
    return (tip_infowindow != null);
  }
  
  
  function closeTip() {
    if (tip_infowindow != null) {
      tip_infowindow.remove();
    }
    tip_infowindow = null;
  }
  
  function openTip(text, latlon) {
    closeTip();
    // infowindows.push(tip_infowindow);
    var content = "<div class=tipheading>Tip!</div><div class=tipinfo>"+text+"</div>";
    if (use_old_mapbox) {
      var popup = L.popup({"maxWidth": 700})
      .setLatLng(L.latLng(latlon[0],latlon[1]))
      .setContent(content)
      .openOn(bigmap);
      tip_infowindow = popup;
    } else {
      planinfowindow = new mapboxgl.Popup()
      .setLngLat(e.lngLat)
      .setDOMContent(content)
      .addTo(bigmap);
    }
    
  }
  
  function getNextVisibleWaypointIdx(step_idx) {
    var next_wp_idx = 0;
    for (next_wp_idx=step_idx+1; next_wp_idx < plan.routes[selrouteidx].steps.length-1 &&
    (!plan.routes[selrouteidx].steps[next_wp_idx].is_waypoint || plan.routes[selrouteidx].steps[next_wp_idx].is_charger || (("wp_type" in plan.routes[selrouteidx].steps[next_wp_idx]) && plan.routes[selrouteidx].steps[next_wp_idx].wp_type == 1)); next_wp_idx++);
    if (next_wp_idx >= plan.routes[selrouteidx].steps.length) {
      next_wp_idx = plan.routes[selrouteidx].steps.length-1;
    }
    
    return (next_wp_idx);
  }
  
  function getNextVisibleStepIdx(step_idx) {
    var next_idx = 0;
    for (next_idx = step_idx+1; next_idx < plan.routes[selrouteidx].steps.length-1 && (("wp_type" in plan.routes[selrouteidx].steps[next_idx]) && plan.routes[selrouteidx].steps[next_idx].wp_type == 1); next_idx += 1);
    if (next_idx >= plan.routes[selrouteidx].steps.length) {
      next_idx = plan.routes[selrouteidx].steps.length-1;
    }
    return (next_idx);
  }
  
  function onRouteClick(e, routeidx) {
    if (routeidx == selrouteidx) {
      var carlat;
      var carlon;
      if (use_old_mapbox) {
        carlat = e.latlng.lat;
        carlon = e.latlng.lng;
      } else {
        carlat = e.lngLat.lat;
        carlon = e.lngLat.lng;
      }
      if (debug) {
        setCarLocation(carlat, carlon, null, null, null);
        updateGADriving("debug");
        return;
      }
      
      closeTip();
      setStorageValue("tip_click_route", true);
      
      var min_step_idx = -1;
      var min_point_idx = -1;
      var min_dist = 10000000.0;
      for (var idx = 0; idx < plan.routes[selrouteidx].steps.length-1; idx++) {
        var step = plan.routes[selrouteidx].steps[idx];
        for (var point_idx=0; point_idx < step.route_soc.length; point_idx++) {
          dist = Math.abs(step.route_soc[point_idx][0]-carlat)+Math.abs(step.route_soc[point_idx][1]-carlon)
          if (idx != car_latest_wp_idx) {
            dist += 0.01; // If this is not the latest step index, make it less likely to be the closest
          }
          if (dist < min_dist) {
            min_point_idx = point_idx;
            min_step_idx = idx;
            min_dist = dist;
          }
        }
      }
      
      var next_wp_idx = getNextVisibleWaypointIdx(min_step_idx);
      var next_idx = getNextVisibleStepIdx(min_step_idx);
      if (min_step_idx < 0) {
        return;
      }
      if (planinfowindow) {
        planinfowindow.remove();
        planinfowindow = null;
      }
      
      var content = document.createElement("div");
      
      updateDriveGraph(min_step_idx, min_point_idx, next_idx, next_wp_idx, false);
      
      var div = document.createElement("div");
      div.style.backgroundColor = "rgba(0,0,0,0.6)";
      div.style.padding = "10px";
      var img = document.createElement("img");
      img.width = "500";
      var canvas = document.getElementById("drive-canvas");
      img.src = canvas.toDataURL();
      div.appendChild(img);
      content.appendChild(div);
      
      var point_data = plan.routes[selrouteidx].steps[min_step_idx].route_soc[min_point_idx];
      var ref_soc = point_data[2];
      var cons_per_km = point_data[3];
      var speed = point_data[4];
      var elevation = point_data[9];
      var speedlimit = point_data[8];        

      var table = document.createElement("table");
      var tr = document.createElement("tr");
    
      var td = document.createElement("td");
      td.className = "routeinfo";
      if (units == "metric") {
        if (cons_units == "energy_per_distance"){
          text = document.createTextNode("Planned consumption: "+cons_per_km+" Wh/km");
        } else {
          text = document.createTextNode("Planned consumption: "+Math.round(Math.pow(cons_per_km,-1)*1000*100)/100+" km/kWh");
        }
        
      } else {
        cons_per_km = Math.round(cons_per_km*1.609);
        if (cons_units == "energy_per_distance"){
          text = document.createTextNode("Planned consumption: "+cons_per_km+" Wh/mi");
        } else {
          text = document.createTextNode("Planned consumption: "+Math.round(Math.pow(cons_per_km,-1)*1000*100)/100+" mi/kWh");
        }
      }
      
      td.appendChild(text);
      tr.appendChild(td);
      
      var td = document.createElement("td");
      td.className = "routeinfo";
      if (units == "metric") {
        text = document.createTextNode("Elevation: "+Math.round(elevation)+" m");
      } else {
        text = document.createTextNode("Elevation: "+Math.round(elevation/0.3048)+" ft");
      }
      td.appendChild(text);
      tr.appendChild(td);
      table.appendChild(tr);
      
      var tr = document.createElement("tr");
      var td = document.createElement("td");
      td.className = "routeinfo";
      if (units == "metric") {
        text = document.createTextNode("Planned speed: "+speed+" km/h");
      } else {
        text = document.createTextNode("Planned speed: "+Math.round(speed/1.609)+" mph");
      }
      td.appendChild(text);
      tr.appendChild(td);
      
      if (speedlimit) {
        var td = document.createElement("td");
        td.className = "routeinfo";
        if ((typeof speedlimt) == "string") {
          text = document.createTextNode(speedlimit);
        } else {
          if (units == "metric") {
            text = document.createTextNode("Speed limit: "+speedlimit+" km/h");
          } else {
            text = document.createTextNode("Speed limit: "+Math.round(speedlimit/1.609)+" mph");
          }
        }
        td.appendChild(text);
        tr.appendChild(td);
      }
      table.appendChild(tr);
      
      // Create OSM edit link:
      var url = "https://www.openstreetmap.org/edit#map=16/" + carlat + "/" + carlon;
      var tr = document.createElement("tr");
      var td = document.createElement("td");
      td.colSpan = "2";
      td.className = "routeinfo";
      var a = document.createElement("a");
      a.className = "chargerinfo";
      a.href = url
      a.target = "_blank";
      a.innerHTML = "Speed Limit or Elevation incorrect? Edit Open Street Map.";
      td.appendChild(a);
      tr.appendChild(td);
      table.appendChild(tr);
      
      content.appendChild(table);
      
      if (use_old_mapbox) {
        var popup = L.popup({"maxWidth": 700})
        .setLatLng(L.latLng(carlat, carlon))
        .setContent(content)
        .openOn(bigmap);
      } else {
        planinfowindow = new mapboxgl.Popup()
        .setLngLat(e.lngLat)
        .setDOMContent(content)
        .addTo(bigmap);
      }
    } else {
      showRoute(plan, routeidx, false, true);
    }
  }
  
  function addRouteClick(line, routeidx) {
    google.maps.event.addListener(line, 'click', bindEvent(onRouteClick, routeidx));
    if (routeidx == selrouteidx) {
      google.maps.event.addListener(line, 'mouseover', function(e) { setMouseMarker(e.latLng);  });
      google.maps.event.addListener(line, 'mousemove', function(e) { setMouseMarker(e.latLng);  });
      google.maps.event.addListener(line, 'mouseout', function(e) {
        if (!route_mouse_marker_timeout && !route_mouse_marker_dragging) {
          route_mouse_marker_timeout = setTimeout(function () { route_mouse_marker_timeout = null; if (!route_mouse_marker_dragging || !route_drag_add_waypoint) { clearMouseMarker();}}, 500);
        }
      });
    }
  }
  
  function onWaypointMarkerDragStart(e, args) {
    // An existing waypoint is being dragged
    
    route_drag_step_idx = args[0];
    route_drag_add_waypoint = false;
    route_mouse_marker_dragging = true;
    route_drag_mouse_marker = args[1];
    if (plan && plan.plan_time < 10) {
      route_drag_full_replan = true;
    } else {
      route_drag_full_replan = false;
    }
  }
  
  
  function onRouteMouseMarkerDragStart(e) {
    var lat = e.latLng.lat();
    var lon = e.latLng.lng();
    var min_step_idx = -1;
    var min_point_idx = -1;
    var min_dist = 10000000.0;
    var new_point_idx = false;
    for (var idx = 0; idx < plan.routes[selrouteidx].steps.length-1; idx++) {
      var step = plan.routes[selrouteidx].steps[idx];
      for (var point_idx=0; point_idx < step.route_soc.length; point_idx++) {
        var dist = Math.abs(step.route_soc[point_idx][0]-lat)+Math.abs(step.route_soc[point_idx][1]-lon)
        if (dist < min_dist) {
          min_point_idx = point_idx;
          min_step_idx = idx;
          min_dist = dist;
        }
      }
    }
    if (min_step_idx < 0) {
      return;
    }
    route_drag_step_idx = min_step_idx;
    route_drag_add_waypoint = true;
    
    route_mouse_marker_dragging = true;
    route_drag_mouse_marker = route_mouse_marker;
    if (plan && plan.plan_time < 10) {
      route_drag_full_replan = true;
    } else {
      route_drag_full_replan = false;
    }
    
  }
  
  function onRouteMouseMarkerDrag(e) {
    if (route_drag_mouse_marker) {
      route_drag_mouse_marker.setPosition(e.latLng);
    }
    
    if (route_drag_planning_ongoing) {
      route_drag_next_event = e;
    } else {
      route_drag_next_event = null;
      route_drag_planning_ongoing = true;
      var fromstep = null;
      var tostep = null;
      if (route_drag_add_waypoint) {
        fromstep = plan.routes[selrouteidx].steps[route_drag_step_idx];
        tostep = plan.routes[selrouteidx].steps[route_drag_step_idx+1];
      } else {
        fromstep = plan.routes[selrouteidx].steps[route_drag_step_idx-1];
        tostep = plan.routes[selrouteidx].steps[route_drag_step_idx+1];
      }
      dest = [];
      if (fromstep) {
        dest.push(fromstep.lat+","+fromstep.lon);
      }
      dest.push(e.latLng.lat()+","+e.latLng.lng());
      if (tostep) {
        dest.push(tostep.lat+","+tostep.lon);
      }
      
      var url = 'https://abetterrouteplanner.com/planner3.cgi';
      var urldata = 'destinations='+(dest.join("|"))
      urldata += "&cmd=quickroute";
      
      ajax_plan_handle = $.post({ url: url, data: urldata, dataType: "json" })
      //console.log(url+"?"+urldata)
      .done(function(data) {
        route_drag_planning_ongoing = false;
        route_drag_latest_route = data;
        if (route_mouse_marker_dragging) {
          showDragRoute(data);
          if (route_drag_next_event) {
            onRouteMouseMarkerDrag(route_drag_next_event);
          }
        } else {
          if (!route_drag_full_replan) {
            if (route_drag_next_event) {
              onRouteMouseMarkerDrag(route_drag_next_event);
            } else {
              insertDragRoute(data);
            }
          }
        }
      })
      .fail(function() {
        route_drag_planning_ongoing = false;
        console.log("Quick plan failed");
      })
    }
  }
  
  function clearDragRoute() {
    for (idx=0; idx < route_drag_lines.length; idx++) {
      route_drag_lines[idx].setMap(null);
    }
    route_drag_lines = []
  }
  
  function showDragRoute(data) {
    clearDragRoute();
    route_idx = 0;
    for (var idx = 0; idx < data.routes[route_idx].steps.length-1; idx++) {
      var step = data.routes[route_idx].steps[idx];
      
      var decodedpath = [];
      for (lineidx=0; lineidx < step.route_soc.length; lineidx++) {
        var latlon = latLon(step.route_soc[lineidx][0], step.route_soc[lineidx][1]);
        bounds.extend(latlon);
        decodedpath.push(latlon);
      }
      var mapline = new google.maps.Polyline();
      var opts = {
        path: decodedpath,
        geodesic: true,
        strokeColor: '#808080',
        strokeOpacity: 0.6,
        strokeWeight: 10.0,
      };
      
      mapline.setOptions(opts);
      mapline.setMap(bigmap);
      addRouteClick(mapline, route_idx);
      route_drag_lines.push(mapline);
    }
  }
  
  
  
  function onRouteMouseMarkerDragEnd(e) {
    route_mouse_marker_dragging = false;
    clearDragRoute();
    if (!route_drag_planning_ongoing && route_drag_latest_route) {
      insertDragRoute(route_drag_latest_route);
    } else if (route_drag_full_replan) {
      insertDragRoute(null);
    }
    route_drag_latest_route = null;
  }
  
  function getDestIdxFromStep(step_idx) {
    var waypointidx = 0;
    for (var idx=0; idx < plan.routes[selrouteidx].steps.length && idx < step_idx; idx++) {
      if (plan.routes[selrouteidx].steps[idx].is_waypoint || idx==0 || idx == plan.routes[selrouteidx].steps.length-1) {
        waypointidx += 1;
      }
    }
    return (waypointidx);
  }
  
  function insertDragRoute(data) {
    var steps_to_add = 1;
    if (data) {
      steps_to_add = data.routes[0].steps.length-1;
    }
    
    var is_last = (route_drag_step_idx == plan.routes[selrouteidx].steps.length-1);
    var is_first = (route_drag_step_idx == 0 && !route_drag_add_waypoint);
    var route_insert_step_idx = route_drag_step_idx;
    if (!route_drag_add_waypoint && !is_first) {
      route_insert_step_idx -= 1;
    }
    var waypointidx = 0;
    if (route_drag_add_waypoint) {
      waypointidx = getDestIdxFromStep(route_drag_step_idx+1);
    } else {
      waypointidx = getDestIdxFromStep(route_drag_step_idx);
    }
    
    
    var oldstep = plan.routes[selrouteidx].steps[route_insert_step_idx];
    plan.routes[selrouteidx].steps.splice(route_insert_step_idx, 1);
    if (!route_drag_add_waypoint) {
      plan.routes[selrouteidx].steps.splice(route_insert_step_idx, 1);
    }
    
    
    if (is_last) {
      steps_to_add += 1;
    }
    var first_step_to_add = 1;
    if (is_first) {
      first_step_to_add = 0;
    }
    if (data) {
      for (var idx=0; idx < steps_to_add; idx++) {
        plan.routes[selrouteidx].steps.splice(route_insert_step_idx+idx, 0, data.routes[0].steps[idx]);
      }
      plan.routes[selrouteidx].steps[route_insert_step_idx].is_waypoint = oldstep.is_waypoint;
      plan.routes[selrouteidx].steps[route_insert_step_idx].is_charger = oldstep.is_charger;
      plan.routes[selrouteidx].steps[route_insert_step_idx].charger_type = oldstep.charger_type;
    }
    planchanged = true;
    
    
    var dests = getDestList(false);
    if (!route_drag_add_waypoint) {
      dests.splice(waypointidx, 1);
    }
    if (data) {
      for (var idx=first_step_to_add; idx < steps_to_add; idx++) {
        var lat = data.routes[0].steps[idx].lat;
        var lon = data.routes[0].steps[idx].lon;
        dest = ["", null, null, null, null, null, lat, lon];
        dests.splice(waypointidx+idx-first_step_to_add, 0, dest);
      }
    } else if (route_drag_next_event) {
      var lat = route_drag_next_event.latLng.lat();
      var lon = route_drag_next_event.latLng.lng();
      dest = ["", null, null, null, null, null, lat, lon];
      dests.splice(waypointidx, 0, dest);
    }
    
    setVias(dests);
    highlightWaypoint(waypointidx);
    if (route_drag_mouse_marker) {
      route_drag_mouse_marker.setMap(null);
      route_drag_mouse_marker = null;
    }
    if (route_drag_full_replan) {
      onPlanButton(false);
    } else {
      showRoute(plan, selrouteidx, false, true);
    }
    
  }
  
  function setMouseMarker(latlon) {
    if (route_mouse_marker == null) {
      var image = {
        url: staticurl+"icon/waypoint_icon.png",
        anchor: new google.maps.Point(12, 20)
      };
      route_mouse_marker = new google.maps.Marker({
        position: latlon,
        icon: image,
        map: bigmap,
        zIndex: 80,
        draggable: true,
        title: "Drag to change route"
      });
      google.maps.event.addListener(route_mouse_marker, 'dragstart', onRouteMouseMarkerDragStart);
      google.maps.event.addListener(route_mouse_marker, 'drag', onRouteMouseMarkerDrag);
      google.maps.event.addListener(route_mouse_marker, 'dragend', onRouteMouseMarkerDragEnd);
      google.maps.event.addListener(route_mouse_marker, 'click', bindEvent(onRouteClick, selrouteidx));
      
    } else {
      route_mouse_marker.setPosition(latlon);
    }
    if (route_mouse_marker_timeout) {
      clearTimeout(route_mouse_marker_timeout);
      route_mouse_marker_timeout = null;
    }
  }
  
  function clearMouseMarker() {
    if (route_mouse_marker != null) {
      route_mouse_marker.setMap(null);
      route_mouse_marker = null;
    }
  }
  
  function startCleanPlan() {
    toggleRoundTrip("disable");
    clearPlan();
    dest = [[], []];
    setDestList(dest);
  }

  function onClearPlanButton() {
    clearPlan();
    dest = [[], []];
    setDestList(dest);
    setStorageValueLocal("plan", plan);
    toggleRoundTrip("disable");
       
    var form = document.getElementById('plan-form');
    popupSetValueById("roadcondition", "normal");
    form.elements["windspeed"].value = 0;
    popupSetValueById("winddir", "head");
    
    if (units == "metric") {
      form.elements["outsidetemp"].value = "20";
    } else {
      form.elements["outsidetemp"].value = "68";
    }
    popupSetValueById("avoidclasses", "none");
 
    setBrowserURL(null);
    saveSettings(false);
  }
  
  function  clearPlan() {
    if (typeof clear_route == 'undefined') {
      clear_route = true;
    }
    clearRoute();
    plan = {};
    chrg.routechargers = {};
    var msgdiv = document.getElementById("route-message-div");
    while (msgdiv.firstChild) {
      msgdiv.removeChild(msgdiv.firstChild);
    }
    setCopyPlanButton(false);
    car_latest_point_idx = -1;
    car_latest_wp_idx = 0;
    lastupdatedrivegraphtime = null;
    navhidden = false;
    battery_manual_offset_soc = 0;
    battery_manual_verified = false;
    battery_manual_last_change = null;
    drivedisplay_graph_data_exists = null;
  }
  
  function clearRoute() {
    clearMouseMarker();
    var stepdiv = document.getElementById("route-div");
    while (stepdiv.firstChild) {
      stepdiv.removeChild(stepdiv.firstChild);
    }
    if (use_old_mapbox) {
      for (idx=0; idx < routelines.length; idx++) {
        routelines[idx].remove();
      }
      routelines = [];
    } else {
      for (var route_idx=0; route_idx < 3; route_idx++) {
        var layername = "route"+route_idx;
        if (bigmap.getSource(layername)) {
          bigmap.removeLayer(layername);
          bigmap.removeSource(layername);
        }
      }
    }
    for (idx=0; idx < routemarkers.length; idx++) {
      routemarkers[idx].remove();
    }
    routemarkers = [];
    for (id in chrg.routechargers) {
      var charger = chrg.routechargers[id];
      chrg.setInUse(charger,false);
    }
    car_turn_idx = -1;
    hideDriving();
  }
  
  function parseTime(s, utc_offset) {
    var d = null;
    if (s != null) {
      var timeparts = s.split(":");
      if (timeparts.length >= 2) {
        d = new Date();
        d.setUTCHours(parseInt(timeparts[0]));
        d.setUTCMinutes(parseInt(timeparts[1]));
        d.setSeconds(0);
        d.setTime(d.getTime()-utc_offset*1000);
      }
    }
    return d;
  }
  
  function processPlan(data, dest) {
    if (data === null) {
      return;
    }

    var charger_ids = [];

    var nrof_depart_times = 0;
    for (var idx=0; idx < dest.length; idx++) {
      if (dest[idx].length >= 5 && parseTime(dest[idx][5], 0) != null) {
        nrof_depart_times += 1;
      }
    }
    if (("routes" in data && data.routes.length > 0)) {
      var startd = new Date();
      var wpidx = 0;
      var step = data.routes[0].steps[0];
      var departtime = parseTime(dest[wpidx][5], step.utc_offset);
      if (departtime != null) {
        startd = new Date(departtime.getTime());
      }
      for (var routeidx=0; routeidx < data.routes.length; ++routeidx) {
        var d = new Date(startd);
        wpidx = 0;
        for (var idx=0; idx < data.routes[routeidx].steps.length; ++idx) {
          var step = data.routes[routeidx].steps[idx];
          step.arrival_time = new Date(d.getTime());
          if (step.is_charger || step.is_destcharger) {
            d.setTime(d.getTime() + step.charge_duration*1000);
            if (!(charger_ids.includes(step.id))) {
              charger_ids.push(step.id);
            }
          }
          if (step.wait_duration > 0) {
            d.setTime(d.getTime() + step.wait_duration*1000);
          }
          if (step.is_waypoint) {
            if (wpidx < dest.length && dest[wpidx].length >= 5) {
              departtime = parseTime(dest[wpidx][5], step.utc_offset);
              if (departtime != null) {
                d = new Date(departtime.getTime());
              }
            }
            wpidx += 1;
          }
          if ((nrof_depart_times > 0 || is_car_browser || is_car_active)) {
            step.departure_time = new Date(d.getTime());
          }
          if ("drive_duration" in step) {
            d.setTime(d.getTime() + step.drive_duration*1000);
          }
        }
      }
    }
    chrg.loadChargerIDs(charger_ids);
    return data;
  }
  
  function formatTime(date, utc_offset) {
    var date = new Date(date); // If it has been stored as JSON and restored as string
    var day_seconds = (date.getUTCHours()*60 + date.getUTCMinutes())*60 + utc_offset + 24*3600;
    var hours = (Math.floor(day_seconds/3600) % 24);
    var minutes = (Math.floor(day_seconds/60) % 60);
    
    var s = "";
    if (units == "metric") {
      if (hours   < 10) {hours   = "0"+hours;}
      if (minutes < 10) {minutes = "0"+minutes;}
      s = hours+':'+minutes;
    } else {
      var pf = "am";
      if (hours == 0) {
        hours = 12;
      } else if (hours == 12) {
        pf = "pm";
      } else if (hours > 12) {
        hours -= 12;
        pf = "pm";
      }
      if (minutes < 10) {minutes = "0"+minutes;}
      s = hours+":"+minutes+pf;
    }
    return s;
  }
  
  function planRoute(destinations, settings, find_next_charger_alts) {
    uridest = [];
    for (var idx=0; idx < destinations.length; idx++) {
      var destname = destinations[idx][0];
      if (destname && destname.length == 0) {
        destname = null;
      }
      var text = "";
      if (destinations[idx].length >= 4 && destinations[idx][3] != null) {
        text = "id:"+destinations[idx][3];
      } else if (destinations[idx].length > 7 && destinations[idx][6] != null) {
        text = destinations[idx][6]+","+destinations[idx][7];
        if (destname) {
          text += ",,"+destname; // No bearing known (index 2)
        }
      } else if (destname) {
        text = destname;
      }
      var chargetime = 0;
      var chargepower = 0;
      var chargeperc = 0;
      var arriveperc = 0;
      if (destinations[idx][2] != null) {
        var chargetimeparts = destinations[idx][2].split(":");
        if (chargetimeparts.length >= 2) {
          chargetime = parseInt(chargetimeparts[0])*60+parseInt(chargetimeparts[1]);
        }
      }
      if (destinations[idx][8] != null) {
        var tmp = destinations[idx][8];
        if (tmp.indexOf("%") >= 0) {
          tmp = tmp.substring(0, tmp.indexOf("%"));
        }
        if (tmp.length > 0) {
          chargeperc = parseInt(tmp);
        }
      }
      if (destinations[idx][10] != null) {
        var tmp = destinations[idx][10];
        if (tmp.indexOf("%") >= 0) {
          tmp = tmp.substring(0, tmp.indexOf("%"));
        }
        if (tmp.length > 0) {
          arriveperc = parseInt(tmp);
        }
      }
      if (destinations[idx][1]) {
        chargepower = parseFloat(destinations[idx][1]);
      }
      text += "§"+chargepower+"§"+chargetime;
      if (!destname && destinations[idx].length > 7 && destinations[idx][6] != null) {
        text += "§1"; // Waypoint type 1, dragged map waypoint
      } else if (destinations[idx].length > 9 && destinations[idx][9]) {
        text += "§2"; // Waypoint type 2, my_position
      } else {
        text += "§0";
      }
      text += "§"+chargeperc;
      text += "§"+arriveperc;
      uridest.push(encodeURIComponent(text));
    }
    var url = 'https://abetterrouteplanner.com/planner3.cgi';
    var urldata = 'destinations='+(uridest.join("|"))
    for (var key in settings) {
      urldata += "&"+key+"="+encodeURIComponent(settings[key]);
    }
    if (is_car_browser) {
      urldata += "&car_browser=true"
      if (is_new_car_browser) {
        urldata += "&new_car_browser=true"
      }
    } else {
      urldata += "&car_browser=false"
    }
    var routeurl = url+"?"+urldata;
    console.log(routeurl);
    
    // clearRoute();
    
    var spinnerdiv = document.getElementById("spinner-div");
    spinnerdiv.style.display = "";
    var spinnerdiv_nomap = document.getElementById("spinner-div-nomap");
    if (mapmode == "nomap") {
      spinnerdiv_nomap.style.display = "";
    }
    var spinnerdiv_plan = document.getElementById("spinner-div-plan");
    spinnerdiv_plan.style.display = "inline-block";
    setPlanButton(true);

    
    planning_ongoing = true;
    planning_canceled = false;
    updateGAPlanning(settings);
    ajax_plan_handle = $.post({ url: url, data: urldata, dataType: "json" })
    .done(function(data) {
      if (find_next_charger_alts) {
        next_charger_plans = processPlan(data, destinations);
        openInputDialog("Next Charger Alternatives", "", "nextcharger", onNextChargerSelected, "Select this charger", "Cancel", null, false);
      } else {
        if (data.status != "error") {
          clearPlan();
          if (data.status != "NOT FOUND") {
            plan = processPlan(data, destinations);
          }
          //console.log(plan);
          planchanged = false;
          if (!sharing_uuid) {
            setBrowserURL(plan.plan_uuid);
          }
          setStorageValueLocal("plan", plan);
          if (data.status != "NOT FOUND") {
            showRoute(plan, 0, "all", true);
          } else {
            showPreliminaryRoute(data.status); // If failed, show the grey line preliminary plan again.
          }
          getCarPos();
        } else {
          var stepdiv = document.getElementById("route-message-div");
          var div = document.createElement("div");
          var text = document.createTextNode(data.errortext);
          div.appendChild(text);
          div.className = 'routetext';
          stepdiv.appendChild(div);
          showPlanList(false);
          setCopyPlanButton(false);
        }
      }
      spinnerdiv.style.display = "none";
      spinnerdiv_nomap.style.display = "none";
      spinnerdiv_plan.style.display = "none";
      planning_ongoing = false;
      ajax_plan_handle = null;
      setPlanButton(false);
    })
    .fail(function() {
      if (!planning_canceled) {
        var stepdiv = document.getElementById("route-message-div");
        var div = document.createElement("div");
        var text = document.createTextNode("ABRP is offline. Try again when connected.");
        div.appendChild(text);
        div.className = 'routetext';
        stepdiv.appendChild(div);
        showPlanList(false);
        setCopyPlanButton(false);
      }
      spinnerdiv.style.display = "none";
      spinnerdiv_nomap.style.display = "none";
      planning_ongoing = false;
      ajax_plan_handle = null;
      setPlanButton(false);
    });
  }

  function onNextChargerSelected(yes, idx) {
    if (yes) {
      plan = next_charger_plans;
      plan.routes = [plan.routes[idx]];
    } 
    selrouteidx = 0;
    showRoute(plan, selrouteidx, "all", true);
  }
  
  function cancelPlan() {
    do_plan_on_position_obtained = false;
    if (ajax_plan_handle) {
      planning_canceled = true;
      ajax_plan_handle.abort();
      ajax_plan_handle = null;
    }
  }
  
  function closeAbout() {
    if (aboutopen) {
      var div = document.getElementById("about-div");
      div.style.display = "none";
      aboutopen = false;
      about_shown = true;

      initializePostLoading();
    }
  }
  
  function numberWithCommas(x) {
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }
  
  function refreshRouteCount() {
    refresh_route_count_handler = null;
    if ((aboutopen || fw_active)) {
      if  (browser_is_in_focus) {
        $.getJSON("https://abetterrouteplanner.com/db_data.py/route_count", { format: "json"})
        .done(function (count) {
          total_route_count = count;
          if (total_route_count >= 5000000 && fw_active == 0 && !is_car_browser) {
            startFireworks();
          }
          var div = document.getElementById("routecountdiv");
          while (div.firstChild) {
            div.removeChild(div.firstChild);
          }
          var text = document.createTextNode(numberWithCommas(count)+" Routes Planned!");
          div.appendChild(text);
          refresh_route_count_handler = setTimeout(refreshRouteCount, 10000);
        })
      } else {
        refresh_route_count_handler = setTimeout(refreshRouteCount, 10000);
      }
      
    }
  }
  
  function openAbout() {
    aboutopen = true;
    var div = document.getElementById("about-div");
    div.style.display = "";
    if (!refresh_route_count_handler) {
      refreshRouteCount();
    }
  }
  
  function closeDonate() {
    var div = document.getElementById("donate-div");
    div.style.display = "none";
  }
  
  function openDonate() {
    var div = document.getElementById("donate-div");
    div.style.display = "";
  }
  
  function convertConsUnits(cu) {
    //Converts Consumption Units in either direction, effectively inverts them.:
    //Wh/km -> km/kWh or Wh/mi -> mi/kWh
    //returned value has 3 sig figs.
    return parseFloat(1/cu*1000).toPrecision(3);
  }

  function getConsText(num) {
    var text = "";
    if (units == "metric" && cons_units == "energy_per_distance") {
      text = Math.round(num)+" Wh/km";
    } else if (units == "metric" && cons_units == "distance_per_energy") {
      text = convertConsUnits(num)+" km/kWh";
    } else if (cons_units == "energy_per_distance") {
      text = Math.round(num*1.609)+" Wh/mi";
    } else {
      text = convertConsUnits(num*1.609)+" mi/kWh";
    }
    return text;
  }
  function getConsHTML(num) {
    var html = "";
    if (units == "metric" && cons_units == "energy_per_distance") {
      html = Math.round(num) + '</span> <span class="driveunits">Wh/km</span></div></td>';
    } else if (units == "metric" && cons_units == "distance_per_energy") {
      html = convertConsUnits(num) + '</span> <span class="driveunits">km/kWh</span></div></td>';
    } else if (cons_units == "energy_per_distance") {
      html = Math.round(num*1.609) + '</span> <span class="driveunits">Wh/mi</span></div></td>';
    } else {
      html = convertConsUnits(num*1.609) + '</span> <span class="driveunits">mi/kWh</span></div></td>';
    }
    return html;
  }
  function setConsUnits(new_cons_units) {
    var old_cons_units = cons_units;
    if (new_cons_units == "toggle") {
      if (cons_units == "energy_per_distance")   { new_cons_units = "distance_per_energy"; }
      else                     { new_cons_units = "energy_per_distance"; }
    }
    cons_units = new_cons_units;
    
    //Set the text next to the settings appropriately.
    var button = document.getElementById("consumpunit");
    var input = document.getElementById("consumpvalue");
    if (units == "metric") {
      if (cons_units == "energy_per_distance"){
        button.value="Wh/km at 110 km/h";
        input.setAttribute("min",50);
        input.setAttribute("max",2000);
        input.setAttribute("step",1);
      } else {
        button.value="km/kWh at 110 km/h";
        input.setAttribute("min",0.01);
        input.setAttribute("max",20);
        input.setAttribute("step",0.01);
      }
    } else {
      if (cons_units == "energy_per_distance"){
        button.value="Wh/mi at 65 mph";
        input.setAttribute("min",50);
        input.setAttribute("max",2000);
        input.setAttribute("step",1);
      } else {
        button.value="mi/kWh at 65 mph";
        input.setAttribute("min",0.01);
        input.setAttribute("max",20);
        input.setAttribute("step",0.01);
      }
    }
    
    if (old_cons_units != cons_units) {
      if  (old_cons_units == "energy_per_distance"){
        // convert Wh/d to d/kWh
        // Invert and multiply by 1000
        input.value = convertConsUnits(input.value); //(Math.round(Math.pow(input.value,-1)*1000*100))/100);
      } else {
        // convert d/kWh to Wh/d
        // Invert and divide by 1000
        input.value = convertConsUnits(input.value); //input.value = Math.round(Math.pow(input.value,-1)*1000);
      }
    }
  }
  
  function setUnits(newunits) {
    var prevunits = units;
    units = newunits;
    
    if (units == "metric") {
      document.getElementById("metricradio").checked = true;
    } else {
      document.getElementById("imperialradio").checked = true;
    }
    
    setConsUnits(cons_units);
    var div = document.getElementById("maxspeedunit");
    while (div.firstChild) {
      div.removeChild(div.firstChild);
    }
    if (units == "metric") {
      var text = document.createTextNode("km/h");
      div.appendChild(text);
    } else {
      var text = document.createTextNode("mph");
      div.appendChild(text);
    }
    
    var div = document.getElementById("outsidetempunit");
    while (div.firstChild) {
      div.removeChild(div.firstChild);
    }
    if (units == "metric") {
      var text = document.createTextNode("C");
      div.appendChild(text);
    } else {
      var text = document.createTextNode("F");
      div.appendChild(text);
    }
    var div = document.getElementById("windspeedunit");
    while (div.firstChild) {
      div.removeChild(div.firstChild);
    }
    if (units == "metric") {
      var text = document.createTextNode("m/s");
      div.appendChild(text);
    } else {
      var text = document.createTextNode("mph");
      div.appendChild(text);
    }
    var div = document.getElementById("extra_weight_unit");
    while (div.firstChild) {
      div.removeChild(div.firstChild);
    }
    if (units == "metric") {
      var text = document.createTextNode("kg");
      div.appendChild(text);
    } else {
      var text = document.createTextNode("lbs");
      div.appendChild(text);
    }
    
    
    if (prevunits != units) {
      var input = document.getElementById("consumpvalue");
      var consump = input.value;
      if (prevunits == "imperial" && units == "metric") {
        if (cons_units == "energy_per_distance") {
          consump = consump/1.609/0.96;
        } else if (cons_units == "distance_per_energy"){
          consump = consump*1.609*0.96;
        }
      }
      if (units == "imperial" && prevunits == "metric") {
        if (cons_units == "energy_per_distance") {
          consump = consump*1.609*0.96;
        } else if (cons_units == "distance_per_energy"){
          consump = consump/1.609/0.96;
        }
      }
      input.value = Number.parseFloat(consump).toPrecision(3);
      
      var input = document.getElementById("max_speed");
      var max_speed = input.value;
      if (prevunits == "imperial" && units == "metric") {
        max_speed = max_speed*1.609;
      }
      if (units == "imperial" && prevunits == "metric") {
        max_speed = max_speed/1.609;
      }
      input.value = Math.round(max_speed);
      
      var form = document.getElementById('plan-form');
      var input = form.elements["outsidetemp"];
      var outside_temp = input.value;
      if (prevunits == "imperial" && units == "metric") {
        outside_temp = (outside_temp-32)/1.8;
      }
      if (units == "imperial" && prevunits == "metric") {
        outside_temp = (outside_temp*1.8+32);
      }
      input.value = Math.round(outside_temp);
      
      var input = form.elements["windspeed"];
      var wind_speed = input.value;
      if (prevunits == "imperial" && units == "metric") {
        wind_speed = wind_speed*1.609/3.6;
      }
      if (units == "imperial" && prevunits == "metric") {
        wind_speed = wind_speed/1.609*3.6;
      }
      input.value = Math.round(wind_speed);
      
      var input = form.elements["extra_weight"];
      var extra_weight = input.value;
      if (prevunits == "imperial" && units == "metric") {
        extra_weight = extra_weight*0.45;
      }
      if (units == "imperial" && prevunits == "metric") {
        extra_weight = extra_weight/0.45;
      }
      input.value = Math.round(extra_weight);
      
    }
    
    if (selrouteidx >= 0) {
      showRoute(plan, selrouteidx, false, true);
    }
  }
  
  function hideRouteplanner() {
    var div = document.getElementById("plan-overlay");
    div.style.display = "none";
    div = document.getElementById("show-button");
    div.style.display = "";
  }
  
  function showRouteplanner() {
    var div = document.getElementById("plan-overlay");
    div.style.display = "";
    div = document.getElementById("show-button");
    div.style.display = "none";
  }
  
  function showMyTesla() {
    var div = document.getElementById("mytesla-div");
    div.style.display = "";
    token = getDefaultStorageValue("mytesla_token", null);
    var logintable = document.getElementById("mytesla-table");
    var logoutbutton = document.getElementById("myteslalogout-button");
    if (token != null && !mytesla_expired) {
      logintable.style.display = "none";
      logoutbutton.style.display = "";
    } else {
      logintable.style.display = "";
      logoutbutton.style.display = "none";
    }
    var errdiv = document.getElementById("mytesla-login-error-div");
    errdiv.style.display = "none";
    getVehicles();
  }
  
  function closeMyTesla() {
    var div = document.getElementById("mytesla-div");
    div.style.display = "none";
  }
  
  function getVehicles() {
    var table = document.getElementById("vehicle-table");
    while (table.firstChild) {
      table.removeChild(table.firstChild);
    }
    
    token = getDefaultStorageValue("mytesla_token", null);
    if (token == null || mytesla_expired) {
      return;
    }
    
    var tr = document.createElement("tr");
    var th = document.createElement("th");
    th.className = "vehicleheading";
    var text = document.createTextNode("Select Vehicle");
    th.appendChild(text);
    tr.appendChild(th);
    th = document.createElement("th");
    th.className = "vehicleheading";
    var text = document.createTextNode("VIN");
    th.appendChild(text);
    tr.appendChild(th);
    th = document.createElement("th");
    th.className = "vehicleheading";
    var text = document.createTextNode("Option Codes");
    th.appendChild(text);
    tr.appendChild(th);
    table.appendChild(tr);
    
    var spinnerdiv = document.getElementById("mytesla-spinner");
    spinnerdiv.style.display = "";
    var url = 'teslacmd.py/get_data';
    var data = 'cmd=list_vehicles&token='+encodeURIComponent(token);
    
    $.post({ url: url, data: data, dataType: "json" })
    .done(function(data) {
      if (data.status == "ok") {
        if (data.response.length > 0) {
          var vehicle = data.response[0];
          setStorageValue("mytesla_vid", ""+vehicle.id);
          var form = document.getElementById('plan-form');
          form.elements["initialcharge"].value = '';
          getCarPos();
        }
        for (idx=0; idx < data.response.length; idx++) {
          var vehicle = data.response[idx];
          var tr = document.createElement("tr");
          tr.className = "vehiclerow";
          var td = document.createElement("td");
          var text = document.createTextNode(vehicle.display_name);
          td.appendChild(text);
          tr.appendChild(td);
          td = document.createElement("td");
          text = document.createTextNode(vehicle.vin);
          td.appendChild(text);
          tr.appendChild(td);
          td = document.createElement("td");
          text = document.createTextNode("Click to Copy");
          td.appendChild(text);
          td.addEventListener('click', bind(onShowOptionCodes, vehicle.option_codes));
          removeTeslaDoubleClick(td);
          tr.appendChild(td);
          table.appendChild(tr);
          tr.addEventListener('click', bind(onVehicleChosen, [""+vehicle.id, vehicle.option_codes]));
          removeTeslaDoubleClick(tr);
        }
      } else {
        var tr = document.createElement("tr");
        tr.className = "vehiclerow";
        var td = document.createElement("td");
        td.colSpan = "2";
        var text = null;
        if (data["errortext"].indexOf("503") >= 0) {
          text = document.createTextNode("Tesla MyTesla servers temporarily down.");
        } else if (data["errortext"].indexOf("401") >= 0) {
          text = document.createTextNode("Failed to get vehicles - login expired.");
        } else {
          text = document.createTextNode("Failed to get vehicles.");
        }
        td.appendChild(text);
        tr.appendChild(td);
        table.appendChild(tr);
      }
      spinnerdiv.style.display = "none";
    })
    .fail(function() {
      console.log('Get vehicles error.');
      spinnerdiv.style.display = "none";
    });
  }
  
  function onShowOptionCodes(codes) {
    window.prompt("These are the option codes for your vehicle. Copy and paste where you like.", codes);
  }
  
  function onVehicleChosen(params) {
    vid = params[0];
    option_codes = params[1];
    setStorageValue("mytesla_vid", vid);
    var form = document.getElementById('plan-form');
    setCarModel(carModelFromOptionCodes(option_codes));
    closeMyTesla();
    getCarPos();
    
    var form = document.getElementById('plan-form');
    form.elements["initialcharge"].value = '';
  }
  
  function showMyTeslaActive(on) {
    var indicator = document.getElementById("mytesla-login-button");
    if (on) {
      indicator.style.backgroundImage = "url('icon/green_dot.png')";
    } else {
      indicator.style.backgroundImage = "url('icon/grey_dot.png')";
    }
  }

  function myTeslaLogin() {
    var loginurl = 'teslacmd.py/login';
    var form = document.getElementById('mytesla-form');
    var myteslaemail = form.elements["myteslalogin"].value;
    var myteslapassword = form.elements["myteslapass"].value;
    var myteslatoken = form.elements["myteslatoken"].value;
    var share_data = form.elements["share_data"].value;
    var background_sharing = form.elements["background_sharing"].value;
    if (myteslatoken.length == 0 && (myteslaemail.length == 0 || myteslapassword.length == 0)) {
      return;
    }
    mytesla_expired = false;
    if (myteslatoken.length > 0) {
      setStorageValue("mytesla_token", myteslatoken);
      setStorageValue("mytesla_refresh_token", null);
      getVehicles();
      return;
    }
    var data = "login="+encodeURIComponent(myteslaemail)+"&"+"passwd="+encodeURIComponent(myteslapassword)
    if (share_data) {
      data += "&share_data=true";
    }
    if (background_sharing) {
      data += "&background_sharing=true";
    }
    var spinnerdiv = document.getElementById("mytesla-spinner");
    spinnerdiv.style.display = "";
    
    $.post({ url: loginurl, data: data, dataType: "json" })
    .done(function(data) {
      if ("access_token" in data) {
        setStorageValue("mytesla_token", data["access_token"]);
        setStorageValue("mytesla_refresh_token", data["refresh_token"]);
        setStorageValue("mytesla_next_refresh", (new Date()).getTime() + 3600*1000*24*7); // Refresh in a week
        getVehicles();
        
        var logintable = document.getElementById("mytesla-table");
        logintable.style.display = "none";
        var logoutbutton = document.getElementById("myteslalogout-button");
        logoutbutton.style.display = "";
        var errdiv = document.getElementById("mytesla-login-error-div");
        errdiv.style.display = "none";
      } else {
        var errdiv = document.getElementById("mytesla-login-error-div");
        errdiv.style.display = "";
        errdiv.innerHTML = "Login failed. Wrong email or password.";
      }
      spinnerdiv.style.display = "none";
    })
    .fail(function() {
      var errdiv = document.getElementById("mytesla-login-error-div");
      errdiv.style.display = "";
      errdiv.innerHTML = "Error contacting MyTesla servers. Try again later.";
      setStorageValue("mytesla_token", null);
      setStorageValue("mytesla_refresh_token", null);
      spinnerdiv.style.display = "none";
    });
  }
  
  function myTeslaLogout() {
    setStorageValue("mytesla_token", null);
    setStorageValue("mytesla_refresh_token", null);
    getVehicles();
    
    var logintable = document.getElementById("mytesla-table");
    logintable.style.display = "";
    var logoutbutton = document.getElementById("myteslalogout-button");
    logoutbutton.style.display = "none";
    
    var form = document.getElementById('plan-form');
    form.elements["initialcharge"].value = '90';
    showMyTeslaActive(false);
  }
  
  function showABRPAccountActive(on) {
    var indicator = document.getElementById("abrp-login-button");
    if (on) {
      indicator.style.backgroundImage = "url('icon/green_dot.png')";
    } else {
      indicator.style.backgroundImage = "url('icon/grey_dot.png')";
    }
  }

  function showLogin() {
    var div = document.getElementById("login-div");
    div.style.display = "";
    var errdiv = document.getElementById("login-error-div");
    errdiv.style.display = "none";
    var logintable = document.getElementById("login-table");
    var registertable = document.getElementById("register-table");
    var loggedintable = document.getElementById("loggedin-table");
    if (loginemail == null) {
      logintable.style.display = "";
      registertable.style.display = "";
      loggedintable.style.display = "none";
    } else {
      var loggedinspan = document.getElementById("loggedin-span");
      loggedinspan.innerHTML = loginemail;
      logintable.style.display = "none";
      registertable.style.display = "none";
      loggedintable.style.display = "";
    }
  }
  
  function closeLogin() {
    var div = document.getElementById("login-div");
    div.style.display = "none";
  }
  
  function login() {
    var loginurl = 'abrpaccount.py/login';
    var form = document.getElementById('login-form');
    var email = form.elements["abrlogin"].value;
    var password = form.elements["abrpass"].value;
    if (email.length == 0 || password.length == 0) {
      return;
    }
    var data = "email="+encodeURIComponent(email)+"&"+"passwd="+encodeURIComponent(password);
    
    $.post({ url: loginurl, data: data, dataType: "json" })
    .done(function(data) {
      if (data.status == "ok") {
        loginemail = email;
        showABRPAccountActive(true);
        closeLogin();
        loadSettings("");
      } else {
        loginemail = null;
        showABRPAccountActive(false);
        var errdiv = document.getElementById("login-error-div");
        errdiv.style.display = "";
        errdiv.innerHTML = "Login failed. Wrong email or password.";
      }
    })
    .fail(function() {
      console.log('Login error.');
      showABRPAccountActive(false);
      loginemail = null;
    });
  }
  
  function logout() {
    var loginurl = 'abrpaccount.py/logout';
    var email = loginemail;
    showABRPAccountActive(false);
    if (email == null) {
      return;
    }
    var data = "logout="+encodeURIComponent(email);
    
    $.post({ url: loginurl, data: data, dataType: "json" })
    .done(function(data) {
      loginemail = null;
      showLogin();
    })
    .fail(function() {
      console.log('Logout error.');
      loginemail = null;
      showLogin();
    });
  }
  
  function forgotPassword() {
    var loginurl = 'abrpaccount.py/forgot';
    var form = document.getElementById('login-form');
    var email = form.elements["abrlogin"].value;
    var password = form.elements["abrpass"].value;
    if (email.length == 0) {
      return;
    }
    var data = "email="+encodeURIComponent(email);
    
    $.post({ url: loginurl, data: data, dataType: "json" })
    .done(function(data) {
      if (data.status == "ok") {
        var errdiv = document.getElementById("login-error-div");
        errdiv.style.display = "";
        errdiv.innerHTML = "A password reset email has been sent to "+email;
      } else {
        var errdiv = document.getElementById("login-error-div");
        errdiv.style.display = "";
        errdiv.innerHTML = email+" is not a registered ABRP user.";
      }
    })
    .fail(function() {
      console.log("Password reset error");
    });
  }
  
  function register() {
    var errdiv = document.getElementById("login-error-div");
    var loginurl = 'abrpaccount.py/register';
    var form = document.getElementById('register-form');
    var email = form.elements["abrlogin"].value;
    var password = form.elements["abrpass"].value;
    var password2 = form.elements["abrpass2"].value;
    var fullname = form.elements["abrfullname"].value;
    if (email.length == 0 || password.length == 0 || password2.length == 0) {
      return;
    }
    if (password != password2) {
      var errdiv = document.getElementById("login-error-div");
      errdiv.style.display = "";
      errdiv.innerHTML = "Passwords do not match!";
      return;
    }
    var data = "email="+encodeURIComponent(email)+"&passwd="+encodeURIComponent(password)+
    "&fullname="+encodeURIComponent(fullname);
    
    $.post({ url: loginurl, data: data, dataType: "json" })
    .done(function(data) {
      if (data.status == "ok") {
        loginemail = email;
        errdiv.style.display = "none";
        closeLogin();
      } else if (data.status == "email_used") {
        loginemail = null;
        errdiv.style.display = "";
        errdiv.innerHTML = "Email is already registered.";
      } else {
        loginemail = null;
        errdiv.style.display = "";
        errdiv.innerHTML = "Registration error.";
      }
    })
    .fail(function() {
      console.log('Register error.');
      loginemail = null;
    });
  }
  
  
  // If carmodel is tesla, grab tesla, otherwise see if we have other telemetry
  
  var tlm_interval = 0;
  var obd_last_time = 0;
  var debug_plan_idx = 0;
  var get_car_pos_timeout = null;

  function refreshTlm() {
    has_tlm = null;
    hasTelemetry(true);
    reGetCarPos();
  }

  function reGetCarPos() {
    if (get_car_pos_timeout != null) {
      clearTimeout(get_car_pos_timeout);
      get_car_pos_timeout = null;
    }
    if (is_car_active) {
      // Telemetry exists, and car active
      tlm_interval = 5000;
    } else if (telemetry_received) {
      // Telemetry exists, but car inactive
      tlm_interval = 20000;
    } else {
      tlm_interval = 15*60*1000;
    }
    get_car_pos_timeout = setTimeout(getCarPosTimer, tlm_interval);
  }

  function getCarPosTimer() {
    get_car_pos_timeout = null;
    getCarPos();
  }

  function getCarPos() {
    if (debug && plan.routes && plan.routes.length > 0 && mapmode == "nomap") {
      // Step through the plan one data point per second.
      is_car_active = true;
      telemetry_received = true;
      if (debug_plan_idx >= plan.routes[0].steps[0].route_soc.length) {
        debug_plan_idx = 0;
      }
      var lat = plan.routes[0].steps[0].route_soc[debug_plan_idx][0];
      var lon = plan.routes[0].steps[0].route_soc[debug_plan_idx][1];
      // car_soc_perc = plan.routes[0].steps[0].route_soc[debug_plan_idx][2];
      setCarLocation(lat, lon, null, null, (new Date()).getTime());
      console.log(plan.routes[0].steps[0].route_soc[debug_plan_idx]);
      debug_plan_idx += 5;
      reGetCarPos();
    } else if (sharing_uuid != null) {
      getTelemetry("sharing");
    } else if (hasMyTesla()) {
      getTeslaTelemetry();
    } else if (hasTelemetry()) {
      getTelemetry("session");
    }else {
      getOBDTelemetry();
    } 
  }

  function displayCarTelemetry (soc, speed, outside_temp, power, model, res) {
    //All telemetry stored in SI
    //If running this function, just got new data.
    if (res === undefined) {
      res = {};
    }
    var message_div = document.getElementById("tlm_message");
    while (message_div.firstChild) {
      message_div.removeChild(message_div.firstChild);
    }
    if ("message" in res) {
      var text = document.createTextNode(res["message"]);
      message_div.appendChild(text);
    }
    if (outside_temp == "--") {
      outside_temp = null;
    }
    if (power == "--") {
      power = null;
    }
    var batt_temp = null;
    if ("batt_temp" in res) {
      batt_temp = res["batt_temp"]
    }
    if (units == "metric") {
      document.getElementById("speed_units").innerHTML = "km/h";
      document.getElementById("ext_temp_units").innerHTML = "°C";
      document.getElementById("batt_temp_units").innerHTML = "°C";
    } else {
      speed = speed/1.609;
      if (outside_temp) {
        outside_temp = outside_temp*9/5 + 32;
      }
      if (batt_temp) {
        batt_temp = batt_temp*9/5 + 32;
      }
      document.getElementById("speed_units").innerHTML = "mi/h";
      document.getElementById("ext_temp_units").innerHTML = "°F";
      document.getElementById("batt_temp_units").innerHTML = "°F";
    }
    if (soc != null) {
      document.getElementById("soc_tlm").innerHTML = roundToPlace(soc,1);
    }    
    if ("soh" in res) {
      document.getElementById("soh_tlm").innerHTML = roundToPlace(res["soh"],1);
    }
    if ("batt_temp" in res) {
      document.getElementById("batt_temp_tlm").innerHTML = Math.round(Number.parseFloat(batt_temp));
    }
    if ("is_charging" in res && res["is_charging"]) {
      document.getElementById("is_charging_tlm").innerHTML = "Yes"
    } else if ("is_charging" in res && !res["is_charging"]) {
      document.getElementById("is_charging_tlm").innerHTML = "No"
    }
    if (speed != null) {
      document.getElementById("speed_tlm").innerHTML = roundToPlace(speed,0);
    }
    if (outside_temp != null) {
      document.getElementById("temperature_tlm").innerHTML = Math.round(Number.parseFloat(outside_temp));
    }
    if (power != null) {
      document.getElementById("power_tlm").innerHTML = roundToPlace(power,1);
    }
    if (model != null) {
      var name = model;
      if (model.indexOf(":") >=0) {
        name = model.split(":")[1] + model.split(":")[3];
      }
      document.getElementById("model_tlm").innerHTML = name;
    }
    document.getElementById("tlm_age").innerHTML = Math.round(res["tlm_age"]);
    tlmfields = document.getElementsByClassName("tlm");
    for (var i = 0; i < tlmfields.length; i++) {
        tlmfields[i].style.backgroundColor="";
    }
    document.getElementById("tlm-button").style.backgroundImage = "url('icon/green_dot.png')";
  }

  function setCarTelemetryStale () {
    document.getElementById("tlm-button").style.backgroundImage = "url('icon/grey_dot.png')";
    tlmfields = document.getElementsByClassName("tlm");
    for (var i = 0; i < tlmfields.length; i++) {
        tlmfields[i].style.backgroundColor="cyan";
    }
  }

  var telemetry_req_in_progress = false;
  function hasTelemetry(refresh) {
    if (refresh === undefined) {
      refresh = false;
    }
    if (telemetry_req_in_progress) {
      return;
    }
    if (has_tlm !== null && has_tlm && !refresh) {
      return has_tlm
    }
    telemetry_req_in_progress = true;
    var url = "https://abetterrouteplanner.com/telemetry.py/get_user_telemetry?session_id="+encodeURIComponent(session_id);
    $.getJSON(url, { format: "json"})
    .done(function(data) {
      if (data.status == "ok") {
        has_tlm = true;
      } else {
        has_tlm = false;
      }
      telemetry_req_in_progress = false;
    })
    .fail(function() {
      console.log("Could not get telemetry status.");
    });
  }

  function setNextChargeTo(next_charge_perc){
    var url = "telemetry.py/set_next_charge_perc?session_id="+session_id+"&next_charge_perc="+next_charge_perc;
    $.post({ url: url})
      .done(function(res) {
        //console.log('Set next charge to '+next_charge_perc);
      })
      .fail(function() {
        console.log('Set next charge to error.');
      });
  }
  var carmodel_fixed = false;
  function getTelemetry(tlm_type) {
    if (telemetry_req_in_progress) {
      return;
    }
    var url = "";
    if (tlm_type == "sharing") {
      url = "https://abetterrouteplanner.com/telemetry.py/get_sharing_telemetry?uuid="+encodeURIComponent(sharing_uuid);
    } else if (session_id) {
      url = "https://abetterrouteplanner.com/telemetry.py/get_user_telemetry?session_id="+encodeURIComponent(session_id);
    } else {
      return;
    }
    telemetry_req_in_progress = true;
    $.getJSON(url, { format: "json"})
    .done(function(data) {
      if (data.status == "ok") {
        var res = data.result;
        telemetry_recv_time = (new Date()).getTime();
        var tlm_age = (new Date()).getTime() / 1000 - res.utc;
        res["tlm_age"] = tlm_age;
        if ("outside_temp" in res) {
          res["ext_temp"] = res["outside_temp"]
        }
        if ("carmodel" in res) {
          res["car_model"] = res["carmodel"];
        }
        displayCarTelemetry(res["soc"],res["speed"],res["ext_temp"],res["power"],res["car_model"],res);
        if (tlm_age > 120) {
          setCarTelemetryStale();
        }
        telemetry_received = true;
        var carmodel = getCarModel();
        if (carmodel != res["car_model"] && !carmodel_fixed && tlm_age < 20) {
          carmodel_fixed = true;
          console.log("Fixing car model.");
          setCarModel(res["car_model"]);
          onModelChange();
        }
        if (res.speed != null) {
          car_speed = res["speed"]/3.6; // Given in km/h
        } else {
          car_speed = 0.0;
        }
        is_car_active = (res.speed || res.is_charging) && tlm_age < 120;
        car_soc_perc = res["soc"];
        loc = {"elevation": res.elevation};
        if ("lat" in res && "lon" in res) {
          setCarLocation(res["lat"], res["lon"], res["heading"], loc, res["utc"]*1000);
        }
        var form = document.getElementById('plan-form');
        form.elements["initialcharge"].placeholder = String(Math.round(car_soc_perc));
        // Implement charge curve and recalibrate later.  Get min functionality first.
        if (res["is_charging"] && res["charger_power"]) {
          if (car_charge_start_time == null) {
            car_charge_start_time = res["utc"];
          }
          car_charge_power = roundToPlace(res["charger_power"],1);
          if (car_charge_profile_soc_perc.length <= 10 || car_charge_profile_soc_perc[car_charge_profile_soc_perc.length-1] != car_soc_perc) {
            car_charge_profile_power.push(car_charge_power);
            car_charge_profile_soc_perc.push(car_soc_perc);
            car_charge_profile_time.push((res["utc"]-car_charge_start_time));
          }
        } else {
          car_charge_start_time = null;
          car_charge_power = null;
          car_charge_energy = null;
          car_charge_profile_time = [];
          car_charge_profile_power = [];
          car_charge_profile_soc_perc = [];
        }
      } else {
          console.log("No sharing telemetry found.");
          telemetry_received = false;
      }
      telemetry_req_in_progress = false;
      reGetCarPos();
    })
    .fail(function() {
      console.log("Error in getting sharing telemetry.");
      telemetry_req_in_progress = false;
      reGetCarPos();
    });
  }

  function getOBDTelemetry() {
    // Check to see if we have an active user in the OBD_users database. If so, and there's active
    // (last 30 seconds) telemetry, then we call it an active session and use that data.
    // Need to acquire the following:

    var url = "https://abetterrouteplanner.com/obd_telem.py/get_latest?session_id=" + session_id;
    var this_time = (new Date()).getTime() / 1000;
    if (obd_req_in_progress) {
      return;
    }
    last_req_time = this_time;
    obd_req_in_progress = true;
    $.getJSON(url, { format: "json"})
    .done(function(data) {
      if (data.status == "ok") {
        telemetry_recv_time = (new Date()).getTime();
        setStorageValue("OBD_user", true);
        var tlm_age = (new Date()).getTime() / 1000 - data["utc"]
        displayCarTelemetry(data["car_soc_perc"],data["car_speed"],data["temp"],data["pwr"],data["carmodel"]);
        if ("car_soc_perc" in data && data["car_soc_perc"] != "--") {
          stale_car_soc_perc = data["car_soc_perc"];
        }
        if (tlm_age > 20) {
          setCarTelemetryStale();
        }
        if (tlm_age > 300) { 
          // Telemetry is stale, older than 5 minutes
          is_car_active = false;
          telemetry_received = false;
        } else {
          // Got recent telemetry       
          var dt = 1;
          dt = Math.max(dt,data["dt"]);
          dt = Math.min(dt,10);
          dt *= 1000;
          // For now, set statically based on is_car_active
          //tlm_interval = dt;
          telemetry_received = true;
          OBD_active = true;
          var carmodel = getCarModel();
          if (carmodel != data["carmodel"]) {
            console.log("Got mismatched carmodels",carmodel,data["carmodel"], "fixing")
            setCarModel(data["carmodel"]);
            onModelChange();
          }
          is_car_active = true;
          car_speed = data["car_speed"]/3.6; // Given in km/h
          car_soc_perc = data["car_soc_perc"];
          setCarLocation(data["lat"], data["lon"], null, data, data["utc"]*1000);
          var form = document.getElementById('plan-form');
          form.elements["initialcharge"].placeholder = String(Math.round(car_soc_perc));
          // Implement charge curve and recalibrate later.  Get min functionality first.
          if (data["is_charging"] && data["car_charger_power"] != null) {

            if (car_charge_start_time == null) {
              car_charge_start_time = data["utc"];
            }
            //Reverse the power reading for charging, so the graph looks good.
            if (data["car_charger_power"] < 0) {
              data["car_charger_power"] *= -1;
            }
            car_charge_power = roundToPlace(data["car_charger_power"],1);
            if (car_charge_profile_soc_perc.length <= 10 || car_charge_profile_soc_perc[car_charge_profile_soc_perc.length-1] != car_soc_perc) {
              car_charge_profile_power.push(car_charge_power);
              car_charge_profile_soc_perc.push(car_soc_perc);
              car_charge_profile_time.push((data["utc"]-car_charge_start_time));
            }
          } else {
            car_charge_start_time = null;
            car_charge_power = null;
            car_charge_energy = null;
            car_charge_profile_time = [];
            car_charge_profile_power = [];
            car_charge_profile_soc_perc = [];
          }
          obd_req_in_progress = false;
          reGetCarPos();
        }
      } else if (data.status == "no_data") {
          // There is no OBD telemetry data for this user at all
          console.log("No OBD data found.");
          telemetry_received = false;
          reGetCarPos();
      }
      obd_req_in_progress = false;
    })
    .fail(function() {
      console.log("Error in getting telemetry.");
      obd_req_in_progress = false;
      reGetCarPos();
    });
  }

  function getTeslaTelemetry() {
    var token = getDefaultStorageValue("mytesla_token", null);
    var refresh_token = getDefaultStorageValue("mytesla_refresh_token", null);
    var vid = getDefaultStorageValue("mytesla_vid", null);
    if (token == null || vid == null || mytesla_expired || mytesla_down) {
      return;
    }
    if (myteslacmd_ongoing) {
      console.log("Ongoing MyTesla request, wait");
      return;
    }
    if (!browser_is_in_focus && !is_car_browser && !is_car_active) {
      console.log("Browser window is not active and car is inactive, do not poll.");
      return;
    }
    var next_refresh = getDefaultStorageValue("mytesla_next_refresh", 0);
    if ((new Date()).getTime() > next_refresh && refresh_token) { // Refresh mytesla token
      console.log("Refreshing MyTesla token...");
      var url = 'teslacmd.py/refresh_login';
      data = 'refresh_token='+encodeURIComponent(refresh_token);
      myteslacmd_ongoing = true;
      $.post({ url: url, data: data, dataType: "json" })
      .done(function(data) {
        myteslacmd_ongoing = false;
        if ("access_token" in data) {
          setStorageValue("mytesla_token", data["access_token"]);
          setStorageValue("mytesla_refresh_token", data["refresh_token"]);
          setStorageValue("mytesla_next_refresh", (new Date()).getTime() + 3600*1000*24*7); // Refresh in a week
          console.log("Refreshed MyTesla token!");
        } else {
          myteslacmd_ongoing = false;
          setStorageValue("mytesla_next_refresh", (new Date()).getTime() + 3600*1000*24); // Refresh tomorrow
          console.log('Refresh token failed.');
        }
        getCarPos();
      })
      .fail(function() {
        myteslacmd_ongoing = false;
        setStorageValue("mytesla_next_refresh", (new Date()).getTime() + 3600*1000*24); // Refresh tomorrow
        console.log('Refresh token error.');
      });
      return;
    }
    var url = 'teslacmd.py/get_data';
    data = 'cmd=get_drive_charge_state&vehicle_id='+encodeURIComponent(vid)+'&token='+encodeURIComponent(token)+'&refresh_token='+encodeURIComponent(refresh_token);
    if (car_on_route) {
      data += "&getroadinfo=false";
    } else {
      data += "&getroadinfo=true";
    }
    myteslacmd_ongoing = true;
    $.post({ url: url, data: data, dataType: "json" })
    .done(function(data) {
      myteslacmd_ongoing = false;
      if (data["status"] == "ok") {
        //console.log(data);
        if (hasMyTesla()) { // Check so we didn't recently logout
          showMyTeslaActive(true);
        }
        telemetry_received = true;
        if (telemetry_recv_time == null) {
          console.log("MyTesla pos received.");
        }
        telemetry_recv_time = (new Date()).getTime();
        telemetry_received = true;
        getcarposerrors = 0;
        checkWatchdog();
        var shift_state = data["drive_state"].response.shift_state;
        if (shift_state && shift_state == "P" ) {
          shift_state = null;
        }
        var charging_state = data["charge_state"].response.charging_state;
        var is_charging = (charging_state != null && charging_state == "Charging")
        var new_car_soc_perc = data["charge_state"].response.usable_battery_level;
        var new_car_range = data["charge_state"].response.battery_range;
        if (new_car_soc_perc > 50 && new_car_range != null && new_car_soc_perc != last_car_soc_perc) { // Update SoC-per-range estimate only when SoC changes
          if (car_range_per_perc != null) {
            car_range_per_perc = 0.9*car_range_per_perc + 0.1*(new_car_range)/(new_car_soc_perc);
          } else {
            car_range_per_perc = (new_car_range)/(new_car_soc_perc);
          }
          setStorageValue("car_range_per_perc", car_range_per_perc);
        }
        last_car_soc_perc = new_car_soc_perc;
        if (is_charging) {
          if (car_charge_start_time == null) {
            car_charge_start_time = telemetry_recv_time;
          }
          car_charge_power = data["charge_state"].response.charger_power;
          car_charge_energy = data["charge_state"].response.charge_energy_added;
          if (car_charge_profile_soc_perc.length <= 10 || car_charge_profile_soc_perc[car_charge_profile_soc_perc.length-1] != new_car_soc_perc) {
            car_charge_profile_power.push(car_charge_power);
            car_charge_profile_soc_perc.push(new_car_soc_perc);
            car_charge_profile_time.push((telemetry_recv_time-car_charge_start_time)/1000);
          }
        } else {
          car_charge_start_time = null;
          car_charge_power = null;
          car_charge_energy = null;
          car_charge_profile_time = [];
          car_charge_profile_power = [];
          car_charge_profile_soc_perc = [];
        }
        car_range = new_car_range;
        if (car_range_per_perc) { // Set SoC based on car range to increase precision
          car_soc_perc = car_range/car_range_per_perc;
        } else {
          car_soc_perc = new_car_soc_perc;
        }

        if (shift_state == null && !is_charging) {
          is_car_active = false;
        } else {
          if (!is_car_active) {
            is_car_active_start_time = (new Date()).getTime();
          }
          is_car_active = true;
        }
        if (data["drive_state"].response.speed != null) {
          car_speed = data["drive_state"].response.speed*1.609/3.6; // MPH? Tesla - whut?
        } else {
          car_speed = null;
        }
        updateGADriving("mytesla");
        setCarLocation(data["drive_state"].response.latitude, data["drive_state"].response.longitude, data["drive_state"].response.heading, 
          data.location, data["drive_state"].response.timestamp);
        var outside_temp = null;
        if ("climate_state" in data && data.climate_state && "outside_temp" in data.climate_state.response) {
          outside_temp = data.climate_state.response.outside_temp;
        }
        var power = null;
        if ("drive_state" in data && data.drive_state && "power" in data.drive_state.response) {
          power = data.drive_state.response.power;
        }
        displayCarTelemetry(car_soc_perc, car_speed*3.6, outside_temp, power, null);
        car_shift_state = shift_state;
        if (car_shift_state == null) {
          car_idle_count += 1;
        } else {
          car_idle_count = 0;
        }
        
        var form = document.getElementById('plan-form');
        form.elements["initialcharge"].placeholder = String(Math.round(car_soc_perc));
        
      } else if (data["errortext"].indexOf("401") >= 0) {
        console.log("MyTesla error"+data.errortext);
        showToast("MyTesla login has expired - please log in again.");
        mytesla_expired = true;
        getcarposerrors += 1;
      } else if (data["errortext"].indexOf("503") >= 0) {
        showToast("Tesla MyTesla server temporarily unavailable. Hopefully back soon!");
        mytesla_down = true;
        getcarposerrors += 1;
      } else {
        console.log("Get pos failed, "+data["errortext"]);
        getcarposerrors += 1;
      }
      reGetCarPos();
      
    })
    .fail(function() {
      myteslacmd_ongoing = false;
      console.log('Get pos error.');
      reGetCarPos();
    });
  }
  
  function hasMyTesla() {
    token = getDefaultStorageValue("mytesla_token", null);
    vid = getDefaultStorageValue("mytesla_vid", null);
    return (token != null && vid != null);
  }
  function hasOBD() {
    var obd = getDefaultStorageValue("OBD_user", null);
    return (obd != null);
  }
  
  function hideToast() {
    var toastdiv = document.getElementById("toast-center-div");
    toastdiv.style.display = "none";
  }
  
  function showToast(msg) {
    var toastdiv = document.getElementById("toast-center-div");
    toastdiv.style.display = "";
    toastdiv = document.getElementById("toast-div");
    while (toastdiv.firstChild) {
      toastdiv.removeChild(toastdiv.firstChild);
    }
    var text = document.createTextNode(msg);
    toastdiv.appendChild(text);
    setTimeout(hideToast, 6000);
  }
  
  function onHistorySelected(idx, entries) {
    var dest = getDestList(false);
    if ("lat" in entries[idx] && "lon" in entries[idx]) {
      dest[history_wp_idx][6] = entries[idx].lat;
      dest[history_wp_idx][7] = entries[idx].lon;
    } else {
      dest[history_wp_idx][6] = null;
      dest[history_wp_idx][7] = null;
    }
    setDestList(dest);
    onWaypointNameDone(history_wp_idx);
    setStorageValue("searchhistory", entries);
    saveSettings(false);
    showPreliminaryRoute(null);
  }
  
  function onHistoryPinned(idx, entries) {
    setStorageValue("searchhistory", entries);
    saveSettings(false);
  }
  
  
  function updateHistory() {
    var entries = getDefaultStorageValue("searchhistory", []);
    for (var idx=0; idx < viainputs.length; idx++) {
      if (viainputs[idx][0] && viainputs[idx][0].nodeName == "INPUT") {
        popupPopulate(viainputs[idx][0], entries);
      }
    }
  }
  
  function setCarModel(model) {
    if (!model) {
      return;
    }
    popupSetValueById("carmodelpopup", model);
    
    if (model.indexOf(":") >= 0 && model.indexOf("tesla") < 0) {
      // This is not a Tesla
      document.getElementById("mytesla-login-button").style.display = "none";
    } else {
      // This is a Tesla.
      document.getElementById("mytesla-login-button").style.display = "initial";
    }
    if (model in obd_instr.model_map) {
      document.getElementById("tlm-setup").style.display = "initial";
    } else {
      document.getElementById("tlm-setup").style.display = "none";
    }
  }
  
  function getCarModel() {
    return popupGetValueById("carmodelpopup");
  }

  function populateDropdowns() {
    
    var winds = [{"title":"Headwind", "value":"head"}, {"title":"Tailwind", "value":"tail"}];
    popupPopulateById("winddir", winds);
    
    var conds = [{"title":"Dry roads", "value":"normal"}, {"title":"Rain or Snow (+10%)", "value":"rain"}, {"title":"Heavy Rain or Snow (+20%)", "value":"heavy_rain"}];
    popupPopulateById("roadcondition", conds)
    
    var regions = [{"title":"   North America", "value":"na"}, {"title":"   Europe", "value":"eu"}]
    popupPopulateById("plugregion", regions)

    var avoid = [{"title":"Nothing in Particular", "value":"none"}, {"title":"Ferries and Car Trains", "value":"ferry"}, {"title":"Toll Roads", "value":"toll"}, {"title":"Highways", "value":"motorway"}];
    popupPopulateById("avoidclasses", avoid);
  }

  function popupPopulateById(inputid, entries) {
    var input = document.getElementById(inputid);
    popupPopulate(input, entries);
  }
  
  function popupPopulate(input, entries) {
    input.dataset.entries = JSON.stringify(entries);
  }
  
  function popupOutsideClick(event) {
    popupClose();
  }
  
  
  function popupClose() {
    if (popupdiv != null) {
      popupdiv.parentElement.removeChild(popupdiv);
      popupdiv = null;
    }
  }
  
  function popupOpen(input, selected_callback, pinned_callback) {
    var bgdiv = document.createElement("div");
    bgdiv.style.position = "fixed";
    bgdiv.style.zIndex = 1;
    bgdiv.style.top = "0";
    bgdiv.style.left = "0";
    bgdiv.style.width = "100%";
    bgdiv.style.height = "100%"
    bgdiv.style.backgroundColor = "rgba(0,0,0,0.4)";
    bgdiv.addEventListener('click', popupOutsideClick);
    removeTeslaDoubleClick(bgdiv);
    
    var input_rect = input.getBoundingClientRect();
    var div = document.createElement("div");
    div.className = "popup";
    div.style.position = "absolute";
    div.style.width = input.offsetWidth+"px";
    div.style.top = input_rect.bottom+"px";
    div.style.left = input_rect.left+"px";
    div.style.width = input_rect.width+"px";
    div.style.maxHeight = "70%";
    
    var entries = JSON.parse(input.dataset.entries);
    var table = document.createElement("table");
    table.style.width = "100%"
    popuptable = table;
    popupdiv = bgdiv;
    popupinput = input;
    popup_selected_levels = [];
    popupBuildTable(table, entries, selected_callback, pinned_callback);
    div.appendChild(table);
    
    var parent = input.parentElement;
    bgdiv.appendChild(div);
    parent.appendChild(bgdiv);
  }
  
  function popupBuildTable(table, entries, selected_callback, pinned_callback) {
    while (table.children.length > 0) {
      table.removeChild(table.children[0]);
    }
    var shown_titles = [];
    for (var idx=0; idx < entries.length; idx++) {
      var titlearray = entries[idx].title;
      if (!Array.isArray(titlearray)) {
        titlearray = [titlearray];
      }
      var show = true;
      for (var level_idx=0; level_idx < popup_selected_levels.length; level_idx++) {
        if (!(level_idx < titlearray.length && titlearray[level_idx] == popup_selected_levels[level_idx])) {
          show = false;
        }
      }
      if (show) {
        var level_idx = popup_selected_levels.length;
        var title = titlearray[level_idx];
        var is_leaf = (titlearray.length == level_idx+1);
        if (!(shown_titles.indexOf(title) >= 0)) {
          var tr = document.createElement("tr");
          tr.className = "popuprow";
          var td = document.createElement("td");
          td.style.width = "100%";
          td.className = "popuptext";
          var val = entries[idx].value;
          if (!val) {
            val = entries[idx].title;
          }
          if (popupinput.dataset.value == val) {
            td.className = "popupselectedtext";
          }
          if (is_leaf) {
            removeTeslaDoubleClick(td);
            td.addEventListener("click", bindEvent2(popupClicked, idx, selected_callback));
          } else {
            removeTeslaDoubleClick(td);
            td.addEventListener("click", bindEvent2(popupExpandNext, idx, selected_callback));
          }
          var text = document.createTextNode(title);
          td.appendChild(text)
          if (!is_leaf) {
            var img = document.createElement("img");
            
            img.src = "icon/right_icon_small.png";
            img.style.marginLeft = "5px";
            td.appendChild(img);
          }
          tr.appendChild(td);
          
          if ("pinned" in entries[idx]) {
            td = document.createElement("td");
            var img = document.createElement("img");
            if (entries[idx].pinned) {
              img.src = "icon/pinned.png";
            } else {
              img.src = "icon/pin.png";
            }
            td.addEventListener("click", bindEvent3(popupPinClicked, idx, img, pinned_callback));
            removeTeslaDoubleClick(td);
            td.appendChild(img);
          }
          tr.appendChild(td);
          table.appendChild(tr);
          shown_titles.push(title);
        }
      }
    }
  }
  
  function popupExpandNext(event, idx, selected_callback) {
    var entries = JSON.parse(popupinput.dataset.entries);
    var level_idx = popup_selected_levels.length;
    popup_selected_levels.push(entries[idx].title[level_idx]);
    popupBuildTable(popuptable, entries, selected_callback);
    event.stopPropagation();
  }
  
  function popupClicked(event, idx, callback) {
    var entries = JSON.parse(popupinput.dataset.entries);
    var selected = entries[idx];
    if (Array.isArray(selected.title)) {
      popupinput.value = selected.title.join(" ");
    } else {
      popupinput.value = selected.title;
    }
    var val = selected.value;
    if (!val) {
      val = selected.title;
    }
    popupinput.dataset.value = val;
    popupClose();
    if (callback) {
      callback(idx, entries);
    }
    event.stopPropagation();
  }
  
  function popupPinClicked(event, idx, img, callback) {
    var entries = JSON.parse(popupinput.dataset.entries);
    entries[idx].pinned = !entries[idx].pinned;
    if (entries[idx].pinned) {
      img.src = "icon/pinned.png";
    } else {
      img.src = "icon/pin.png";
    }
    popupPopulate(popupinput, entries);
    event.stopPropagation();
    if (!(callback === undefined)) {
      callback(idx, entries);
    }
  }
  
  function popupSetValueById(inputid, val) {
    var input = document.getElementById(inputid);
    popupSetValue(input, val);
  }
  
  function popupSetValue(input, val) {
    input.dataset.value = val;
    if (input.dataset.entries) {
      var entries = JSON.parse(input.dataset.entries);
      input.value = val;
      input.dataset.value = val;
      for (var idx=0; idx < entries.length; idx++) {
        if (entries[idx].value == val || entries[idx].title == val) {
          var title = entries[idx].title;
          if (Array.isArray(title)) {
            input.value = title.join(" ");
          } else {
            input.value = title;
          }
          input.dataset.value = entries[idx].value;
        }
      }
    }
  }
  
  function popupGetValueById(inputid) {
    var input = document.getElementById(inputid);
    return popupGetValue(input);
  }
  
  function popupGetValue(input) {
    if ((!("value" in input.dataset)) || input.dataset.value == "null") {
      return null;
    }
    return (input.dataset.value);
  }
  
  function setAvoidClasses(avoid_ferries, avoid_tolls, avoid_motorways) {
    if (avoid_ferries) {
      popupSetValueById("avoidclasses", "ferry");
    } else if (avoid_tolls) {
      popupSetValueById("avoidclasses", "toll");
    } else if (avoid_motorways) {
      popupSetValueById("avoidclasses", "motorway");
    } else {
      popupSetValueById("avoidclasses", "none");
    }
  }

  function getAvoidClasses() {
    var val = popupGetValueById("avoidclasses");
    if (val == "ferry") {
      return [true, false, false];
    } else if (val == "toll") {
      return [false, true, false];
    } else if (val == "motorway") {
      return [false, false, true];
    } else {
      return [false, false, false];
    }
  }


  function showNotifications() {
    var notifyscroll = document.getElementById("notify-scroll-div");
    var notifytable = document.getElementById("notify-table");
    while (notifytable.firstChild) {
      notifytable.removeChild(notifytable.firstChild);
    }
    for (var idx=0; idx < notifications.length; idx++) {
      var not = notifications[idx];
      var tr = document.createElement("tr");
      var td = document.createElement("td");
      td.style.verticalAlign = "top";
      var img = document.createElement("img");
      img.src = "data:image/jpeg;base64, "+not.icon;
      img.width = "32";
      img.height = "32";
      td.appendChild(img);
      tr.appendChild(td);
      
      td = document.createElement("td");
      td.style.width = "100%";
      td.style.verticalAlign = "top";
      var div = document.createElement("div");
      div.className = "notifytitle";
      var text = document.createTextNode(not.title);
      div.appendChild(text);
      td.appendChild(div);
      
      div = document.createElement("div");
      div.className = "notifytext";
      var lines = not.body.split("\n");
      for (var lidx=0; lidx < lines.length; lidx++) {
        var text = document.createTextNode(lines[lidx]);
        div.appendChild(text);
        if (lidx+1 < lines.length) {
          var br = document.createElement("br");
          div.appendChild(br);
        }
      }
      td.appendChild(div);
      tr.appendChild(td);
      
      td = document.createElement("td");
      div = document.createElement("div");
      div.className = "overlay-closebutton-inline";
      var img = document.createElement("img");
      img.src = staticurl+"icon/close_icon.png";
      img.className = "closebutton";
      div.appendChild(img);
      addNotificationCloseButton(div, idx);
      td.appendChild(div);
      tr.appendChild(td);
      notifytable.appendChild(tr);
    }
    if (notifications.length == 0) {
      var tr = document.createElement("tr");
      var td = document.createElement("td");
      td.className = "notifytext";
      var text = document.createTextNode("No notifications right now.");
      td.appendChild(text);
      tr.appendChild(td);
      notifytable.appendChild(tr);
      closeNotify();
    } else {
      openNotify();
    }
    
    notifyscroll.scrollTop = notifyscroll.scrollHeight;
  }
  
  function onNotificationClose(index) {
    notifications.splice(index, 1);
    showNotifications();
  }
  
  function addNotificationCloseButton(elem, index) {
    
    elem.addEventListener('click', function() {
      onNotificationClose(index);
    });
    removeTeslaDoubleClick(elem);
 }
  
  
  function recvNotify(data) {
    var pollagain = true;
    var validdata = false;
    if (data.type == "error") {
      if (data.error == "unauthorized") {
        pushbulletLogout();
      }
      pollagain = false;
    }
    if (data.type == "nop") {
      validdata = true;
    } else if (data.type == "push") {
      validdata = true;
      if (data.push.type == "mirror" || data.push.type == "dismissal") {
        updated = false;
        for (var idx=0; idx < notifications.length; idx++) {
          if (notifications[idx].notification_id == data.push.notification_id) {
            if (data.push.type == "dismissal") {
              notifications.splice(idx, 1);
            } else {
              notifications[idx] = data.push;
              updated = true;
            }
          }
        }
        if (!updated && data.push.type == "mirror") {
          notifications.push(data.push);
        }
        if (notifications.length > 5) {
          notifications.splice(0, 1);
        }
        showNotifications();
      }
    }
    if (validdata) {
      if (!pushbullet_verified) {
        pushbullet_verified = true;
        setStorageValue("pushbullet_verified", pushbullet_verified);
      }
      if (!pushbullet_connected) {
        pushbullet_connected = true;
        setNotify(pushbullet_connected);
      }
    }
    return pollagain;
  }
  
  function s4() {
    return Math.floor((1 + Math.random()) * 0x10000)
    .toString(16)
    .substring(1);
  }
  
  function guid() {
    return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
    s4() + '-' + s4() + s4() + s4();
  }
  
  function random_session() {
    return s4()+s4()+s4();
  }
    
  function openNotify() {
    if (pushbullet_token && pushbullet_verified) {
      var notifydiv = document.getElementById("notify-div");
      notifydiv.style.display = "";
    } else {
      openPushbullet();
    }
  }
  
  function closeNotify() {
    var notifydiv = document.getElementById("notify-div");
    notifydiv.style.display = "none";
  }
  
  function closePushbullet() {
    var pushbulletdiv = document.getElementById("pushbullet-div");
    pushbulletdiv.style.display = "none";
  }
  
  function setNotify(connected) {
    var notifybutton = document.getElementById('notifybutton');
    if (connected) {
      notifybutton.dataset.active = "true";
    } else {
      notifybutton.dataset.active = "false";
    }
  }
  
  function openPushbullet() {
    var pushbulletdiv = document.getElementById("pushbullet-div");
    pushbulletdiv.style.display = "";
    var logindiv = document.getElementById("pushbullet-login-button");
    var logoutdiv = document.getElementById("pushbullet-logout-button");
    if (pushbullet_token && pushbullet_verified) {
      logindiv.style.display = "none";
      logoutdiv.style.display = "";
    } else {
      logindiv.style.display = "";
      logoutdiv.style.display = "none";
    }
    
  }
  
  function pushbulletLogin() {
    window.location.href = "https://www.pushbullet.com/authorize?client_id=66DZ3WwKLZSp2YQp7ZzGWSQ9A6n978Ze&redirect_uri=https%3A%2F%2Fabetterrouteplanner.com%2F&response_type=token";
  }
  
  function pushbulletLogout() {
    pushbullet_token = null;
    pushbullet_verified = false;
    setStorageValue("pushbullet_token", pushbullet_token);
    setStorageValue("pushbullet_verified", pushbullet_verified);
    closePushbullet();
  }
  
  // Show appropriate parts of the drive display. If mode is null, the keep the current mode.
  function setDriveDisplay(mode) {
    if (mode != drivedisplaymode) {
      drivedisplaymode = mode;
      setStorageValue("drivedisplaymode", drivedisplaymode);
      var drivedisplaytextdiv = document.getElementById("drivedisplaytext");
      var drivedisplaydiv = document.getElementById("drivedisplaydiv");
      var canvas = document.getElementById("drive-canvas");
      var text = "";
      while (drivedisplaytextdiv.firstChild) {
        drivedisplaytextdiv.removeChild(drivedisplaytextdiv.firstChild);
      }
      document.getElementById("drive-frame").style.display = "";
      if (mode == "graph") {
        text = document.createTextNode("Details");
        drivedisplaytextdiv.appendChild(text);
        if (drivedisplay_graph_data_exists) {
          document.getElementById("drive-canvas").style.display = "";
          document.getElementById("drive-div").style.display = "none";
        } else {
          document.getElementById("drive-canvas").style.display = "none";
          document.getElementById("drive-div").style.display = "";
          canvas.height = 0;
        }
        drivedisplaydiv.style.display = "";
      } else if (mode == "text") {
        text = document.createTextNode("Graph");
        drivedisplaytextdiv.appendChild(text);
        document.getElementById("drive-canvas").style.display = "none";
        document.getElementById("drive-div").style.display = "";
        canvas.height = 0;
        drivedisplaydiv.style.display = "";
      } else if (mode.indexOf("both") >= 0){
        document.getElementById("drive-canvas").style.display = "";
        document.getElementById("drive-div").style.display = "";
        drivedisplaydiv.style.display = "";
      } else {
        document.getElementById("drive-canvas").style.display = "none";
        document.getElementById("drive-div").style.display = "";
        canvas.height = 0;
        drivedisplaydiv.style.display = "none";
      }
    }
  }
  
  function setDriveDisplayGraph(data_exists) {
    if (data_exists != drivedisplay_graph_data_exists) {
      if ((drivedisplaymode == "graph" || drivedisplaymode == "both") && data_exists) {
        document.getElementById("drive-canvas").style.display = "";
        if (drivedisplaymode == "graph") {
          document.getElementById("drive-div").style.display = "none";
        }
      } else {
        document.getElementById("drive-canvas").style.display = "none";
        document.getElementById("drive-div").style.display = "";
      }
    }
    drivedisplay_graph_data_exists = data_exists;
  }

  function toggleDriveDisplay() {
    if (drivedisplaymode == "graph") {
      setDriveDisplay("text");
    } else {
      setDriveDisplay("graph");
    } 
  }
  
  function onSavePlanButton() {
    var destinations = getDestList(false);
    if (plan && "plan_uuid" in plan) {
      var uuid = plan["plan_uuid"];
      var names = [];
      
      for (idx in destinations) {
        var dest = destinations[idx];
        if (dest[0]) {
          names.push(dest[0]);
        } else if (dest[3] == null && dest[6] == null) {
          names.push("Here");
        } else if (dest[6] != null) {
          names.push("Map waypoint");
        }
        
      }
      var saved = getDefaultStorageValue("saved_routes", []);
      saved.push([names.join(" to "), uuid]);
      setStorageValue("saved_routes", saved);
      showToast("Plan saved");
      saveSettings(true);
    }
  }
  
  function openSaved() {
    var div = document.getElementById("saved-div");
    div.style.display = "";
    var savedtable = document.getElementById("saved-table");
    while (savedtable.firstChild) {
      savedtable.removeChild(savedtable.firstChild);
    }
    
    var saved = getDefaultStorageValue("saved_routes", []);
    if (saved.length == 0) {
      var tr = document.createElement("tr");
      var td = document.createElement("td");
      td.className = "savedtext";
      var text = document.createTextNode("You have no saved plans.");
      td.appendChild(text);
      tr.appendChild(td);
      savedtable.appendChild(tr);
    } else {
      for (var idx in saved) {     
        var savedroute = saved[idx];
        var tr = document.createElement("tr");
        var td = document.createElement("td");
        td.className = "savedtext";
        var text = document.createElement("div");
        text.innerHTML = savedroute[0];
        text.contentEditable = false;
        text.className = "savedinput";
        td.appendChild(text);
        td.addEventListener('click', bind2(loadSaved, savedroute[1], text));
        removeTeslaDoubleClick(td);
        tr.appendChild(td);

        var td = document.createElement("td");
        //Edit icon, changes to save icon when editing.
        var edit_img = document.createElement("img");
        edit_img.src = "icon/edit_white.png";
        td.appendChild(edit_img);
        //Save icon
        var save_img = document.createElement("img");
        save_img.src = "icon/save_white.png";
        save_img.style.display = "none";
        td.appendChild(save_img);
        
        var doms = [text,edit_img,save_img];
        edit_img.addEventListener('click', bind2(editSaved, idx, doms));
        removeTeslaDoubleClick(edit_img);
        save_img.addEventListener('click', bind2(saveSaved, idx, doms));
        removeTeslaDoubleClick(save_img);

        tr.appendChild(td);
        td = document.createElement("td");
        img = document.createElement("img");
        img.src = "icon/close_icon_white.png";
        img.addEventListener('click', bind(deleteSaved, idx));
        removeTeslaDoubleClick(img);
        td.appendChild(img);
        tr.appendChild(td);
        
        savedtable.appendChild(tr);
      }
    }
  }
  
  function closeSaved() {
    var div = document.getElementById("saved-div");
    div.style.display = "none";
  }
  
  function loadSaved(uuid,text) {
    // Only close out the saved popup if we're not editing.
    if (text.contentEditable != "true") {
      closeSaved();
      loadSettings("plan_uuid="+uuid);
    }
    
  }
  function editSaved(idx,doms) {
    doms[0].contentEditable = true;
    doms[0].style.cursor = "text";
    doms[0].style.backgroundColor = "rgba(255,255,255,0.8)"
    doms[1].style.display = "none";
    doms[2].style.display = "";
  }
  function saveSaved(idx,doms) {
    doms[0].contentEditable = false;
    doms[0].style.cursor = "pointer";
    doms[0].style.backgroundColor = "rgba(255,255,255,0.3)"
    doms[1].style.display = "";
    doms[2].style.display = "none";

    var saved = getDefaultStorageValue("saved_routes", []);
    if (idx < saved.length) {
      saved[idx][0] = doms[0].innerHTML;
      setStorageValue("saved_routes", saved);
      saveSettings(true);
    }
    openSaved();
  }
  function deleteSaved(idx) {
    var saved = getDefaultStorageValue("saved_routes", []);
    if (idx < saved.length) {
      saved.splice(idx,1);
      setStorageValue("saved_routes", saved);
      saveSettings(true);
    }
    openSaved();
  }
  
  function carModelFromOptionCodes(option_str) {
    var options = option_str.split(",");
    var typecode = "";
    var dualmotorcode = "";
    if (options.indexOf("MDLS") >= 0) {
      typecode += "s";
    } else if (options.indexOf("MDLX") >= 0) {
      typecode += "x";
    } else if (options.indexOf("MDL3") >= 0) {
      typecode += "3";
    } else {
      typecode += "s";
    }
    if (options.indexOf("PF01") >= 0) {
      typecode += "p";
    }
    if (options.indexOf("BT40") >= 0) {
      typecode += "40";
    } else if (options.indexOf("BT60") >= 0) {
      typecode += "60";
    } else if (options.indexOf("BT70") >= 0) {
      typecode += "70";
    } else if (options.indexOf("BT85") >= 0) {
      typecode += "85";
    } else if (options.indexOf("BTX4") >= 0) {
      typecode += "90";
    } else if (options.indexOf("BTX5") >= 0) {
      if (options.indexOf("BR03") >= 0) {
        if (typecode == "s") {
          typecode = "news60";
        } else {
          typecode += "60";
        }
      } else {
        typecode += "75";
      }
    } else if (options.indexOf("BTX6") >= 0) {
      typecode += "100";
    } else if (options.indexOf("BTX8") >= 0) {
      typecode += "75btx8";
    } else if (options.indexOf("BT37") >= 0) {
      typecode += "long";
    } else if (options.indexOf("BT35") >= 0) {
      typecode += "standard";
    } else {
      typecode += "85";
    }
    if (options.indexOf("DV4W") >= 0) {
      typecode += "d";
    }
    return typecode;
  }
  
  var fw_particles = [];
  var fw_last_time = null;
  var fw_iters = 0;
  var fw_mode = 0;
  var fw_active = 0;
  
  function startFireworks() {
    fw_last_time = new Date().getTime();
    var div = document.getElementById("fireworks-div");
    div.style.display = "";
    var canvas = document.getElementById("fireworks-canvas");
    canvas.width = div.clientWidth;
    canvas.height = div.clientHeight;
    fw_active = 1;
    
    updateFireworks();
  }
  
  function stopFireworks() {
    var div = document.getElementById("fireworks-div");
    div.style.display = "none";
    fw_active = 2;
    closeAbout();
  }
  
  function updateFireworks() {
    fw_iters += 1;
    if (fw_active) {
      window.requestAnimationFrame(updateFireworks);
    }
    var now = new Date().getTime();
    var dt = (now - fw_last_time)/1000.0;
    fw_last_time = now;
    
    var canvas = document.getElementById("fireworks-canvas");
    var ctx = canvas.getContext("2d");
    var width = canvas.width;
    var height = canvas.height;
    clearCanvas(canvas);
    var y_g = 100;
    var v_alpha = 0.99;
    var particle_life = 3.0;
    
    var nrof_rockets = 0;
    for (var idx=0; idx < fw_particles.length; idx++) {
      var p = fw_particles[idx];
      p[2] *= v_alpha;
      p[3] += y_g*dt;
      p[3] *= v_alpha;
      p[0] += p[2]*dt;
      p[1] += p[3]*dt;
      p[5] += dt;
      if (p[4] == 0) {
        if (p[3] > 0) {
          // Time to explode
          fw_particles.splice(idx, 1);
          idx -= 1;
          for (var idx2=0; idx2 < 100; idx2++) {
            var dv = (Math.random()-0.5)*600;
            var dv_ang = Math.random()*2.0*Math.PI;
            var dvx = Math.cos(dv_ang)*dv;
            var dvy = Math.sin(dv_ang)*dv;
            fw_particles.push([p[0], p[1], p[2]+dvx, p[3]+dvy, 1, 0.0])
          }
          if (fw_mode == 0) {
            fw_mode = 1;
          }
        } else {
          nrof_rockets += 1;
        }
      } else if (p[4] == 1) {
        if (p[5] > particle_life) {
          fw_particles.splice(idx, 1);
          idx -= 1;
        }
      }
    }
    
    while (nrof_rockets < 6) {
      startx = width/2;
      starty = height*0.9;
      vx = (Math.random()-0.5)*200;
      vy = -height*0.6 + (Math.random()-0.5)*100;
      fw_particles.push([startx, starty, vx, vy, 0, 0]);
      nrof_rockets += 1;
    }
    
    if (fw_mode == 1) {
      ctx.fillStyle = "#c0c0c0";
      ctx.font = "bold 100px Arial";
      ctx.textAlign = "center";
      ctx.globalAlpha = 1.0;
      ctx.fillText(numberWithCommas(total_route_count),width*0.5,height*0.3);
      ctx.font = "bold 60px Arial";
      ctx.fillText("Routes Planned", width*0.5,height*0.3+100);
      ctx.font = "bold 36px Arial";
      ctx.fillText("by Fantastic ABRP Users!", width*0.5,height*0.3+150);
    }
    
    ctx.fillStyle = "#ffffff";
    ctx.strokeWeight = 0;
    for (var idx=0; idx < fw_particles.length; idx++) {
      var p = fw_particles[idx];
      if (p[4] == 0) {
        ctx.globalAlpha = 1.0;
      } else {
        ctx.globalAlpha = (particle_life-p[5])/particle_life;
      }
      ctx.fillRect(p[0], p[1], 4, 4);
    }
  }

  function openInitialCarSelector() {
    if (car_models.length == 0) {
      return;
    }
    openInputDialog("Which car would you like to plan for?", null, "carmodel", onInitialCarSelected, "OK", null, 0, false);
  }

  function onInitialCarSelected(ok, car) {
    if (!car) {
      car = "3long";
    }
    setCarModel(car);
    onModelChange(null, null);
    setStorageValue("initial_car_model_selected", true);
    showToast("Now enter your destination(s) and plan!");
 
    if (!gdpr_cookies_ok || eula_version_ok < eula_version) {
      openEula();
    }
  }

  var input_callback = null;
  var input_type = null;
  var input_returnvalue = null;
  var input_defaultaction = null;
  var input_timeout = null;
  var input_charger_idx = 0;

  function openInputDialog(heading, message, inputtype, callback, yesmsg, nomsg, timeout, default_action) {
    input_type = inputtype;
    input_callback = callback;
    input_returnvalue = null;
    input_defaultaction = default_action;

    var div = document.getElementById("input-heading-div");
    while (div.firstChild) {
      div.removeChild(div.firstChild);
    }
    var text = document.createTextNode(heading);
    div.appendChild(text);

    document.getElementById("input-carmodelpopup").style.display = "none";
    document.getElementById("input-messagetext").style.display = "none";
    document.getElementById("input-chargeralts").style.display = "none";
    if (inputtype == "carmodel") {
      if (car_models.length == 0) {
        return;
      }
      var div = document.getElementById("input-carmodelpopup");
      div.style.display = "inline-block";
      var models = [];
      for (var idx=0; idx < car_models.length; idx++) {
        models.push({"title":car_models[idx].name.split(";"), "value":car_models[idx].typecode});
      }    
      popupPopulateById("input-carmodelpopup", models);
      popupSetValueById("input-carmodelpopup", "Select a car model");
    } else if (inputtype == "message") {
      var div = document.getElementById("input-messagetext");
      div.style.display = "inline-block";
      div.innerHTML = message;
    } else if (inputtype == "nextcharger") {
      var div = document.getElementById("input-chargeralts");
      div.style.display = "inline-block";
      input_charger_idx = 0;
      input_returnvalue = 0;
      showInputCharger();      
    } else {
      return;
    }
    if (nomsg) {
      document.getElementById("input-cancelbutton").style.display = "inline-block";
      document.getElementById("input-cancelbutton").value = nomsg;
      document.getElementById("input-cancelbutton").style.width = "calc(50% - 5px)";
      document.getElementById("input-okbutton").style.width = "calc(50% - 5px)";
      if (!default_action) {
        document.getElementById("input-cancelbutton").style.fontWeight = "bold";
      } else {
        document.getElementById("input-cancelbutton").style.fontWeight = "";
      }
    } else {
      document.getElementById("input-okbutton").style.width = "100%";
    }
    document.getElementById("input-okbutton").value = yesmsg;
    if (default_action) {
      document.getElementById("input-okbutton").style.fontWeight = "bold";
    } else {
      document.getElementById("input-okbutton").style.fontWeight = "";
    }
    if (timeout != null && timeout > 0) {
      input_timeout = setTimeout(onInputTimeout, timeout);
    }

    document.getElementById("input-center-div").style.display = "block";
    document.getElementById("input-center-div").focus();
  }

  function showInputCharger() {
    var content = document.getElementById("input-charger");
    while (content.firstChild) {
        content.removeChild(content.firstChild);
      }
    if (!next_charger_plans || !next_charger_plans.routes || input_charger_idx >= next_charger_plans.routes.length) {
      return;
    }

    var best_step = next_charger_plans.routes[0].steps[0];
    var best_dur = best_step.departure_duration;
    var alt_charger_step = next_charger_plans.routes[input_charger_idx].steps[1];
    var alt_step = next_charger_plans.routes[input_charger_idx].steps[0];

    var div = document.getElementById("input-heading-div");
    while (div.firstChild) {
      div.removeChild(div.firstChild);
    }

    var loss_min = Math.round((alt_step.departure_duration-best_dur)/60);
    s = ""
    if (input_charger_idx == 0) {
      s += "Fastest option"
    } else if (loss_min < 3) {
      s += "About same trip time"
    } else {
      s += "+"+loss_min+" min trip time"
    }
    s += " ("+(input_charger_idx+1).toString()+"/"+(next_charger_plans.routes.length).toString()+")";
    text = document.createTextNode(s);
    div.appendChild(text);

    chrg.createChargerInfo(alt_charger_step.id, content, "inputcharge");

    div = document.createElement("div");
    div.className = "inputchargetext";
    div.style.marginTop = "15px";
    var s = secondsToTimeStr(alt_step.drive_duration+alt_step.wait_duration);
    if (units == "imperial") {
      s += ", "+Math.round(alt_step.drive_dist/1609)+" miles"
    } else {
      s += ", "+Math.round(alt_step.drive_dist/1000)+" km"
    }
    s += " to this charger"
    text = document.createTextNode(s);
    div.appendChild(text);
    content.appendChild(div);

    div = document.createElement("div");
    div.className = "inputchargetext";
    div.style.marginTop = "5px";
    s = "Arrive with "+alt_charger_step.arrival_perc+"% SoC";
    text = document.createTextNode(s);
    div.appendChild(text);
    content.appendChild(div);

    input_returnvalue = input_charger_idx;
    showRoute(next_charger_plans, input_charger_idx, "firststep", false);
  }
  
  function onInputChargerNext() {
    if (!next_charger_plans) {
      return;
    }
    input_charger_idx += 1;
    if (input_charger_idx >= next_charger_plans.routes.length) {
      input_charger_idx = 0;
    }
    showInputCharger();
  }

  function onInputChargerPrev() {
    if (!next_charger_plans) {
      return;
    }
    input_charger_idx -= 1;
    if (input_charger_idx < 0) {
      input_charger_idx = next_charger_plans.routes.length-1;
    }
    showInputCharger();
  }


  function onInputModelChange() {
    var car = popupGetValueById("input-carmodelpopup");
    input_returnvalue = car;
  }

  function onInputTimeout() {
    input_timeout = null;
    closeInputDialog();
    if (input_callback) {
      input_callback(input_defaultaction, input_returnvalue);
    }
  }

  function onInputKeyUp(event) {
    if (event.key == "Escape") {
      onCloseInputDialog();
    }
  }

  function closeInputDialog() {
    var div = document.getElementById("input-center-div");
    div.style.display = "none";
    if (input_timeout) {
      clearTimeout(input_timeout);
      input_timeout = null;
    }
    
  }


  function onCloseInputDialog() {
    closeInputDialog();
    if (input_callback) {
      input_callback(input_defaultaction, input_returnvalue);
    }
  }

  function onInputOK() {
    closeInputDialog();
    if (input_callback) {
      input_callback(true, input_returnvalue);
    }
  }

  function onInputCancel() {
    closeInputDialog();
    if (input_callback) {
      input_callback(false, input_returnvalue);
    }
  }


  function setToolbarActives (graph,details,plan){
    $("#toolbar-graphbutton").attr("data-active", graph);
    $("#toolbar-graphimg").attr("data-active", graph);
    $("#toolbar-detailsbutton").attr("data-active", details);
    $("#toolbar-detailsimg").attr("data-active", details);
    $("#toolbar-planbutton").attr("data-active", plan);
    $("#toolbar-planimg").attr("data-active", plan);
  }

  function setNoMapDriveDisplay(show) {
    if (show == "graph") {
      $("#plan-overlay").css("display","none");
      $("#drive-center-div").css("display","inline-block");
      setToolbarActives("true","true","false");
      setDriveDisplay("both");
      if (!is_car_active) {
        var drivediv = document.getElementById("drive-div");
        var html = '<div class="drivetext" style="text-align: center;">';
        html += "Real-time information while driving"
        html += '</div>';
        drivediv.innerHTML = html;
        setDriveDisplayGraph(false);
      }
    } else if (show == "plan") {
      $("#plan-overlay").css("display","inline-block");
      $("#drive-center-div").css("display","none");
      setToolbarActives("false","false","true");
    }
  }

  window.onload = initialize;
</script>


<body onbeforeunload="updateVisit('leave', 'planning');">
  <h1 style="display: none;">A Better Routeplanner (ABRP) for Electric Vehicles</h1>
  
  <div style="width:100%; height:100%;">
    <div id="map-canvas" style="height: 100%; width: 100%; z-index:0;"></div>
    <div class="abrpbgtext">ABRP</div>
  </div>
  
  <div class="overlay" id="plan-overlay">
    <div class="plan-scroll">
      <div id="plan-params-div" class="plan-params">
        <form id=plan-form onSubmit="onPlanButton(false); return false;" novalidate name=planform style="margin-bottom: 0px;">
          <table class=plantable id="plan-table" style="cursor: move;">
          </table>
          <table class=plantable style="width:100%; margin-top: 5px;"><tr><td>
            <a class="settingsbutton prevent-double-click" id=settings-button onClick="toggleSettings()">Show Settings</a>
          </td><td style="text-align: center;">
            <a class="settingsbutton prevent-double-click" id=saved-button onClick="openSaved()" >Saved Plans</a>
          </td>
          <td style="text-align: right;">
            <a class="settingsbutton prevent-double-click" id=addvia-button onClick="onAddWaypoint();">Add Waypoint</a>
          </td></tr></table>
          
          <table class=plantable style="display: none;" id=settings>
            <tbody>
              <tr>
              </tr>
              <tr><td class=settingslabel>Model</td>
                <td class=settingstext>
                  <input class="settingsdropdown prevent-double-click" style="width:100%" name=carmodel id=carmodelpopup readonly onClick="popupOpen(this,onModelChange);" title="Select your car model. Models marked as (beta) are initial models but validated by owners, (alpha) means very initial models."></input>
                </td>
              </tr>
              <tr>
                <td class=settingslabel id=consumptext>Reference Consumption</td>
                <td class=settingstext><input value="210" type=number step=1 min=50 max=2000 required class=settingsinput name=consumption size=10 id=consumpvalue title="Your own typical consumption at the given constant speed on flat land. Typically affected by driving style, tires, load, roof racks, etc., but you can also use it to account for weather conditions. Or use the specialized functions for that below.">
                  <input id=consumpunit class="settingsinput prevent-double-click" style="padding: 3px; width: auto; cursor: pointer;" type=button onClick="setConsUnits('toggle');" value="Wh/km at 110 km/h" title="Change consumption settings between Energy / Distance and Distance / Energy.">
                </td>
              </tr>
              <tr><td class=settingslabel>Reference Speed</td>
                <td class=settingstext><input value="100" type=number min=30 max=200 required class=settingsinput name=speedoverlimit size=10 title="Set the relative speed compared to the speed limit (100%) for each stretch of road."> %</td>
              </tr>
              <tr>
                <td class=settingslabel>Max Speed</td>
                <td class=settingstext><input value="150" type=number min=30 max=250 required class=settingsinput id=max_speed size=10 title="Maximum speed allowed to be used anywhere along the route."> <span id=maxspeedunit>km/h</span> <input type=checkbox class=settingsinput name=adjust_speed size=10 title="Reduce speed if necessary to reach chargers or destinations." style="vertical-align: middle;"> <span class="checkboxlabel prevent-double-click" onClick="toggleCheckBox('adjust_speed');">Slower If Needed</span></td>
              </tr>
              <tr>
                <td class=settingslabel>Start Depart Charge</td>
                <td class=settingstext><input value="90" type=number min=1 max=100 placeholder="Car" class=settingsinput name=initialcharge size=10 title="Battery charge at the start of the route. Leave empty if you have logged in to MyTesla to use the car's current charge."> %</td>
              </tr>
              <tr>
                <td class=settingslabel>Charger Arrival Charge</td>
                <td class=settingstext><input value="10" type=number min=1 max=100 required class=settingsinput name=chargercharge size=10 title="Minimum battery charge when arriving to a charger. Less gives less margin but faster charging."> %</td>
              </tr>
              <tr>
                <td class=settingslabel>Goal Arrival Charge</td>
                <td class=settingstext><input value="10" type=number min=1 max=100 required class=settingsinput name=arrivalcharge size=10 title="Minimum battery charge when arriving to the goal."> %</td>
              </tr>
              <tr>
                <td colspan=2 class=settingsdivider><a class="settingsbutton prevent-double-click" id=moresettings-button onClick="toggleMoreSettings()">Show More Settings</a></td>
              </tr>
            </tbody>
            <tbody id=moresettings style="display: none;">
              <tr>
                <td class=settingslabel>Units</td><td class=settingstext><input type=radio class="settingsradio prevent-double-click" id=metricradio name=units value=metric checked onClick="setUnits('metric');"> <a onClick="setUnits('metric');">Metric</a>
                  <input type=radio class="settingsradio  prevent-double-click" name=units value=imperial id=imperialradio onClick="setUnits('imperial')"> <a onClick="setUnits('imperial');">Imperial</a> 
                </td>
              </tr>
              <tr>
                <td class=settingslabel>Outside Temperature</td><td class=settingstext><input value="20" type=number min=-50 max=150 placeholder="Car" class=settingsinput name=outsidetemp size=10 title="Outside temperature - will affect consumption, but less than most expect."> &deg;<span id=outsidetempunit>C</span></td>
              </tr>
              <tr style="display: none;">
                <td class=settingslabel>Initial Battery Temperature</td><td class=settingstext><input value="" type=number min=-50 max=150 placeholder="Outside" class=settingsinput name=initbatterytemp size=10 title="Initial battery temperature - if the battery is initally cold then the heater will consume extra power during the first time of driving. Leave empty to use outside temperature (above)."> <div id=initbatterytempunit>&deg;C</div></td>
              </tr>
              <tr>
                <td class=settingslabel>Wind</td><td class=settingstext><input value="0" type=number required min=0 max=100 class=settingsinput name=windspeed size=10 title="Wind speed. This will affect the car power consumption."> <span id=windspeedunit>m/s</span> <input class="settingsdropdown prevent-double-click" size=10 id=winddir onClick="popupOpen(this,null);" readonly></input></td>
              </tr>
              <tr>
                <td class=settingslabel>Road Conditions</td><td class=settingstext><input readonly class="settingsdropdown  prevent-double-click" id=roadcondition title="Road conditions - snow or rain on the road will increase roll resistance a lot. Rain or snow can increase consumption with 10% and heavy rain or snow up to 20%." onClick="popupOpen(this,null);"></input></td>
              </tr>
              <tr>
                <td class=settingslabel>Extra Weight</td><td class=settingstext><input value="0" type=number min=0 max=10000 required class=settingsinput name=extra_weight size=10 title="Extra vehicle weight, like a trailer or heavy cargo. This will mostly affect consumption uphill and downhill."> <span id=extra_weight_unit>kg</span></td>
              </tr>
              <tr>
                <td class=settingslabel>Battery Degradation</td><td class=settingstext><input value="5" type=number min=0 max=50 class=settingsinput name=battery_degradation size=10 title="Battery degradation compared to a new battery. Within a year or so, many EV batteries have lost about 5% capacity."> %</td>
              </tr>
              <tr>
                <td class=settingslabel>Time to Open Charge Port</td><td class=settingstext><input value="5" type=number min=0 max=60 required class=settingsinput name=chargeoverhead size=10 title="Overhead time added for each charging. This is for parking in the spot, fiddling with the charger cable, and, of course, to get the effing charge port to open. Time is added to the drive time."> minutes</td>
              </tr>
              <tr>
                <td class=settingslabel>Fast Chargers</td>
                <td class=settingstext>
                  <input type=checkbox class="settingsinput prevent-double-click" name=SC size=10 onchange="onDCFCToggle('SC')" title="Use Tesla SuperChargers in planning, often provides the most optimal solution for Tesla route planning.">
                  <img name=SCimg src="https://abetterrouteplanner.com/icon/overlay_icons/tesla_white.png" class=prevent-double-click title="Supercharger" alt="Supercharger" width="20" height="20" onClick="toggleCheckBox('SC')">
                  <span class="checkboxlabel prevent-double-click" name=SClabel onClick="toggleCheckBox('SC')">Supercharger</span>

                  <input type=checkbox class="settingsinput prevent-double-click" name=tesla_ccs size=10 onchange="onDCFCToggle('tesla_ccs')" title="Use Tesla SuperChargers with CCS connector - this is the only Supercharger which fits a Model 3 in Europe.">
                  <img name=SCimg src="https://abetterrouteplanner.com/icon/overlay_icons/tesla_white.png" class=prevent-double-click title="Tesla CCS" alt="Tesla CCS" width="20" height="20" onClick="toggleCheckBox('tesla_cc')">
                  <span class="checkboxlabel prevent-double-click" name=SClabel onClick="toggleCheckBox('tesla_ccs')">Tesla CCS</span>
                </tr>
                <tr>
                  <td></td>
                  <td class=settingstext>
                    <input type=checkbox class="settingsinput prevent-double-click" name=ccs size=10 onchange="onDCFCToggle('ccs')" title="Use CCS chargers for planning. This will typically not give a guaranteed optimal solution.">
                    <img name=ccsimg src="https://abetterrouteplanner.com/icon/overlay_icons/ccs_white.png" class=prevent-double-click title="CCS" alt="ccs" width="20" height="20" onClick="toggleCheckBox('ccs')">
                    <span class="checkboxlabel prevent-double-click" name=ccslabel onClick="toggleCheckBox('ccs')">CCS</span>
                  </td>
                </tr>
                <tr>
                  <td></td>
                  <td class=settingstext>
                    <input type=checkbox class="settingsinput prevent-double-click" name=chademo size=10 onchange="onDCFCToggle('chademo')" title="Use Chademo chargers for planning. This will typically not give a guaranteed optimal solution.">
                    <img name=chademoimg src="https://abetterrouteplanner.com/icon/overlay_icons/chademo_white.png" class=prevent-double-click title="ChaDeMo" alt="ChaDeMo" width="20" height="20" onClick="toggleCheckBox('chademo')">
                    <span class="checkboxlabel prevent-double-click" name=chademolabel onClick="toggleCheckBox('chademo')">ChaDeMo</span>
                  </td>
                </tr>
              </td></tr>
              <tr>
                <td class=settingslabel>Avoid on Route</td>
                <td class=settingstext><input class="settingsdropdown prevent-double-click" size=25 id=avoidclasses onClick="popupOpen(this,null);" readonly></input></td>
              </tr>
              <tr style="display: none;">
                <td class=settingslabel></td><td class=settingstext><input type=checkbox class=settingsinput name=find_alts size=10 title="Search for more alternative routes. This is typically slow since finding good but not optimal routes is a hard problem."> <span class="checkboxlabel  prevent-double-click" onClick="toggleCheckBox('find_alts');">Alternative Routes (slow)</span></td>
              </tr>
              <tr>
                <td class=settingslabel>Live Car Connection</td>
                <td class=settingstext>
                  <input class="stg-action-button-no-dot prevent-double-click" type="button" id=tlm-setup value="Setup" onClick="showOverlay('obd-setup-div'); obd_instr.setOBDSetupPage(0);" title="Set up OBD Telemetry."/>
                  <input class="stg-action-button prevent-double-click" type="button" id="mytesla-login-button" value="MyTesla Login" onClick="showMyTesla();" title="Log in to MyTesla to fetch real-time information from the car such as position and charge. ">
                  <input class="stg-action-button prevent-double-click" type="button" id="tlm-button" value="View Live Data" onClick="showOverlay('telemetry-div');" title="View live data from your car (if connected)">
                </td>
              </tr>
              <tr>
                <td class=settingslabel>Synchronize Settings</td>
                <td class=settingstext><input class="stg-action-button prevent-double-click" type="button" id="abrp-login-button" value="ABRP Login" onClick="showLogin();" title="Log in or register an account with abetterrouteplanner.com to synchronize plans between your devices and car."></td>
              </tr>
              <!--<tr><td class=settingslabel>Android Notification Mirroring</td><td class=settingstext><a class=settingsbutton onClick="openPushbullet();" title="Connect to Pushbullet to synchronize notifications from your Android devices to your ABRP display.">Pushbullet Settings</a></td></tr>-->
              <tr style="display: none;">
                <td class=settingslabel>Max Charge at Charger</td><td class=settingstext><input value="90" type=number class=settingsinput name=maxcharge size=10 title="Maximum allowed charge at each charger."> %</td>
              </tr>
            </tbody>
          </table>
          <div style="height: 45px; margin-top: 10px;">
            <input type=button class="actionbutton prevent-double-click" id=show-planlist-input style="float:right;border:0px;margin-left:10px;display:none;" value="Show Plan >" onClick="showPlanList(1);"/>
            <input type=button onClick="onPlanButton(false);" class="actionbutton prevent-double-click" id=plan-button style="float:right;border:0px" value="Plan Route" title="Plan the route!"/>
            <input class="actionbutton prevent-double-click" type=button style="float:right;border:0px;margin-right:10px;" id=clearplan-button style="float:right;border:0px" value="Reset" onClick="onClearPlanButton();" title="Clear plan, reset weather parameters, start over"/>
          </div>
          </form>
        
        <div id="spinner-div" class="spinner" style="display: none; margin-top: 10px;">
          <div class="double-bounce1"></div>
          <div class="double-bounce2"></div>
        </div>
        <div class="routemessage" id="route-message-div">
        </div>
      </div>
      
      <div id="route-list-div" style="display: none;">
        <div style="width: 100%; margin-bottom: 10px">
          <input type=button class="actionbutton prevent-double-click" value="< Back" onClick="showPlanList(0);"/>
          <input type=button class="actionbutton prevent-double-click" value="Next Charger" style="margin-left:5px;" id="nextchargeralts-button" onClick="onPlanButton(true);"/>
          <div id="spinner-div-plan" class="spinnersmall" style="display: none; margin-left: 10px;">
            <div class="double-bounce1"></div>
            <div class="double-bounce2"></div>
          </div>    
          <input class="actionbutton prevent-double-click" type=button style="display:none;float:right;border:0px;margin-right:0px;" id=copyplan-button style="float:right;border:0px" value="Share" onClick="openGetLinks();" title="Get a browser links to this plan for easy access in the car."/>
          <input class="actionbutton prevent-double-click" type=button style="display:none;float:right;border:0px;margin-right:10px;" id=saveplan-button style="float:right;border:0px" value="Save Plan" onClick="onSavePlanButton();" title="Save the plan and settings for usage later."/>
        </div>
        <div id="route-div">
          
        </div>
      </div>
      
    </div>
    <div class="overlay-hidebutton-center">
      <div class="overlay-hidebutton prevent-double-click" onClick="hideRouteplanner();">
        <img class="hidebutton" src="https://abetterrouteplanner.com/icon/up_expand_icon.png"/>
      </div>
    </div>
  </div>
  <div id="toolbar" class="nomaptoolbar">
    <span>
      <img class="toolbar-logo" src="https://abetterrouteplanner.com/icon/abrp_icon.png"/>
    </span>
    <span><div class="toolbar-button toolbar-planbutton prevent-double-click" id="toolbar-planbutton" onClick="setNoMapDriveDisplay('plan');">
      <img id="toolbar-planimg" class="toolbar-icon" src="https://abetterrouteplanner.com/icon/list_icon.png">
    </div></span>
    <span><div class="toolbar-button toolbar-graphbutton prevent-double-click" id="toolbar-graphbutton" onClick="setNoMapDriveDisplay('graph');">
      <img id="toolbar-graphimg" class="toolbar-icon" src="https://abetterrouteplanner.com/icon/graph_icon.png">
    </div></span>
    <span style="display: none;"><div class="toolbar-button toolbar-detailsbutton prevent-double-click" id="toolbar-detailsbutton" onClick="setNoMapDriveDisplay('details');">
      <img id="toolbar-detailsimg" class="toolbar-icon" src="https://abetterrouteplanner.com/icon/details.png">
    </div></span>
    <span><div class="toolbar-button toolbar-planbutton prevent-double-click" id="toolbar-nightbutton" onClick="toggleNight();">
      <img id="toolbar-nightimg" class="toolbar-icon" src="https://abetterrouteplanner.com/icon/night_icon.png">
    </div></span>
    <span><div class="toolbar-button toolbar-mapbutton prevent-double-click" id="toolbar-mapbutton" onClick="toggleMap();">
      <img class="toolbar-icon" src="https://abetterrouteplanner.com/icon/map-marker-icon.png">
    </div></span>
    <!-- <span><div class="toolbar-button toolbar-aboutbutton" onClick="openAbout();">
      <img src="https://abetterrouteplanner.com/icon/about_icon.png"/>
    </div></span> -->
  </div>

  <!-- Start of overlay buttons -->
  <div id=screenbuttons class=screen-buttons>
    <div id=zoomin class="overlay-button overlay-zoomin prevent-double-click" onClick="zoomIn();">
      <img src="https://abetterrouteplanner.com/icon/zoomin_icon.png" >
    </div>
    <div id=zoomout class="overlay-button overlay-zoomout prevent-double-click"  onClick="zoomOut();">
      <img src="https://abetterrouteplanner.com/icon/zoomout_icon.png">
    </div>
    <div class="overlay-button overlay-nightbutton prevent-double-click" id="nightbutton" onClick="toggleNight();">
      <img src="https://abetterrouteplanner.com/icon/night_icon.png">
    </div>
    <!--<div class="overlay-button overlay-navbutton prevent-double-click" id="navbutton" onClick="toggleNavigation();">
      <img src="https://abetterrouteplanner.com/icon/nav_icon.png">
    </div>-->
    <div class="overlay-button overlay-mapbutton prevent-double-click" id="mapbutton" onClick="toggleMap();">
      <img src="https://abetterrouteplanner.com/icon/map-marker-icon.png">
    </div>
    <div class="overlay-button overlay-centerbutton prevent-double-click" id="centerbutton" onClick="toggleCenter();">
      <img src="https://abetterrouteplanner.com/icon/center_icon.png">
    </div>
    <div class="overlay-button overlay-plugbutton prevent-double-click" id="plugbutton" onClick="togglePlugOverlay();">
      <img src="https://abetterrouteplanner.com/icon/plug_button.png">
    </div>
  </div>
  <div id=expandbutton class="overlay-button overlay-expand prevent-double-click" onClick="toggleScreenButtons();">
    <img id=overlay-expand-plus src="https://abetterrouteplanner.com/icon/plus_icon.png"/>
    <img id=overlay-expand-x src="https://abetterrouteplanner.com/icon/x_icon.png" style="display: none;"/>
  </div>
  <div id=aboutbutton class="overlay-button overlay-aboutbutton prevent-double-click" onClick="openAbout();">
    <img src="https://abetterrouteplanner.com/icon/about_icon.png"/>
  </div>
  <!-- End of overlay buttons. -->
  <div class="overlay-expandbutton-center" id="show-button" style="display: none;">
    <div class="overlay-expandbutton prevent-double-click" onclick="showRouteplanner();">
      <img class="expandbutton" src="https://abetterrouteplanner.com/icon/down_expand_icon.png"/>
    </div>
  </div>
  
  <div style="display: none; position: absolute; top: 0px; left: 0px;">
    <canvas id="carcanvas" width="48" height="48"></canvas>
  </div>
  
  <div class="overlay-about-center" id=about-div style="display: none">
    <div class="overlay-close prevent-double-click overlay-about-close" onclick="closeAbout();"></div>
    <div class="overlay-dialog overlay-about" onClick="closeAbout();">
      <div class=aboutlabel>
        <img class="toolbar-logo" src="https://abetterrouteplanner.com/icon/abrp_icon.png" style="width: 40px"/> A Better Routeplanner 3.7
      </div>
      <div class=abouttext>
        
        <table class=abouttable>
          <tr>
            <td colspan=2 class=abouttext>
              A Better Routeplanner (ABRP) for planning trips and charging with an Electric Vehicle - both home and in-car.
              <span class=aboutstrong>ABRP 3.7 - Next chargers, new cars, updated maps - <a href="https://forum.abetterrouteplanner.com/blogs/entry/27-abrp-37-release-notes/" class="abouttext">check out the ABRP 3.7 Release Notes</a></span>
              <p>Want to learn more and discuss ABRP? Visit the <a href="https://forum.abetterrouteplanner.com" class=abouttext>ABRP forums</a>, follow us on Twitter <a class="abouttext" href="http://twitter.com/RouteBetter">@RouteBetter</a> or join our <a href="https://www.facebook.com/ABRP-2114019512260731" class=abouttext>Facebook Group</a>. </p>
              <p></p>If you want to order a new Tesla, feel free to use <a class=abouttext href="http://ts.la/bo7850">my referral bo7850</a> to get 1500 km of free supercharging!</p>
            </td>
          </tr>
          <tr>
            <td ><img class=aboutshot src="https://abetterrouteplanner.com/icon/at_home_shot.png"></td>
            <td><img class=aboutshot src="https://abetterrouteplanner.com/icon/in_car_shot.png"></td>
          </tr>
          <tr>
            <td style="padding-right:15px;padding-bottom:20px;vertical-align:top;width:50%;"><div class=aboutheading>Plan and Play at Home</div>
              <div class=abouttext>
                Give ABRP the following:
                <ul>
                  <li class=abouttext>Waypoints, preferred chargers and route options</li>
                  <li class=abouttext>Reference speed relative to speed limits and reference consumption, i.e flat road consumption at fixed speed</li>
                </ul>
                ABRP will give you the route which takes you there in the shortest time, including charging. The consumption model accounts for
                <ul>
                  <li class=abouttext>Speed at every part of the route</li>
                  <li class=abouttext>Elevation changes with high resolution</li>
                </ul>
                All other factors are part of the reference consumption you give. That includes driving style, tyres, rims, roof racks (and optionally weather conditions for experienced drivers).
              </div>
            </td>
            <td style="vertical-align:top;width:50%;"><div class=aboutheading>Drive and Follow-Up in Car</div>
              <div class=abouttext>
                <p>While driving, ABRP will show you the planned charge profile so that you can follow up your actual charge and consumption. Not according to plan? Replan as you drive. </p>
                <p>If you login with MyTesla or using an <a class=abouttext href="https://abetterrouteplanner.com/blog/index.php/2018/09/09/generic-obd-and-torque-pro-setup-instructions">OBD reader</a>, you will get your car's State-of-Charger (SoC %), and ABRP will automatically calculate your reference consumption for you.</p>
                <p>While you are driving, you are anonymously sharing your driving data with us so that we can improve ABRP for everyone. Happy driving!</p>
              </div>
            </td>
          </tr>
          
          <tr>
            <td colspan=2 class=abouttext>
              <p><a href="http://www.bredbandsson.se"><img class="bredbandssonlogo" src="https://abetterrouteplanner.com/icon/logo_bredbandsson.png" align="right" /></a>Big thanks go out to <a class="abouttext" href="http://www.bredbandsson.se/">Bredbandsson.se</a> for hosting our work-hauling servers!</p>
              <p>Also thanks to <a class="abouttext" href="http://teslaclubsweden.se">Tesla Club Sweden</a> for moral support, feature ideas and testing! 
                Further thanks to <a class="abouttext" href="http://uppladdning.nu">uppladdning.nu</a>, 
                <a class="abouttext" href="https://supercharge.info">SuperCharge.info</a>, 
                <a class="abouttext" href="https://docs.google.com/spreadsheets/d/1N7CjkpUITPmj3ObOvTZnH8AtgmsinqOJ_ZR2MNJFnVI/htmlview#gid=0">Ulric and the Tesla CCS Spreadsheet</a>, 
                <a class="abouttext" href="https://www.ionitychargers.com">IonityChargers.com</a>, 
                <a class="abouttext" href="https://ionity.evapi.de">Ionity.evapi.de</a>, 
                <a class="abouttext" href="http://www.goingelectric.de/stromtankstellen/">GoingElectric.de</a>, 
                <a class="abouttext" href="https://www.openchargemap.org">openchargemap.org</a> (<a class="abouttext" href="https://openchargemap.org/site/about/terms">license</a>),
                <a class="abouttext" href="http://www.nrel.gov">nrel.gov</a>, <a class=abouttext href="https://www.recreation.gov/">Recreation.gov</a>, 
                and <a class=abouttext href="https://www.reserveamerica.com/welcome.do">Active (Reserve America)</a> for letting ABRP use their databases. 
                And not the least, thanks to the fantastic OSRM team for their <a class="abouttext" href="https://github.com/Project-OSRM/osrm-backend">Open Source Routing Machine</a>!</p>
              <div style="text-align: right;">Bo (bo@abetterrouteplanner.com, <a class="abouttext" href="http://twitter.com/RouteBetter">@RouteBetter</a>)</div>
              
              <p>We care about your integrity. You can read more in our <a class="abouttext" href="https://iternio.com/index.php/integrity-policy/">Integrity Policy</a>.</p>
              
              <p>To cover the costs of running the site, such as map API costs as well as server hardware, we are accepting donations. Any amount is welcome!</p>
              
              <table style="margin-left:auto; margin-right:auto;">
                <tr>
                  <td>
                    <form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top" style="margin-block-end: 0px">
                      <span class=currencytext>EUR&nbsp;</span>
                      <input type="hidden" name="cmd" value="_s-xclick">
                      <input type="hidden" name="hosted_button_id" value="E2NLVVNWA5S7E">
                      <input class=currencytext type="image" src="https://www.paypalobjects.com/en_GB/i/btn/btn_donate_LG.gif" border="0" name="submit" alt="PayPal � The safer, easier way to pay online!">
                      <img alt="" border="0" src="https://www.paypalobjects.com/sv_SE/i/scr/pixel.gif" width="1" height="1">
                    </form>
                  </td>
                  
                  <td>
                    <form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top" style="margin-block-end: 0px">
                      <span class=currencytext>USD&nbsp;</span>
                      <input type="hidden" name="cmd" value="_s-xclick">
                      <input type="hidden" name="hosted_button_id" value="KVSB77BPHPYZ2">
                      <input class=currencytext type="image" src="https://www.paypalobjects.com/en_GB/i/btn/btn_donate_LG.gif" border="0" name="submit" alt="PayPal � The safer, easier way to pay online!">
                      <img alt="" border="0" src="https://www.paypalobjects.com/sv_SE/i/scr/pixel.gif" width="1" height="1">
                    </form>
                  </td>
                  
                  <td>
                    <form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top" style="margin-block-end: 0px">
                      <span class=currencytext>SEK&nbsp;</span>
                      <input type="hidden" name="cmd" value="_s-xclick">
                      <input type="hidden" name="hosted_button_id" value="Q5SFX9VDHX3QW">
                      <input class=currencytext type="image" src="https://www.paypalobjects.com/en_GB/i/btn/btn_donate_LG.gif" border="0" name="submit" alt="PayPal � The safer, easier way to pay online!">
                      <img alt="" border="0" src="https://www.paypalobjects.com/sv_SE/i/scr/pixel.gif" width="1" height="1">
                    </form>
                  </td>
                </tr>
                <tr>
                  <td style="vertical-align: top;" colspan=3 onClick="event.stopPropagation();">
                    <form style="margin-block-end: 0px; text-align: center;">
                      <span class=currencytext>BTC&nbsp;</span>
                      <img src="https://abetterrouteplanner.com/icon/bitcoin.png" style="width: 24px; vertical-align: middle" alt="BTC"> <span style="font-size: 6pt; color: white">1Q4PdUxe32V6eTbXm9rgyWmGWnxMrkW2kG</span>
                    </form>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
        </table>
      </div>
    </div>
    <div class="abouthighlight">
      <div class="abouthighlighttext" id=routecountdiv>
        3,300,000 routes planned!
      </div>
    </div>
  </div>
  
  <div class="overlay-dialog overlay-mytesla-center" id=mytesla-div style="display: none;">
    <div class="overlay-close  prevent-double-click" onclick="closeMyTesla();"></div>
    <div class="overlay-mytesla">
      <table id=mytesla-table>
        <form id=mytesla-form>
          <tr><td class=label>MyTesla email</td><td><input type=text class=input name=myteslalogin size=22></td></tr>
          <tr><td class=label>MyTesla password</td><td><input type=password size=22 class=input name=myteslapass></td></tr>
          <tr><td class=label></td><td style="font-style: italic; font-size: 14pt; color: white;">or</td></tr>
          <tr><td class=label>MyTesla access token</td><td><input type=text size=22 class=input name=myteslatoken title="If you are more security conscious and do not wish to submit your MyTesla password, give a valid MyTesla access token here instead."></td></tr>
          <tr><td class=label>Share data<br/><a class=labellink href="https://abetterrouteplanner.com/blog/index.php/2018/08/26/sharing-data-with-abrp/">(What is this?)</a></td><td><input type=checkbox class=settingsinput name=share_data size=10 checked title="Share anonymous car data, like charging rate, with ABRP for improved charging and consumption models."> <span class=checkboxlabel onClick="toggleCheckBox('share_data');">Share driving and charging data with ABRP</span></td></tr>
          <tr><td class=label></td><td><input type=checkbox class=settingsinput name=background_sharing size=10 title="Allow ABRP to get data from your vehicle up to 36 hours after using ABRP in a browser. This gives us a lot more data without you having to have an active browser all time time!"> <span class=checkboxlabel onClick="toggleCheckBox('background_sharing');">36h Background Sharing</span></td></tr>
          <tr><td></td><td><div class=actionbutton type=button id=login-button onClick="myTeslaLogin();" style="float:right;">Log In</div></td></tr>
        </form>
      </table>
      <table id=vehicle-table class="vehicletable">
      </table>
      <div class=error id=mytesla-login-error-div style="display: none;">
      </div>
      <div id="mytesla-spinner" class="spinner" style="display: none;">
        <div class="double-bounce1"></div>
        <div class="double-bounce2"></div>
      </div>
      <table style="width: 100%;"><tr><td>
        <div class="actionbutton prevent-double-click" type=button id=myteslalogout-button onClick="myTeslaLogout();" style="float:right;">Log Out</div>
      </td></tr></table>
      <div class=footnote>
        <br/>
        For security and privacy reasons, your email, password or access token are <i>never</i> stored on the abetterrouteplanner.com server. Due to browser security restrictions,
        the calls have to be routed through abetterrouteplanner.com, but are forwarded immediately to tesla.com. Your password is <i>never</i> stored anywhere - only the access
        token from Tesla is stored in your browser local storage. If you allow data sharing, then selected data about your car, such as charging rate, will be stored on the ABRP server. However, a lot
        of care is taken to make sure that the data is anonymous and cannot reveal anything personal about you (such as position).
      </div>
      <div class="overlay-closebutton prevent-double-click" onClick="closeMyTesla();">
        <img class="closebutton" src="https://abetterrouteplanner.com/icon/close_icon.png"/>
      </div>
    </div>
  </div>
  <div class="overlay-login-center" id=login-div style="display: none;">
    <div class="overlay-close" onclick="closeLogin();"></div>
    <div class="overlay-dialog overlay-login">
      <table id=login-table>
        <form id=login-form>
          <tr><td class=label>Login email</td><td><input type=text class=input name=abrlogin size=22 placeholder="If you already have an account"></td></tr>
          <tr><td class=label>Login password <a class=labellink onClick="forgotPassword();">(Forgot?)</a></td><td><input type=password size=22 class=input name=abrpass></td></tr>
          <tr><td></td><td><div class="actionbutton prevent-double-click" type=button id=login-button onClick="login();" style="float:right;">Log In</div></td></tr>
        </form>
      </table>
      <table id=register-table>
        <form id=register-form>
          <tr><td class=label>Your email</td><td><input type=text class=input name=abrlogin size=22></td></tr>
          <tr><td class=label>Choose a password</td><td><input type=password size=22 class=input name=abrpass></td></tr>
          <tr><td class=label>Repeat password</td><td><input type=password class=input name=abrpass2 size=22></td></tr>
          <tr><td class=label>Full Name</td><td><input type=text size=22 class=input name=abrfullname></td></tr>
          <tr><td></td><td><div class="actionbutton prevent-double-click" type=button id=register-button onClick="register();" style="float:right;">Register Account</div></td></tr>
        </form>
      </table>
      <table id=loggedin-table style="width: 100%;">
        <tr><td class=logintext>Logged in as <span class=label id=loggedin-span></span></td></tr>
        <tr><td>
          <div class="actionbutton prevent-double-click" type=button id=myteslalogout-button onClick="logout();" style="float:right;">Log Out</div>
        </td></tr>
      </table>
      
      <div class=error id=login-error-div style="display: none;">
      </div>
      <div class=footnote>
        <br/>
        This login is used to synchronize your plans and settings between multiple devices, for example your computer and your car. You can use the same account on as many devices as you want. Your MyTesla login information will never be stored or synchronized.
      </div>
      <div class="overlay-closebutton prevent-double-click" onClick="closeLogin();">
        <img class="closebutton prevent-double-click" src="https://abetterrouteplanner.com/icon/close_icon.png"/>
      </div>
    </div>
  </div>
  <div class="overlay-drive-center" id="drive-center-div" style="display: none;">
    <div class="overlay overlay-drive" id="drive-frame">
      <div id="spinner-div-nomap" class="spinner" style="display: none; margin-top: 10px;">
        <div class="double-bounce1"></div>
        <div class="double-bounce2"></div>
      </div>
      <canvas id="drive-canvas" class="drive-canvas" width="790" height="290"></canvas>
      <div id="drive-div" style="display: none;"></div>
      <div class="fullscreen" onClick="toggleMap();">
        <img src="https://abetterrouteplanner.com/icon/fullscreen.png"/>
      </div>
      <div class="replanbutton" id="replandiv" onClick="calibrateAndPlan();" style="display: none;">
        <div class="replantext">
          Replan
        </div>
      </div>
      <div class="drivedisplaybutton" id="drivedisplaydiv" onClick="toggleDriveDisplay();">
        <div class="drivedisplaytext" id="drivedisplaytext">
          Details
        </div>
      </div>
      <div id="drive-spacer" style="height: 20px; display: none;">
      </div>
    </div>
    <div class="overlay-hidebutton-bottom-center">
      <div class="overlay-hidebutton-bottom prevent-double-click" onClick="setShowDriving(false, true);">
        <img class="hidebutton" src="https://abetterrouteplanner.com/icon/down_expand_icon.png"/>
      </div>
    </div>
    <div class="overlay-battery" id="batterydisplayoverlay" style="display: none;">
      <div class="batterybackground">
        <div class="batteryfill" id="batteryfill">
        </div>
      </div>
      <img class="batterydisplayicon" src="https://abetterrouteplanner.com/icon/battery.png"/>
      <div class="batterylabel" id="batterylabel">
        Estimated Battery
      </div>
      <div class="batterytext" id="batterytext">
        65%
      </div>
      <div class="batteryleft" onClick="onBatteryManualChange(-1);"  onDblClick="onBatteryManualChange(-2);">
      </div>
      <div class="batterymid" onClick="onBatteryManualChange(0);">
      </div>
      <div class="batteryright" onClick="onBatteryManualChange(1);" onDblClick="onBatteryManualChange(2);">
      </div>
    </div>  
  </div>
  
  <div class="overlay-expandbutton-bottom-center" id="graphbutton" style="display: none;" >
    <div class="overlay-expandbutton-bottom prevent-double-click" onClick="setShowDriving(true, true);">
      <img class="expandbutton" src="https://abetterrouteplanner.com/icon/up_expand_icon.png"/>
    </div>
  </div>
  
  <div class="overlay-directions-center" id="directions-center-div" style="display: none;">
    <div class="overlay-close prevent-double-click" onclick="hideNav();"></div>
    <div class="overlay-dialog overlay-directions">
      <div id="directions-div">
      </div>
      <canvas id="directions-canvas" class="directions-canvas" width="600" height="400"></canvas>
      <div class="overlay-dirdist" id="dirdist-div"></div>
      <div class="overlay-closebutton prevent-double-click" onClick="hideNav();">
        <img class="closebutton" src="https://abetterrouteplanner.com/icon/close_icon.png"/>
      </div>
    </div>                            
  </div>
  
  <div class="overlay-toast-center" id="toast-center-div" style="display: none;">
    <div class="overlay-dialog overlay-toast" id="toast-div">
    </div>
  </div>
  
  <div class="overlay-notify" id="notify-div" style="display: none;">
    <div class="overlay-close prevent-double-click" onclick="closeNotify();"></div>
    <div class="scroll-notify" id="notify-scroll-div">
      <table id="notify-table">
      </table>
    </div>
    <div class="overlay-closebutton prevent-double-click" onClick="closeNotify()";>
      <img class="closebutton" src="https://abetterrouteplanner.com/icon/close_icon.png"/>
    </div>
  </div>
  
  <div class="overlay-about-center" id=donate-div style="display: none;">
    <div class="overlay-close prevent-double-click" onclick="closeDonate();"></div>
    <div class="overlay-dialog overlay-about" onClick="closeDonate();">
      <div class=aboutlabel>Thank You for Your Donation!</div>
      <div class=abouttext>
        <p>Thank you very much for your generous donation to cover the costs to run ABetterRoutePlanner. It will help you and many others to enjoy EV trip planning!</p>
        
        <p style="text-align:right">Bo (bo@abetterrouteplanner.com)</p>
      </div>
    </div>
  </div>
  
  <div class="overlay-speedlimit" id="speedlimitoverlay" style="display: none;">
    <img id="speedlimitsign_eu" src="https://abetterrouteplanner.com/icon/speedsign.png"/>
    <img id="speedlimitsign_us" src="https://abetterrouteplanner.com/icon/speedsign_us.png"  style="display: none;"/>
    <div id="speedlimitdiv" class="speedlimittext">
      110
    </div>
  </div>
  <div class="overlay-saved-center" id=saved-div style="display: none;">
    <div class="overlay-close prevent-double-click" onclick="closeSaved();"></div>
    <div class="overlay-dialog overlay-saved">
      <div class=savedheading>Select a Saved Plan</div>
      <table id=saved-table width="100%" class="savedtable">
        
      </table>
    </div>
    <div class="overlay-closebutton saved-closebutton prevent-double-click" onClick="closeSaved();">
      <img class="closebutton" src="https://abetterrouteplanner.com/icon/close_icon.png"/>
    </div>
  </div>
  
  <div class="overlay-dialog overlay-eula" id="eula-div" style="display: none;">
    <span class="eulatext">
      We would like to store your settings and an anonymous ID number so that your settings remain until next time you use ABRP. Also, to continuously improve on our car models, we 
      would like to store anonymous driving and charging data. Is that OK with you?
    </span>
    <input class="actionbutton prevent-double-click" style="margin-left: 10px" type=button id=eulaok-button value="OK, I agree." onClick="onEulaOK();" title="Agree to storing my settings using a cookie."/>
    <input class="actionbutton prevent-double-click" style="margin-left: 10px" type=button id=eulaotok-button value="No!" onClick="onEulaNotOK();" title="I do not accept these terms."/>
    
  </div>
  
  <div style="position:absolute; left: 5%; top: 200px; z-index: 50; width: 90%; height: 90%px; display: none;" id=console-div onClick="onConsoleClick();">
  </div>
  
  <div id=fireworks-div onClick="stopFireworks();" style="display: none; position:absolute; left: 0px; top: 0px; z-index: 150; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6);">
    <canvas style="width: 100%; height: 100%" id=fireworks-canvas></canvas>
  </div>
  
  <div id=linksoverlay class="overlay-links-center" style="display: none;">
    <div class="overlay-close prevent-double-click" onclick="closeGetLinks();"></div>
    <div class="overlay-dialog overlay-links">
      <p><div class=notifytitle>
        Plan Links Generated
      </div></p>
      <p><div class=abouttext>
        <p>The following links will allow you to navigate in-car in various ways, or send your plan to a friend.</p>
      </div>
    </p>
    <table id=links-table width="100%" class="linktable">
      <tr id="tesla-nav-btn">
        <td class=labelplanlinks>Tesla Navigation</td>
        <td colspan=3 ><a class=actionbutton style="width:100%; text-align:center; padding:5px;" onClick="sendTeslaNavigation();">Send next to Tesla Navigation</a></td>
      </tr>
      <tr>
        <td class=labelplanlinks>Share to App</td>
        <td colspan=3 ><a class=actionbutton style="width:100%; text-align:center; padding:5px;" id=geo-share-btn href="https://abetterrouteplanner.com/geo://37.7749,-122.4194">Share next Step</a></td>
      </tr>
      <tr>
        <td class=labelplanlinks>ABRP Plan Link</td><td><input readonly type=text class=linksinput id=plan-link></td>
        <td><input class="actionbutton prevent-double-click" style="padding: 5px;" type=button id=plan-copy-btn value="Copy" onClick="onCopyPlanLinkButton('plan-copy');" title="Copy plan URL to clipboard."/></td>
      </tr>
      <tr>
        <td class=labelplanlinks>Google Maps Link</td><td><input readonly type=text class=linksinput id=google-link></td>
        <td><input class="actionbutton prevent-double-click" style="padding: 5px;" type=button id=google-maps-copy-btn value="Copy" onClick="onCopyPlanLinkButton('google-copy');" title="Copy Google Maps Directions URL to clipboard."/></td>
        <td><input class="actionbutton prevent-double-click" style="padding: 5px;" type=button id=google-maps-open-btn value="Open" onClick="onCopyPlanLinkButton('google-open');" title="Open Google Maps Directions in a new tab / window."/></td>
        <!-- <td><input class=actionbutton type=button id=google-maps-PB-btn value="PushBullet" onClick="onCopyPlanLinkButton('google-PB');" title="Send Google Maps Directions to PushBullet."/></td> -->
      </tr>
      <tr>
        <td class=labelplanlinks>Waze Link</td><td><input readonly type=text class=linksinput id=waze-link></td>
        <td><input class="actionbutton prevent-double-click" style="padding: 5px;" type=button id=waze-copy-btn value="Copy" onClick="onCopyPlanLinkButton('waze-copy');" title="Copy Waze Directions URL to clipboard."/></td>
        <td><input class="actionbutton prevent-double-click" style="padding: 5px;" type=button id=waze-open-btn value="Open" onClick="onCopyPlanLinkButton('waze-open');" title="Open Waze Directions in a new tab / window."/></td>
        <!-- <td><input class=actionbutton type=button id=waze-PB-btn value="PushBullet" onClick="onCopyPlanLinkButton('waze-PB');" title="Send Waze Directions to PushBullet."/></td> -->
      </tr>
      <tr>
        <td class=labelplanlinks>Apple Maps Link</td><td><input readonly type=text class=linksinput id=apple-link></td>
        <td><input class="actionbutton prevent-double-click" style="padding: 5px;" type=button id=apple-maps-copy-btn value="Copy" onClick="onCopyPlanLinkButton('google-copy');" title="Copy Apple Maps Directions URL to clipboard."/></td>
        <td><input class="actionbutton prevent-double-click" style="padding: 5px;" type=button id=apple-maps-open-btn value="Open" onClick="onCopyPlanLinkButton('apple-open');" title="Open Apple Maps Directions in a new tab / window."/></td>
        <!-- <td><input class=actionbutton type=button id=google-maps-PB-btn value="PushBullet" onClick="onCopyPlanLinkButton('google-PB');" title="Send Google Maps Directions to PushBullet."/></td> -->
      </tr>
    </table>
    <div class="overlay-closebutton prevent-double-click" onClick="closeGetLinks();">
      <img class="closebutton" src="https://abetterrouteplanner.com/icon/close_icon.png"/>
    </div>
  </div>
</div>

<div class="overlay-waypointoptions-center" id=waypointoptions-div style="display: none;">
  <div class="overlay-close prevent-double-click" onclick="closeWaypointOptions();"></div>
  <div class="overlay-dialog overlay-waypointoptions">
    <form id=waypointoptions-form>
      <table id=waypointoptions-table class="plugtable">
        <tr class=waypointoptionsheading><td colspan="2">Waypoint Options</td></tr>
        <tr id="departtime_row" style="margin-bottom: 10px;"><td class=label>Depart at</td><td class=waypointoptionstext><input type=text pattern="[0-9]{1,}:[0-9]{2}" class=waypointoptionsinput name=departtime placeholder="hh:mm"></td></tr>
        <tr id="arrivesoc_row"><td class=label>Arrive at</td><td class=waypointoptionstext><input pattern="[0-9]*%{0,1}" type=number step="1" class=waypointoptionsinput name=arrivesoc placeholder="SoC %"> %</td></tr>
        <tr id="chargeoptions_row" class=waypointoptionsheading><td colspan="2">Charging Options</td></tr>
        <tr id="chargepower_row" style="margin-bottom: 10px;"><td class=label>Power</td><td class=waypointoptionstext><input class=waypointoptionsinput type=number step="0.1" name=chargepower placeholder="[kW]" onkeyup="highlight2Of3()"> kW</td></tr>
        <tr id="chargetime_row"><td class=label>Time</td><td class=waypointoptionstext><input class=waypointoptionsinput type=text pattern="[0-9]{1,}:[0-9]{2}" name=chargetime placeholder="hh:mm" onkeyup="highlight2Of3()"></td></tr>
        <tr id="chargeto_row"><td class=label>Charge to</td><td class=waypointoptionstext><input class=waypointoptionsinput type=number step="1" pattern=[0-9]*%{0,1} name=chargeto placeholder="SoC %" onkeyup="highlight2Of3()"> %</td></tr>
      </table>
    </form>
    <div class="overlay-closebutton  prevent-double-click" onClick="closeWaypointOptions();">
      <img class="closebutton" src="https://abetterrouteplanner.com/icon/close_icon.png"/>
    </div>
  </div>
</div>

<script>
  function highlight2Of3() {
    var form = document.getElementById("waypointoptions-form");
    var inputs = {
      "chargepower":  form.elements["chargepower"],
      "chargetime":   form.elements["chargetime"],
      "chargeto":     form.elements["chargeto"],
    };
    var count = 0;
    for (i in inputs) {
      if (form.elements[i].value) {
        count++;
      }
    }

    if (count == 1 || (!form.elements["chargepower"].value && count > 0)) {
      // Highlight the missing ones, 
      for (i in inputs) {
        if (form.elements[i].value) {
          inputs[i].style.border = "";
        } else {
          inputs[i].style.border = "2px dashed red";
        }
      }
    } else {
      for (i in inputs) {
        inputs[i].style.border = "";
      }
    }
  }
</script>
<div class="overlay-tlm-center" id=telemetry-div style="display: none;">
  <div class="overlay-close" onclick="closeOverlay('telemetry-div');"></div>
  <div class="overlay-tlm">
    <div id="tlm_message" style="background-color: red;"></div>
    <table id=telemetry-table class="telemetrytable">
      <tbody>
        <tr>
          <td class="tlmfield"><div>
            <span class="tlmtitle">SoC</span><br>
            <span class="tlm" id="soc_tlm">--</span><span class="tlmunit">%</span>
          </div></td>
          <td class="tlmfield"><div>
            <span class="tlmtitle">Speed</span><br>
            <span class="tlm" id="speed_tlm">--</span> <span class="tlmunit" id="speed_units">km/h</span>
          </div></td>
          <td class="tlmfield"><div>
            <span class="tlmtitle">Ext. Temp</span><br>
            <span class="tlm" id="temperature_tlm">--</span><span class="tlmunit" id="ext_temp_units">°C</span>
          </div></td>
        </tr>
        <tr></tr>
          <td class="tlmfield"><div>
            <span class="tlmtitle">Batt. Temp</span><br>
            <span class="tlm" id="batt_temp_tlm">--</span> <span class="tlmunit" id="batt_temp_units">°C</span>
          </div></td>
          <td class="tlmfield"><div>
            <span class="tlmtitle">SoH</span><br>
            <span class="tlm" id="soh_tlm">--</span> <span class="tlmunit">%</span>
          </div></td>
          <td class="tlmfield"><div>
            <span class="tlmtitle">Charging</span><br>
            <span class="tlm" id="is_charging_tlm" style="font-weight:bold; font-size:12pt">--</span>
          </div></td>
        </tr><tr>
          <td class="tlmfield"><div>
            <span class="tlmtitle">Power</span><br>
            <span class="tlm" id="power_tlm">--</span> <span class="tlmunit">kW</span>
          </div></td>
          <td class="tlmfield"><div>
            <span class="tlmtitle">Age</span><br>
            <span class="tlm" id="tlm_age">--</span> <span class="tlmunit">s</span>
          </div></td>
          <td class="tlmfield"><div>
            <span class="tlmtitle">Model</span><br>
            <span class="tlm" id="model_tlm" style="font-weight:bold; font-size:12pt">--</span>
          </div></td>
        </tr>
        <tr>
          <td colspan="100">
            <input class=actionbutton style="float:right; margin:5;" type=button id=tlm-refresh value="Refresh" onClick="refreshTlm()" title="Update telemetry from server if timeout is set too long."/>
        </td></tr>
      </tbody>
    </table>
    <div class="overlay-closebutton" onClick="closeOverlay('telemetry-div');">
      <img class="closebutton" src="https://abetterrouteplanner.com/icon/close_icon.png"/>
    </div>
  </div>
</div>
<div class="overlay-tlm-center" id=obd-setup-div style="display: none;">
  <div class="overlay-close" onclick="closeOverlay('obd-setup-div'); showOverlay('telemetry-div')"></div>
  <div class="overlay-tlm overlay-obd-setup">
    <div class="telemetrytable" style="width:auto;">
      <div id=obd-instructions-div class="obd-instructions"></div>
      <div style="height: 45px;  margin-top: 10px;">
        <input class=actionbutton style="float:left; margin:5;" type=button id=obd-instr-prev value="Prev" onClick="obd_instr.setOBDSetupPage('prev');"/>
        <input class=actionbutton style="float:right; margin:5;" type=button id=obd-instr-next value="Next" onClick="obd_instr.setOBDSetupPage('next');"/>
      </div>
      <div class="overlay-closebutton" onClick="closeOverlay('obd-setup-div'); showOverlay('telemetry-div')">
        <img class="closebutton" src="https://abetterrouteplanner.com/icon/close_icon.png"/>
      </div>
    </div>
  </div>

</div>
<script>
  function closeOverlay(overlay) {
    document.getElementById(overlay).style.display = "none";
  }
  function showOverlay(overlay) {
    document.getElementById(overlay).style.display = "";
  }
</script>
<div id=plugsoverlay class="overlay-plugs-center overlay-plugbutton" style="display: none;">
  <div class="overlay-close prevent-double-click" onclick="togglePlugOverlay();"></div>
  <div class="overlay-dialog overlay-plugs">
    <p><div class=notifytitle>
      Slow Charger Filters
    </div></p>
    <table id=plugs-table width="100%" class="plugtable">
      <tr class="plugheadings">
          <td colspan="100%">Zoom Threshold</td>
      </tr><tr class="pluglabels">
        <td colspan="100%" style="width:95%" class="slowchargerslider_bg">
          <span id="charger-zoom-label">City</span>
          <input type="range" min="1" max="100" value="55" class="slowchargerslider" id="charger-zoom-slider">
        </td>
      </tr>
      <script>
        var charger_zoom_slider = document.getElementById("charger-zoom-slider");
        var charger_zoom_label = document.getElementById("charger-zoom-label");
        charger_zoom_slider.oninput = function() {
          var zoom = Math.round(22*charger_zoom_slider.value/100);
          chrg.destchrg_zoom = zoom;
          var text = "Street";
          if (zoom < 5) {
            text = "World";
          } else if (zoom < 10) {
            text = "Country";
          } else if (zoom < 15) {
            text = "City";
          }
          charger_zoom_label.innerHTML = text;
          chrg.refreshChargers(getFastChargerTypes(),bigmap,true)
        }
      </script>
      <tr class="plugheadings">
        <td colspan="100%">Region</td>
      </tr><tr class="pluglabels"><td colspan="100%">
        <input class=settingsdropdown style="width:100%" name=plugregion id=plugregion readonly onClick="popupOpen(this,onPlugRegionPicked)" title="Select your slow charger plug region."></input>
        <script>
          function onPlugRegionPicked() {
            var region = document.getElementById("plugregion").dataset.value;
            setPlugRegion(region);
          }
        </script>
        <!-- <div class=regionbutton id=na-plug-div style="float:left;background-color:rgb(85, 135, 135);"><input class="actionbutton" type="radio" value="na" name="region" id="na-region-button" checked="checked" onclick="setPlugRegion('na')"><a onclick="setPlugRegion('na')">North America</a></div>
        <div class=regionbutton id=eu-plug-div style="float:right;"><input class="actionbutton" type="radio" name="region" value="eu" id="eu-region-button" onclick="setPlugRegion('eu')"><a onclick="setPlugRegion('eu')">Europe</a></div> -->
      </td></tr><tr class="plugheadings">
          <td colspan="100%">EV Plugs</td>
        </tr><tr class="pluglabels">
          <td class="plugbutton prevent-double-click" id="j1772_td" onclick="onPlugToggle('j1772');">
            <div class="plugdiv">
              <div id="j1772_check" class="plugcheck"><img src="https://abetterrouteplanner.com/icon/check.png"></div>
              <div>
                <img src="https://abetterrouteplanner.com/icon/overlay_icons/level_2/j1772_white.png"/>
              </div>
              <div>J-1772</div>
              <div>1.4-19.2kW</div>
            </div>
          </td><td class="plugbutton prevent-double-click" id="type2_td" onclick="onPlugToggle('type2');" >
            <div class="plugdiv">
              <div id="type2_check" class="plugcheck"><img src="https://abetterrouteplanner.com/icon/check.png"></div>
              <div>
                <img src="https://abetterrouteplanner.com/icon/overlay_icons/level_2/type2_white.png"/>
              </div>
              <div>Type 2</div>
              <div>3-50kW</div>
            </div>
          </td><td class="plugbutton " id="type2tesla_td" onclick="onPlugToggle('type2tesla');" >
            <div class="plugdiv">
              <div id="type2tesla_check" class="plugcheck"><img src="https://abetterrouteplanner.com/icon/check.png"></div>
              <div>
                <img src="https://abetterrouteplanner.com/icon/overlay_icons/level_2/type2_white.png"/>
              </div>
              <div>Tesla</div>
              <div>11-22kW</div>
            </div>
          </td><td class="plugbutton prevent-double-click" id="tesla_td" onclick="onPlugToggle('tesla');">
            <div class="plugdiv">
              <div id="tesla_check" class="plugcheck"><img src="https://abetterrouteplanner.com/icon/check.png"></div>
              <div>
                <img src="https://abetterrouteplanner.com/icon/overlay_icons/level_2/tesla_white.png"/>
              </div>
              <div>Tesla</div>
              <div>1.4-19.2kW</div>
            </div>
          </td>
        </tr><tr class="plugheadings">
          <td colspan="100%">Wall Plugs</td>
        </tr><tr class="pluglabels">
          <td class="plugbutton prevent-double-click" id="nema1450_td" onclick="onPlugToggle('nema1450');">
            <div class="plugdiv">
              <div id="nema1450_check" class="plugcheck"><img src="https://abetterrouteplanner.com/icon/check.png"></div>
              <div>
                <img src="https://abetterrouteplanner.com/icon/overlay_icons/level_2/nema14-50_white.png"/>
              </div>
              <div>NEMA 14-50</div>
              <div>9.6kW</div>
            </div>
          </td><td class="plugbutton prevent-double-click" id="nemaTT30_td" onclick="onPlugToggle('nemaTT30');">
            <div class="plugdiv">
              <div id="nemaTT30_check" class="plugcheck"><img src="https://abetterrouteplanner.com/icon/check.png"></div>
              <div>
                <img src="https://abetterrouteplanner.com/icon/overlay_icons/level_2/nemaTT-30_white.png"/>
              </div>
              <div>NEMA TT-30</div>
              <div>2.9kW</div>
            </div>
          </td><td class="plugbutton prevent-double-click" id="nema520_td" onclick="onPlugToggle('nema520');">
            <div class="plugdiv">
              <div id="nema520_check" class="plugcheck"><img src="https://abetterrouteplanner.com/icon/check.png"></div>
              <div>
                <img src="https://abetterrouteplanner.com/icon/overlay_icons/level_2/nema5-20_white.png"/>
              </div>
              <div>NEMA 5-20</div>
              <div>1.9kW</div>
            </div>
          </td><td class="plugbutton prevent-double-click" id="nema515_td" onclick="onPlugToggle('nema515');">
            <div class="plugdiv">
              <div id="nema515_check" class="plugcheck"><img src="https://abetterrouteplanner.com/icon/check.png"></div>
              <div>
                <img src="https://abetterrouteplanner.com/icon/overlay_icons/level_2/nema5-15_white.png"/>
              </div>
              <div>NEMA 5-15</div>
              <div>1.4kW</div>
            </div>
          </td>
        </tr><tr class="pluglabels">
          <td class="plugbutton prevent-double-click" id="cee_red_td" onclick="onPlugToggle('cee_red');">
            <div class="plugdiv">
              <div id="cee_red_check" class="plugcheck"><img src="https://abetterrouteplanner.com/icon/check.png"></div>
              <div>
                <img src="https://abetterrouteplanner.com/icon/overlay_icons/level_2/cee_red_white.png"/>
              </div>
              <div>CEE Red</div>
              <div>11kW</div>
            </div>
          </td><td class="plugbutton prevent-double-click" id="cee_blue_td" onclick="onPlugToggle('cee_blue');">
            <div class="plugdiv">
              <div id="cee_blue_check" class="plugcheck"><img src="https://abetterrouteplanner.com/icon/check.png"></div>
              <div>
                <img src="https://abetterrouteplanner.com/icon/overlay_icons/level_2/cee_blue_white.png"/>
              </div>
              <div>CEE Blue</div>
              <div>2-4 kW</div>
            </div>
          </td><td class="plugbutton prevent-double-click" id="schuko_td" onclick="onPlugToggle('schuko');">
            <div class="plugdiv">
              <div id="schuko_check" class="plugcheck"><img src="https://abetterrouteplanner.com/icon/check.png"></div>
              <div>
                <img src="https://abetterrouteplanner.com/icon/overlay_icons/level_2/schuko_white.png"/>
              </div>
              <div>Schuko</div>
              <div>1-3kW</div>
            </div>
          </td>
        </tr>
      </table>
      <div class="overlay-closebutton  prevent-double-click" onclick="togglePlugOverlay();">
        <img class="closebutton" src="https://abetterrouteplanner.com/icon/close_icon.png"/>
      </div>
    </div>
  </div>

  <div class="overlay-input-center" id=input-center-div style="display: none;"  onkeyup="onInputKeyUp(event);">
    <div class="overlay-close  prevent-double-click" onclick="onCloseInputDialog();"></div>
    <div class="overlay-dialog overlay-input">
      <div class="inputheading" id="input-heading-div">Input Heading</div>
      <table class="inputtable">
        <form>
          <tr><td>
            <input class="inputdropdown prevent-double-click" style="width:100%; display: none" name=carmodel id=input-carmodelpopup readonly onClick="popupOpen(this,onInputModelChange);" title="Select your car model. Models marked as (beta) are initial models but validated by owners, (alpha) means very initial models."></input>
            <div class=inputtext style="width:100%; display: none" id=input-messagetext></div>
            <div style="width:100%; display: none" id=input-chargeralts>
              <table class="inputtable">
                <tr>
                  <td>
                    <img class="inputarrow prevent-double-click" id="inputcharger-left" src="https://abetterrouteplanner.com/icon/left_expand_icon.png" onclick="onInputChargerPrev();">
                  </td>
                  <td id=input-charger>
                  </td>
                  <td>
                      <img class="inputarrow prevent-double-click" id="inputcharger-right" src="https://abetterrouteplanner.com/icon/right_expand_icon.png" onclick="onInputChargerNext();">
                  </td>
                </tr>
              </table>
            </div>
          </td></tr>
          <tr><td>
            <input class="actionbutton prevent-double-click" tabindex="1" type="button" style="width: 100%; margin-top: 10px; text-align: center" name=okbutton id=input-okbutton value="OK" onClick="onInputOK();"/>
            <input class="actionbutton prevent-double-click" tabindex="1" type="button" style="width: 100%; margin-top: 10px; margin-left: 5px; text-align: center; display: none;" name=okbutton id=input-cancelbutton value="Cancel" onClick="onInputCancel();"/>
          </td></tr>
        </form>
      </table>
      <div class="overlay-closebutton overlay-input-close prevent-double-click" style="display:none;" onClick="onCloseInputDialog();">
        <img class="closebutton" src="https://abetterrouteplanner.com/icon/close_icon.png"/>
      </div>
    </div>
  </div>

  
</body>
</html>
